<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="61601e1d-7646-4e46-97cb-72e9f022e9b2" author="MineStar" context="Health/Health_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SYSTEM_POLLING as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SYSTEM_POLLING"/>
            </not>
        </preConditions>
        <comment>HLT-521: CreateTable SYSTEM_POLLING</comment>
        <createTable tableName="SYSTEM_POLLING">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="MACHINE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="SYSTEM_POLLING_PK" tableName="SYSTEM_POLLING"/>
        <addUniqueConstraint columnNames="MACHINE_OID,TYPE" constraintName="CONFIG_UNIQUE" tableName="SYSTEM_POLLING"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="e24a3d06-a0e0-4403-b8ab-0f34cb12e7f1" author="MineStar" context="Health/Health_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SYSTEM_POLLING_MEASURES as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SYSTEM_POLLING_MEASURES"/>
            </not>
        </preConditions>
        <comment>HLT-521: CreateTable SYSTEM_POLLING_MEASURES</comment>
        <createTable tableName="SYSTEM_POLLING_MEASURES">
            <column name="CONFIG_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="MEASURE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="CONFIG_OID,MEASURE_OID" constraintName="SYSTEM_POLLING_MEASURES_PK" tableName="SYSTEM_POLLING_MEASURES"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="8849362d-c0a1-4cf7-ba1d-89040fb0f75f" author="MineStar" context="Health/Health_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SYSTEM_POLLING_MACHINE_OID_FK to table SYSTEM_POLLING as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SYSTEM_POLLING"/>
            <tableExists tableName="MACHINE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SYSTEM_POLLING" foreignKeyName="SYSTEM_POLLING_MACHINE_OID_FK"/>
            </not>
        </preConditions>
        <comment>HLT-521: AddForeignKeyConstraint SYSTEM_POLLING_MACHINE_OID_FK to SYSTEM_POLLING (MACHINE_OID)</comment>
        <sql>DELETE FROM SYSTEM_POLLING WHERE MACHINE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = SYSTEM_POLLING.MACHINE_OID)</sql>
        <addForeignKeyConstraint baseTableName="SYSTEM_POLLING" baseColumnNames="MACHINE_OID" constraintName="SYSTEM_POLLING_MACHINE_OID_FK" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SYSTEM_POLLING" constraintName="SYSTEM_POLLING_MACHINE_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="4863e3e6-f548-43ad-b7a5-c0c59db6b296" author="MineStar" context="Health/Health_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SYSTEM_POLLING_MEASURES_FK1 to table SYSTEM_POLLING_MEASURES as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SYSTEM_POLLING_MEASURES"/>
            <tableExists tableName="MEASURE_DEF"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SYSTEM_POLLING_MEASURES" foreignKeyName="SYSTEM_POLLING_MEASURES_FK1"/>
            </not>
        </preConditions>
        <comment>HLT-521: AddForeignKeyConstraint SYSTEM_POLLING_MEASURES_FK1 to SYSTEM_POLLING_MEASURES (MEASURE_OID)</comment>
        <sql>DELETE FROM SYSTEM_POLLING_MEASURES WHERE MEASURE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MEASURE_DEF WHERE MEASURE_DEF.OID = SYSTEM_POLLING_MEASURES.MEASURE_OID)</sql>
        <addForeignKeyConstraint baseTableName="SYSTEM_POLLING_MEASURES" baseColumnNames="MEASURE_OID" constraintName="SYSTEM_POLLING_MEASURES_FK1" referencedTableName="MEASURE_DEF" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SYSTEM_POLLING_MEASURES" constraintName="SYSTEM_POLLING_MEASURES_FK1"/>
        </rollback>
    </changeSet>
    <changeSet id="9cbc8321-4ce0-4113-9173-2d48978d4adf" author="MineStar" context="Health/Health_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SYSTEM_POLLING_MEASURES_FK2 to table SYSTEM_POLLING_MEASURES as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SYSTEM_POLLING_MEASURES"/>
            <tableExists tableName="SYSTEM_POLLING"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SYSTEM_POLLING_MEASURES" foreignKeyName="SYSTEM_POLLING_MEASURES_FK2"/>
            </not>
        </preConditions>
        <comment>HLT-521: AddForeignKeyConstraint SYSTEM_POLLING_MEASURES_FK2 to SYSTEM_POLLING_MEASURES (CONFIG_OID)</comment>
        <sql>DELETE FROM SYSTEM_POLLING_MEASURES WHERE CONFIG_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM SYSTEM_POLLING WHERE SYSTEM_POLLING.OID = SYSTEM_POLLING_MEASURES.CONFIG_OID)</sql>
        <addForeignKeyConstraint baseTableName="SYSTEM_POLLING_MEASURES" baseColumnNames="CONFIG_OID" constraintName="SYSTEM_POLLING_MEASURES_FK2" referencedTableName="SYSTEM_POLLING" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SYSTEM_POLLING_MEASURES" constraintName="SYSTEM_POLLING_MEASURES_FK2"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
