<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd ">

    <changeSet id="6cc0213b-e427-4c39-a563-3855da3dcad0" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for METADATA as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="METADATA"/>
            </not>
        </preConditions>
        <comment>MO-10900: CreateTable METADATA</comment>
        <createTable tablespace="MW_ENT" remarks="A Metadata entity" tableName="METADATA">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SCHEMA_NAME" type="VARCHAR(255)" remarks="The name of the schema used for defining this data.">
                <constraints nullable="false"/>
            </column>
            <column name="SCHEMA_OID" type="BIGINT" remarks="The OID of the schema used for defining this data."/>
            <column name="DATA" type="VARCHAR(4000)" remarks="The configured data set/s which conform to the schema specified.">
                <constraints nullable="false"/>
            </column>
            <column name="GOAL_OID" type="BIGINT" remarks="The goal OID which this metadata may relate to.">
                <constraints nullable="true"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this metadata is active or archived. (This flag is '1' if it is active and '0' if archived.)"/>
            <column name="MODEL_UPDATE_VERSION" type="BIGINT" remarks="The is a copy of the system wide version number."/>
            <column name="LAST_MODIFIED_DATE_UTC" type="DATETIME2" remarks="The timestamp of when this metadata was last modified by a user."/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="METADATA_PK" tablespace="MW_IDXENT" tableName="METADATA"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="a29bfca5-1abb-43da-a031-70af552096f1" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for METADATA_SCHEMA as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="METADATA_SCHEMA"/>
            </not>
        </preConditions>
        <comment>MO-10900: CreateTable METADATA_SCHEMA</comment>
        <createTable tablespace="MW_ENT" remarks="A Metadata Schema entity" tableName="METADATA_SCHEMA">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SCHEMA_NAME" type="VARCHAR(254)" remarks="The unique, user-entered identifier for this schema.">
                <constraints nullable="false"/>
            </column>
            <column name="SCHEMA_DATA" type="VARCHAR(4000)" remarks="The JSON schema used to define data.">
                <constraints nullable="false"/>
            </column>
            <column name="IS_TEMPLATE" type="BOOLEAN" remarks="Whether this schema is denoted as a template to be used for other schemas (This flag is '1' if it is a template and '0' if not.)"/>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this schema is active or archived. (This flag is '1' if it is active and '0' if archived.)"/>
            <column name="MODEL_UPDATE_VERSION" type="BIGINT" remarks="The is a copy of the system wide version number."/>
            <column name="LAST_MODIFIED_DATE_UTC" type="DATETIME2" remarks="The timestamp of when this schema was last modified by a user."/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="METADATA_SCHEMA_PK" tablespace="MW_IDXENT" tableName="METADATA_SCHEMA"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="3cd7e8af-2fbe-4cb9-b479-d859c8d68113" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for METADATA_SCHEMA_OID_FK to table METADATA as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="METADATA" columnName="SCHEMA_OID"/>
            <columnExists tableName="METADATA_SCHEMA" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="METADATA" foreignKeyName="METADATA_SCHEMA_OID_FK"/>
            </not>
        </preConditions>
        <comment>MO-10900: AddForeignKeyConstraint METADATA_SCHEMA_OID_FK to METADATA (SCHEMA_OID)</comment>
        <sql>UPDATE METADATA SET SCHEMA_OID = NULL WHERE SCHEMA_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM METADATA_SCHEMA WHERE METADATA_SCHEMA.OID = METADATA.SCHEMA_OID)</sql>
        <addForeignKeyConstraint baseTableName="METADATA" baseColumnNames="SCHEMA_OID" constraintName="METADATA_SCHEMA_OID_FK" referencedTableName="METADATA_SCHEMA" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="METADATA" constraintName="METADATA_SCHEMA_OID_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
