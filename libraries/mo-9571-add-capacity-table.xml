<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="ca1fffb8-b817-45ad-992f-a66759477759" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for BAY of table MACHINE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="BAY"/>
        </preConditions>
        <comment>MO-9571: DropColumn MACHINE.BAY</comment>
        <dropColumn columnName="BAY" tableName="MACHINE"/>
        <rollback>
            <addColumn tableName="MACHINE">
                <column name="BAY" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="147f3e65-45a0-4fcc-91dc-81fc80a1144e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for BAYID of table MACHINE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="BAYID"/>
        </preConditions>
        <comment>MO-9571: DropColumn MACHINE.BAYID</comment>
        <dropColumn columnName="BAYID" tableName="MACHINE"/>
        <rollback>
            <addColumn tableName="MACHINE">
                <column name="BAYID" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="86ee61d5-8d3f-4161-beed-62b762c38acb" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for MAXIMUMMASS of table MACHINE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="MAXIMUMMASS"/>
        </preConditions>
        <comment>MO-9571: DropColumn MACHINE.MAXIMUMMASS</comment>
        <dropColumn columnName="MAXIMUMMASS" tableName="MACHINE"/>
        <rollback>
            <addColumn tableName="MACHINE">
                <column name="MAXIMUMMASS" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="0463575e-46b4-4c12-a342-a53d80de2b20" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for CRITICALLEVEL of table MACHINE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="CRITICALLEVEL"/>
        </preConditions>
        <comment>MO-9571: DropColumn MACHINE.CRITICALLEVEL</comment>
        <dropColumn columnName="CRITICALLEVEL" tableName="MACHINE"/>
        <rollback>
            <addColumn tableName="MACHINE">
                <column name="CRITICALLEVEL" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="d8305d05-de8c-4599-a6e6-4cfdfc689778" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for WARNINGLEVEL of table MACHINE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="WARNINGLEVEL"/>
        </preConditions>
        <comment>MO-9571: DropColumn MACHINE.WARNINGLEVEL</comment>
        <dropColumn columnName="WARNINGLEVEL" tableName="MACHINE"/>
        <rollback>
            <addColumn tableName="MACHINE">
                <column name="WARNINGLEVEL" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="f5c892f6-3800-4263-9a62-a1a7ce1b3745" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for INPUT_MASS_FLOW_RATE to table MACHINE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MACHINE"/>
            <not>
                <columnExists tableName="MACHINE" columnName="INPUT_MASS_FLOW_RATE"/>
            </not>
        </preConditions>
        <comment>MO-9571: AddColumn MACHINE.INPUT_MASS_FLOW_RATE</comment>
        <addColumn tableName="MACHINE">
            <column name="INPUT_MASS_FLOW_RATE" type="BIGINT"/>
        </addColumn>
    </changeSet>
    <changeSet id="4d22d35a-15f3-415d-b796-e68bce1397e7" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for ALU_CAPACITY_PROPERTIES as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="ALU_CAPACITY_PROPERTIES"/>
            </not>
        </preConditions>
        <comment>MO-9571: CreateTable ALU_CAPACITY_PROPERTIES</comment>
        <createTable tablespace="MW_ENT" remarks="A grouping of capacity properties." tableName="ALU_CAPACITY_PROPERTIES">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="MACHINE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="BAY" type="INT" remarks="Number of the Bay"/>
            <column name="BAYID" type="VARCHAR(254)" remarks="Id of the Bay"/>
            <column name="MAXIMUMMASS" type="INT" remarks="Maximum mass of the Bay"/>
            <column name="CRITICALLEVEL" type="INT" remarks="Critical Level Percentage of the Bay"/>
            <column name="WARNINGLEVEL" type="INT" remarks="Warning Level Percentage of the Bay"/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="ALU_CAPACITY_PROPERTIES_PK" tablespace="MW_IDXENT" tableName="ALU_CAPACITY_PROPERTIES"/>
        <createIndex unique="false" tablespace="MW_IDXENT" tableName="ALU_CAPACITY_PROPERTIES" indexName="ALU_CAPACITY_UNQ">
            <column name="MACHINE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="aa4751f4-07c8-4b11-9d41-4fef05bedc7a" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for ALU_CAPACITY_PROPERTIES_FK1 to table ALU_CAPACITY_PROPERTIES as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="ALU_CAPACITY_PROPERTIES" columnName="MACHINE_OID"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="ALU_CAPACITY_PROPERTIES" foreignKeyName="ALU_CAPACITY_PROPERTIES_FK1"/>
            </not>
        </preConditions>
        <comment>MO-9571: AddForeignKeyConstraint ALU_CAPACITY_PROPERTIES_FK1 to ALU_CAPACITY_PROPERTIES (MACHINE_OID)</comment>
        <sql>DELETE FROM ALU_CAPACITY_PROPERTIES WHERE MACHINE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = ALU_CAPACITY_PROPERTIES.MACHINE_OID)</sql>
        <addForeignKeyConstraint baseTableName="ALU_CAPACITY_PROPERTIES" baseColumnNames="MACHINE_OID" constraintName="ALU_CAPACITY_PROPERTIES_FK1" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="ALU_CAPACITY_PROPERTIES" constraintName="ALU_CAPACITY_PROPERTIES_FK1"/>
        </rollback>
    </changeSet>
    <changeSet id="5cf71964-593e-41d3-8405-aa8c3c1e25fa" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropNotNullConstraint for ALU_CAPACITY_PROPERTIES.MACHINE_OID as column does not exist or is already nullable" onFail="MARK_RAN">
            <ext:columnIsNotNullable tableName="ALU_CAPACITY_PROPERTIES" columnName="MACHINE_OID"/>
        </preConditions>
        <comment>MO-9571: DropNotNullConstraint from ALU_CAPACITY_PROPERTIES.MACHINE_OID</comment>
        <dropNotNullConstraint tableName="ALU_CAPACITY_PROPERTIES" columnName="MACHINE_OID" columnDataType="BIGINT"/>
    </changeSet>
    <changeSet id="8ec755b8-49e2-41ca-8bdf-e01f528f837d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for IS_ACTIVE to table ALU_CAPACITY_PROPERTIES as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="ALU_CAPACITY_PROPERTIES"/>
            <not>
                <columnExists tableName="ALU_CAPACITY_PROPERTIES" columnName="IS_ACTIVE"/>
            </not>
        </preConditions>
        <comment>MO-9751 : AddColumn ALU_CAPACITY_PROPERTIES.IS_ACTIVE</comment>
        <addColumn tableName="ALU_CAPACITY_PROPERTIES">
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Is this Cable Bridge active">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="e56552fc-3898-43d4-8bef-cc40f46db174" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored ChangeDataType for ALU_CAPACITY_PROPERTIES.BAYID as column does not exist" onFail="MARK_RAN">
            <columnExists tableName="ALU_CAPACITY_PROPERTIES" columnName="BAYID"/>
        </preConditions>
        <comment>MO-9751 : ChangeDataType of ALU_CAPACITY_PROPERTIES.BAYID from NVARCHAR(254) to INT</comment>
        <modifyDataType columnName="BAYID" newDataType="INT" tableName="ALU_CAPACITY_PROPERTIES"/>
        <rollback>
            <modifyDataType columnName="BAYID" newDataType="NVARCHAR(254)" tableName="ALU_CAPACITY_PROPERTIES"/>
        </rollback>
    </changeSet>
    <changeSet id="5d083647-d900-43f3-94b6-a287cb9a5922" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored ChangeDataType for MACHINE.INPUT_MASS_FLOW_RATE as column does not exist" onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="INPUT_MASS_FLOW_RATE"/>
        </preConditions>
        <comment>MO-9751: ChangeDataType of MACHINE.INPUT_MASS_FLOW_RATE from BIGINT to DOUBLE</comment>
        <modifyDataType columnName="INPUT_MASS_FLOW_RATE" newDataType="DOUBLE" tableName="MACHINE"/>
        <rollback>
            <modifyDataType columnName="INPUT_MASS_FLOW_RATE" newDataType="BIGINT" tableName="MACHINE"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
