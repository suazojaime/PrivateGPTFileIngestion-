<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <!-- PROD_PLAN changes -->

    <changeSet id="498cbf05-daca-43c0-a1f2-d24076bbf134" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored update PROD_PLAN STATUS." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN" columnName="STATUS"/>
        </preConditions>
        <comment>MO-6498: Update PROD_PLAN STATUS</comment>
        <sql>UPDATE PROD_PLAN SET STATUS = 'DELETED' WHERE STATUS = 'DEPRECATED'</sql>
        <rollback/>
    </changeSet>

    <!-- PROD_PLAN_JOB_ALTERNATE_DUMP changes -->

    <changeSet id="498cbf05-daca-43c0-a1f2-d24076bbf133" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_JOB_ALTERNATE_DUM_PK of table PROD_PLAN_JOB_ALTERNATE_DUMP as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_JOB_ALTERNATE_DUM_PK from PROD_PLAN_JOB_ALTERNATE_DUMP (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="37ca7a75-b6b4-465a-8106-ac2b7cde4400" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_ALTERNATE_DU_FK1 of table PROD_PLAN_JOB_ALTERNATE_DUMP as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" foreignKeyName="PROD_PLAN_JOB_ALTERNATE_DU_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_ALTERNATE_DU_FK1 from PROD_PLAN_JOB_ALTERNATE_DUMP (JOB_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" constraintName="PROD_PLAN_JOB_ALTERNATE_DU_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_ALTERNATE_DU_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="67a9fd6d-faa4-4848-b4f5-882979847c90" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for JOB_OID of table PROD_PLAN_JOB_ALTERNATE_DUMP as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        </preConditions>
        <comment>MO-6498: DropIndex JOB_OID from PROD_PLAN_JOB_ALTERNATE_DUMP (JOB_OID)</comment>
        <dropIndex indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        <rollback>
            <createIndex unique="false" indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP">
                <column name="JOB_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="2c45cfd8-d487-4ee8-934d-8c429d0bc396" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_JOB_ALTERNATE_DUMP as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_ALTERNATE_DUMP" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_JOB_ALTERNATE_DUMP.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_JOB_ALTERNATE_DUMP">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY JOB_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_JOB_ALTERNATE_DUMP)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_JOB_ALTERNATE_DUMP" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="866229e1-e00f-4e23-a12b-2ffbfac68f20" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_JOB_ALTERNATE_DUMP.JOB_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_JOB_ALTERNATE_DUMP" columnName="JOB_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_JOB_ALTERNATE_DUMP.JOB_OID</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_ALTERNATE_DUMP WHERE JOB_OID IS NULL</sql>
        <addNotNullConstraint columnName="JOB_OID" columnDataType="BIGINT" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_JOB_ALTERNATE_DUMP" columnName="JOB_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="4a5d6a88-21a5-46c8-b0b0-575521f091d9" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_JOB_ALTERNATE_DUM_PK to table PROD_PLAN_JOB_ALTERNATE_DUMP as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_JOB_ALTERNATE_DUM_PK to PROD_PLAN_JOB_ALTERNATE_DUMP (JOB_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_JOB_ALTERNATE_DUMP WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_JOB_ALTERNATE_DUMP) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_JOB_ALTERNATE_DUMP) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="JOB_OID,REFERENCE_ID" constraintName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_JOB_ALTERNATE_DUM_PK" tableName="PROD_PLAN_JOB_ALTERNATE_DUMP"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="76e09f6d-5366-4d1e-834b-8395f351fbe2" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_ALTERNATE_DU_FK1 to table PROD_PLAN_JOB_ALTERNATE_DUMP as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_ALTERNATE_DUMP" columnName="JOB_OID"/>
            <columnExists tableName="PROD_PLAN_JOB" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" foreignKeyName="PROD_PLAN_JOB_ALTERNATE_DU_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_ALTERNATE_DU_FK1 to PROD_PLAN_JOB_ALTERNATE_DUMP (JOB_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_ALTERNATE_DUMP WHERE JOB_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_JOB WHERE PROD_PLAN_JOB.OID = PROD_PLAN_JOB_ALTERNATE_DUMP.JOB_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_ALTERNATE_DU_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_DUMP" constraintName="PROD_PLAN_JOB_ALTERNATE_DU_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_JOB_ALTERNATE_SOURCE changes -->

    <changeSet id="f601dcd4-3a57-49fa-a166-c1e13d46f380" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_JOB_ALTERNATE_SOU_PK of table PROD_PLAN_JOB_ALTERNATE_SOURCE as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_JOB_ALTERNATE_SOU_PK from PROD_PLAN_JOB_ALTERNATE_SOURCE (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="72d31370-d087-419e-b280-4e4638c1997d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_ALTERNATE_SO_FK1 of table PROD_PLAN_JOB_ALTERNATE_SOURCE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" foreignKeyName="PROD_PLAN_JOB_ALTERNATE_SO_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_ALTERNATE_SO_FK1 from PROD_PLAN_JOB_ALTERNATE_SOURCE (JOB_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" constraintName="PROD_PLAN_JOB_ALTERNATE_SO_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_ALTERNATE_SO_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="bbeca8ac-0622-4e22-93c8-8bc5c3786394" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for JOB_OID of table PROD_PLAN_JOB_ALTERNATE_SOURCE as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        </preConditions>
        <comment>MO-6498: DropIndex JOB_OID from PROD_PLAN_JOB_ALTERNATE_SOURCE (JOB_OID)</comment>
        <dropIndex indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        <rollback>
            <createIndex unique="false" indexName="JOB_OID" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE">
                <column name="JOB_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="9eeff385-d50b-4460-bb89-15cfcab2d14d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_JOB_ALTERNATE_SOURCE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_JOB_ALTERNATE_SOURCE.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY JOB_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_JOB_ALTERNATE_SOURCE)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="ec5fafdf-96cf-4259-ab31-9379d26f2177" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_JOB_ALTERNATE_SOURCE.JOB_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" columnName="JOB_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_JOB_ALTERNATE_SOURCE.JOB_OID</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_ALTERNATE_SOURCE WHERE JOB_OID IS NULL</sql>
        <addNotNullConstraint columnName="JOB_OID" columnDataType="BIGINT" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" columnName="JOB_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="52bf3f1d-a56a-4f2d-9cd4-3a0956151682" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_JOB_ALTERNATE_SOU_PK to table PROD_PLAN_JOB_ALTERNATE_SOURCE as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_JOB_ALTERNATE_SOU_PK to PROD_PLAN_JOB_ALTERNATE_SOURCE (JOB_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_JOB_ALTERNATE_SOURCE WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_JOB_ALTERNATE_SOURCE)
                                                                                      WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_JOB_ALTERNATE_SOURCE) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="JOB_OID,REFERENCE_ID" constraintName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_JOB_ALTERNATE_SOU_PK" tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="5804e69d-41a6-43e3-b100-d775654b935b" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_ALTERNATE_SO_FK1 to table PROD_PLAN_JOB_ALTERNATE_SOURCE as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" columnName="JOB_OID"/>
            <columnExists tableName="PROD_PLAN_JOB" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" foreignKeyName="PROD_PLAN_JOB_ALTERNATE_SO_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_ALTERNATE_SO_FK1 to PROD_PLAN_JOB_ALTERNATE_SOURCE (JOB_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_ALTERNATE_SOURCE WHERE JOB_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_JOB WHERE PROD_PLAN_JOB.OID = PROD_PLAN_JOB_ALTERNATE_SOURCE.JOB_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_ALTERNATE_SO_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_ALTERNATE_SOURCE" constraintName="PROD_PLAN_JOB_ALTERNATE_SO_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_JOB_PRIMARY_DUMP changes -->

    <changeSet id="d38a94a9-4a96-4761-b568-79f778c634c3" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_JOB_PRIMARY_DUMP_PK of table PROD_PLAN_JOB_PRIMARY_DUMP as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_JOB_PRIMARY_DUMP_PK from PROD_PLAN_JOB_PRIMARY_DUMP (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="4f5c2d11-b3a1-4c45-b3d9-95d600480b74" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_PRIMARY_DUMP_FK1 of table PROD_PLAN_JOB_PRIMARY_DUMP as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_PRIMARY_DUMP" foreignKeyName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_PRIMARY_DUMP_FK1 from PROD_PLAN_JOB_PRIMARY_DUMP (JOB_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_DUMP" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_DUMP" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="47a00cf6-a39d-48f8-a004-0f1e22bba8fc" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for JOB_OID of table PROD_PLAN_JOB_PRIMARY_DUMP as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        </preConditions>
        <comment>MO-6498: DropIndex JOB_OID from PROD_PLAN_JOB_PRIMARY_DUMP (JOB_OID)</comment>
        <dropIndex indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        <rollback>
            <createIndex unique="false" indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_DUMP">
                <column name="JOB_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="7c291586-f8b2-4b96-8897-2a37ac79740f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_JOB_PRIMARY_DUMP as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_PRIMARY_DUMP" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_JOB_PRIMARY_DUMP.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_JOB_PRIMARY_DUMP">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY JOB_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_JOB_PRIMARY_DUMP)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_JOB_PRIMARY_DUMP" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="11f5e51d-79e7-43f1-9469-816289a17764" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_JOB_PRIMARY_DUMP.JOB_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_JOB_PRIMARY_DUMP" columnName="JOB_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_JOB_PRIMARY_DUMP.JOB_OID</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_PRIMARY_DUMP WHERE JOB_OID IS NULL</sql>
        <addNotNullConstraint columnName="JOB_OID" columnDataType="BIGINT" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_JOB_PRIMARY_DUMP" columnName="JOB_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="da2ace97-100a-4216-bf73-cb31e750683d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_JOB_PRIMARY_DUMP_PK to table PROD_PLAN_JOB_PRIMARY_DUMP as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_JOB_PRIMARY_DUMP_PK to PROD_PLAN_JOB_PRIMARY_DUMP (JOB_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_JOB_PRIMARY_DUMP WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_JOB_PRIMARY_DUMP) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_JOB_PRIMARY_DUMP) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="JOB_OID,REFERENCE_ID" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_PK" tableName="PROD_PLAN_JOB_PRIMARY_DUMP"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="2a76ed5a-a9c5-464b-9719-7b880b0084cb" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_PRIMARY_DUMP_FK1 to table PROD_PLAN_JOB_PRIMARY_DUMP as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_PRIMARY_DUMP" columnName="JOB_OID"/>
            <columnExists tableName="PROD_PLAN_JOB" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_PRIMARY_DUMP" foreignKeyName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_PRIMARY_DUMP_FK1 to PROD_PLAN_JOB_PRIMARY_DUMP (JOB_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_PRIMARY_DUMP WHERE JOB_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_JOB WHERE PROD_PLAN_JOB.OID = PROD_PLAN_JOB_PRIMARY_DUMP.JOB_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_DUMP" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_DUMP" constraintName="PROD_PLAN_JOB_PRIMARY_DUMP_FK1"/>
        </rollback>
    </changeSet>
    
    <!-- PROD_PLAN_JOB_PRIMARY_SOURCE changes -->

    <changeSet id="e0cd525a-2a6b-4e44-8c9a-dcf0976e3e29" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_JOB_PRIMARY_SOURC_PK of table PROD_PLAN_JOB_PRIMARY_SOURCE as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_JOB_PRIMARY_SOURC_PK from PROD_PLAN_JOB_PRIMARY_SOURCE (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="f650fa3e-b2a4-4d09-acc1-7d6c8ea1c2ca" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_PRIMARY_SOUR_FK1 of table PROD_PLAN_JOB_PRIMARY_SOURCE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" foreignKeyName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_PRIMARY_SOUR_FK1 from PROD_PLAN_JOB_PRIMARY_SOURCE (JOB_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" constraintName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="dc220a8c-df98-4bc9-98ec-b7401f693c4b" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for JOB_OID of table PROD_PLAN_JOB_PRIMARY_SOURCE as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        </preConditions>
        <comment>MO-6498: DropIndex JOB_OID from PROD_PLAN_JOB_PRIMARY_SOURCE (JOB_OID)</comment>
        <dropIndex indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        <rollback>
            <createIndex unique="false" indexName="JOB_OID" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE">
                <column name="JOB_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="1734abed-982d-49d6-8072-bc35434440b0" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_JOB_PRIMARY_SOURCE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_PRIMARY_SOURCE" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_JOB_PRIMARY_SOURCE.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_JOB_PRIMARY_SOURCE">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY JOB_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_JOB_PRIMARY_SOURCE)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_JOB_PRIMARY_SOURCE" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="615e101f-ad09-4c3e-bc2e-c654ba8ace88" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_JOB_PRIMARY_SOURCE.JOB_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_JOB_PRIMARY_SOURCE" columnName="JOB_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_JOB_PRIMARY_SOURCE.JOB_OID</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_PRIMARY_SOURCE WHERE JOB_OID IS NULL</sql>
        <addNotNullConstraint columnName="JOB_OID" columnDataType="BIGINT" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_JOB_PRIMARY_SOURCE" columnName="JOB_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="3da29872-33b5-4de3-9746-9b225aab8260" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_JOB_PRIMARY_SOURC_PK to table PROD_PLAN_JOB_PRIMARY_SOURCE as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_JOB_PRIMARY_SOURC_PK to PROD_PLAN_JOB_PRIMARY_SOURCE (JOB_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_JOB_PRIMARY_SOURCE WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_JOB_PRIMARY_SOURCE) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_JOB_PRIMARY_SOURCE) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="JOB_OID,REFERENCE_ID" constraintName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_JOB_PRIMARY_SOURC_PK" tableName="PROD_PLAN_JOB_PRIMARY_SOURCE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="836dc7fd-e60f-467f-8153-747c32cd56d6" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_PRIMARY_SOUR_FK1 to table PROD_PLAN_JOB_PRIMARY_SOURCE as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_PRIMARY_SOURCE" columnName="JOB_OID"/>
            <columnExists tableName="PROD_PLAN_JOB" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" foreignKeyName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_PRIMARY_SOUR_FK1 to PROD_PLAN_JOB_PRIMARY_SOURCE (JOB_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_PRIMARY_SOURCE WHERE JOB_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_JOB WHERE PROD_PLAN_JOB.OID = PROD_PLAN_JOB_PRIMARY_SOURCE.JOB_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_PRIMARY_SOURCE" constraintName="PROD_PLAN_JOB_PRIMARY_SOUR_FK1"/>
        </rollback>
    </changeSet>
    
    <!-- PROD_PLAN_JOB_EQUIPMENT changes -->

    <changeSet id="012d996f-c15d-4dde-b6a4-84964e91ba8f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_JOB_EQUIPMENT_PK of table PROD_PLAN_JOB_EQUIPMENT as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_JOB_EQUIPMENT_PK from PROD_PLAN_JOB_EQUIPMENT (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="682fb8b0-6b07-4135-ad75-8de6b644cc1f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_EQUIPMENT_FK1 of table PROD_PLAN_JOB_EQUIPMENT as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_EQUIPMENT" foreignKeyName="PROD_PLAN_JOB_EQUIPMENT_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_EQUIPMENT_FK1 from PROD_PLAN_JOB_EQUIPMENT (JOB_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_EQUIPMENT" constraintName="PROD_PLAN_JOB_EQUIPMENT_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_EQUIPMENT" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_EQUIPMENT_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="ee3bb03b-2f88-47ca-8905-46c362c95cc8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_JOB_EQUIPMENT as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_EQUIPMENT" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_JOB_EQUIPMENT.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_JOB_EQUIPMENT">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY JOB_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_JOB_EQUIPMENT)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_JOB_EQUIPMENT" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="85765ffc-61ec-43b3-9dbc-7ba1fde86085" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_JOB_EQUIPMENT_PK to table PROD_PLAN_JOB_EQUIPMENT as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB_EQUIPMENT"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_JOB_EQUIPMENT_PK to PROD_PLAN_JOB_EQUIPMENT (JOB_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_JOB_EQUIPMENT WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_JOB_EQUIPMENT) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY JOB_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_JOB_EQUIPMENT) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="JOB_OID,REFERENCE_ID" constraintName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_JOB_EQUIPMENT_PK" tableName="PROD_PLAN_JOB_EQUIPMENT"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="88a53a8b-7422-4733-a09f-6e3a4eccd0c8" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_EQUIPMENT_FK1 to table PROD_PLAN_JOB_EQUIPMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB_EQUIPMENT" columnName="JOB_OID"/>
            <columnExists tableName="PROD_PLAN_JOB" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB_EQUIPMENT" foreignKeyName="PROD_PLAN_JOB_EQUIPMENT_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_EQUIPMENT_FK1 to PROD_PLAN_JOB_EQUIPMENT (JOB_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB_EQUIPMENT WHERE JOB_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_JOB WHERE PROD_PLAN_JOB.OID = PROD_PLAN_JOB_EQUIPMENT.JOB_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB_EQUIPMENT" baseColumnNames="JOB_OID" constraintName="PROD_PLAN_JOB_EQUIPMENT_FK1" referencedTableName="PROD_PLAN_JOB" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB_EQUIPMENT" constraintName="PROD_PLAN_JOB_EQUIPMENT_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_DUMP_STOCKPILE changes -->

    <changeSet id="83b7f5ea-36ac-4173-87d9-524064b44d2c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_DUMP_STOCKPILE_FK1 of table PROD_PLAN_DUMP_STOCKPILE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_STOCKPILE" foreignKeyName="PROD_PLAN_DUMP_STOCKPILE_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_DUMP_STOCKPILE_FK1 from PROD_PLAN_DUMP_STOCKPILE (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_STOCKPILE" constraintName="PROD_PLAN_DUMP_STOCKPILE_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_STOCKPILE" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_STOCKPILE_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="11bd1652-f262-48ef-ab43-62cb0c7b093f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID of table PROD_PLAN_DUMP_STOCKPILE as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID from PROD_PLAN_DUMP_STOCKPILE (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_STOCKPILE">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="7bf08a6b-3042-437c-af20-b5c422ab7afa" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_DUMP_STOCKPILE_PK of table PROD_PLAN_DUMP_STOCKPILE as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_DUMP_STOCKPILE_PK from PROD_PLAN_DUMP_STOCKPILE (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="515f72eb-4516-4cbd-bb51-1fcfa46104c6" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_DUMP_STOCKPILE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_DUMP_STOCKPILE.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_DUMP_STOCKPILE">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_DUMP_STOCKPILE)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="9fb960ad-33eb-443c-976f-adb7cd2c1724" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_STOCKPILE.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_STOCKPILE.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_STOCKPILE WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="3c2ffd42-2b36-4883-af8c-6f1f528e6f8d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_STOCKPILE.REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_STOCKPILE.REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_STOCKPILE WHERE REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE_ID" columnDataType="VARCHAR(255)" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="REFERENCE_ID" columnDataType="VARCHAR(255)"/>
        </rollback>
    </changeSet>
    
    <changeSet id="d27e493f-7cd1-422d-b0c9-eaf29739865f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_DUMP_STOCKPILE_PK to table PROD_PLAN_DUMP_STOCKPILE as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_DUMP_STOCKPILE"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_DUMP_STOCKPILE_PK to PROD_PLAN_DUMP_STOCKPILE (PLAN_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_DUMP_STOCKPILE WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_DUMP_STOCKPILE) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_DUMP_STOCKPILE) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,REFERENCE_ID" constraintName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_DUMP_STOCKPILE_PK" tableName="PROD_PLAN_DUMP_STOCKPILE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="e4036bcc-6ced-4156-a794-2f7b2d3c35cf" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_DUMP_STOCKPILE_FK1 to table PROD_PLAN_DUMP_STOCKPILE as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                       onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_STOCKPILE" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_STOCKPILE" foreignKeyName="PROD_PLAN_DUMP_STOCKPILE_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_DUMP_STOCKPILE_FK1 to PROD_PLAN_DUMP_STOCKPILE (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_STOCKPILE WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_DUMP_STOCKPILE.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_STOCKPILE" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_STOCKPILE_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_STOCKPILE" constraintName="PROD_PLAN_DUMP_STOCKPILE_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_DUMP_CRUSHER changes -->

    <changeSet id="f5988048-27da-4ac0-af66-e1b7de4be977" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_DUMP_CRUSHER_PLAN_FK of table PROD_PLAN_DUMP_CRUSHER as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_CRUSHER" foreignKeyName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_DUMP_CRUSHER_PLAN_FK from PROD_PLAN_DUMP_CRUSHER (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_CRUSHER" constraintName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_CRUSHER" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="66ae165d-1d62-43fc-816f-fd04f9e319ff" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID of table PROD_PLAN_DUMP_CRUSHER as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID from PROD_PLAN_DUMP_CRUSHER (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID" tableName="PROD_PLAN_DUMP_CRUSHER">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="4e10e73b-2d6f-410e-8bd5-a2afe1150503" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_DUMP_CRUSHER_PK of table PROD_PLAN_DUMP_CRUSHER as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_DUMP_CRUSHER_PK from PROD_PLAN_DUMP_CRUSHER (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="9e97453d-8768-42ed-ae79-c5eda3ef58c8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_DUMP_CRUSHER as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_CRUSHER" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_DUMP_CRUSHER.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_DUMP_CRUSHER">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_DUMP_CRUSHER)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_DUMP_CRUSHER" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="82c93e80-8230-4127-941a-b88649dffac7" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_CRUSHER.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_CRUSHER" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_CRUSHER.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_CRUSHER WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_CRUSHER" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="0864a765-3cbb-4676-b51e-02a3de6e1d22" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_CRUSHER.REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_CRUSHER" columnName="REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_CRUSHER.REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_CRUSHER WHERE REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE_ID" columnDataType="VARCHAR(255)" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_CRUSHER" columnName="REFERENCE_ID" columnDataType="VARCHAR(255)"/>
        </rollback>
    </changeSet>
    
    <changeSet id="1c24466c-c3cd-47d7-b92c-67a03be5ac66" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_DUMP_CRUSHER_PK to table PROD_PLAN_DUMP_CRUSHER as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_DUMP_CRUSHER"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_DUMP_CRUSHER_PK to PROD_PLAN_DUMP_CRUSHER (PLAN_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_DUMP_CRUSHER WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_DUMP_CRUSHER) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_DUMP_CRUSHER) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,REFERENCE_ID" constraintName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_DUMP_CRUSHER_PK" tableName="PROD_PLAN_DUMP_CRUSHER"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="e0f1019b-e0e7-4c75-a773-6292e0eed30e" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_DUMP_CRUSHER_PLAN_FK to table PROD_PLAN_DUMP_CRUSHER as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                       onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_CRUSHER" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_CRUSHER" foreignKeyName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_DUMP_CRUSHER_PLAN_FK to PROD_PLAN_DUMP_CRUSHER (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_CRUSHER WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_DUMP_CRUSHER.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_CRUSHER" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_CRUSHER" constraintName="PROD_PLAN_DUMP_CRUSHER_PLAN_FK"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_DUMP_BLEND changes -->

    <changeSet id="7ee5db01-a292-477d-8e62-4bf3ffa770e1" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_DUMP_BLEND_PLAN_O_FK of table PROD_PLAN_DUMP_BLEND as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_BLEND" foreignKeyName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_DUMP_BLEND_PLAN_O_FK from PROD_PLAN_DUMP_BLEND (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND" constraintName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>
    
    <changeSet id="c8791e6f-cad7-4024-b597-dcc523236e12" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for DUMP_BLEND_NR of table PROD_PLAN_DUMP_BLEND as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_BLEND" columnName="DUMP_BLEND_NR"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_DUMP_BLEND.DUMP_BLEND_NR</comment>
        <dropColumn columnName="DUMP_BLEND_NR" tableName="PROD_PLAN_DUMP_BLEND"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_DUMP_BLEND">
                <column name="DUMP_BLEND_NR" type="INT"/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="7be92e61-2943-45d0-854e-e430cb9792a8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_BLEND.BLEND_REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_BLEND" columnName="BLEND_REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_BLEND.BLEND_REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_BLEND WHERE BLEND_REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="BLEND_REFERENCE_ID" columnDataType="VARCHAR(255)" tableName="PROD_PLAN_DUMP_BLEND"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_BLEND" columnName="BLEND_REFERENCE_ID" columnDataType="VARCHAR(255)"/>
        </rollback>
    </changeSet>

    <changeSet id="fe2342b6-775c-4c90-98f8-41c538c68036" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_DUMP_BLEND_PLAN_O_FK to table PROD_PLAN_DUMP_BLEND as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_BLEND" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_BLEND" foreignKeyName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_DUMP_BLEND_PLAN_O_FK to PROD_PLAN_DUMP_BLEND (PLAN_OID)</comment>
        <sql>UPDATE PROD_PLAN_DUMP_BLEND SET PLAN_OID = NULL WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_DUMP_BLEND.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND" constraintName="PROD_PLAN_DUMP_BLEND_PLAN_O_FK"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_DUMP_BLEND_MATERIAL changes -->

    <changeSet id="96f0aaa8-a183-4f0b-a594-0632fe73ee38" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_DUMP_BLEND_MATERI_PK of table PROD_PLAN_DUMP_BLEND_MATERIAL as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_DUMP_BLEND_MATERI_PK from PROD_PLAN_DUMP_BLEND_MATERIAL (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="52833401-3ab2-4c18-ac57-fc2d09bd265e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_DUMP_BLEND_MATER_FK1 of table PROD_PLAN_DUMP_BLEND_MATERIAL as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" foreignKeyName="PROD_PLAN_DUMP_BLEND_MATER_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_DUMP_BLEND_MATER_FK1 from PROD_PLAN_DUMP_BLEND_MATERIAL (DUMP_BLEND_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" constraintName="PROD_PLAN_DUMP_BLEND_MATER_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" baseColumnNames="DUMP_BLEND_OID" constraintName="PROD_PLAN_DUMP_BLEND_MATER_FK1" referencedTableName="PROD_PLAN_DUMP_BLEND" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="bfa20028-07ac-40be-9bb5-b45605fde10e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_DUMP_BLEND_MATERIAL as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_BLEND_MATERIAL" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_DUMP_BLEND_MATERIAL.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_DUMP_BLEND_MATERIAL">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY DUMP_BLEND_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_DUMP_BLEND_MATERIAL)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_DUMP_BLEND_MATERIAL" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="28297142-5bcd-4cb3-a5d8-5a3456b095e8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_DUMP_BLEND_MATERIAL.REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_DUMP_BLEND_MATERIAL" columnName="REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_DUMP_BLEND_MATERIAL.REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_BLEND_MATERIAL WHERE REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE_ID" columnDataType="VARCHAR(255)" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_DUMP_BLEND_MATERIAL" columnName="REFERENCE_ID" columnDataType="VARCHAR(255)"/>
        </rollback>
    </changeSet>

    <changeSet id="99c14cb0-5869-4095-8325-30d35d679385" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_DUMP_BLEND_MATERI_PK to table PROD_PLAN_DUMP_BLEND_MATERIAL as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_DUMP_BLEND_MATERI_PK to PROD_PLAN_DUMP_BLEND_MATERIAL (DUMP_BLEND_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_DUMP_BLEND_MATERIAL WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY DUMP_BLEND_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_DUMP_BLEND_MATERIAL) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY DUMP_BLEND_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_DUMP_BLEND_MATERIAL) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="DUMP_BLEND_OID,REFERENCE_ID" constraintName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_DUMP_BLEND_MATERI_PK" tableName="PROD_PLAN_DUMP_BLEND_MATERIAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="a2fde699-8517-4e34-9e8b-486bcc936544" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_DUMP_BLEND_MATER_FK1 to table PROD_PLAN_DUMP_BLEND_MATERIAL as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_DUMP_BLEND_MATERIAL" columnName="DUMP_BLEND_OID"/>
            <columnExists tableName="PROD_PLAN_DUMP_BLEND" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" foreignKeyName="PROD_PLAN_DUMP_BLEND_MATER_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_DUMP_BLEND_MATER_FK1 to PROD_PLAN_DUMP_BLEND_MATERIAL (DUMP_BLEND_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_DUMP_BLEND_MATERIAL WHERE DUMP_BLEND_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN_DUMP_BLEND WHERE PROD_PLAN_DUMP_BLEND.OID = PROD_PLAN_DUMP_BLEND_MATERIAL.DUMP_BLEND_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" baseColumnNames="DUMP_BLEND_OID" constraintName="PROD_PLAN_DUMP_BLEND_MATER_FK1" referencedTableName="PROD_PLAN_DUMP_BLEND" referencedColumnNames="OID"
                                 onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_DUMP_BLEND_MATERIAL" constraintName="PROD_PLAN_DUMP_BLEND_MATER_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_ENDORSEMENT changes -->

    <changeSet id="11de67e4-cdc6-40e7-9bf0-d255909396cb" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_ENDORSEMENT_PK of table PROD_PLAN_ENDORSEMENT as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_ENDORSEMENT_PK" tableName="PROD_PLAN_ENDORSEMENT"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_ENDORSEMENT_PK from PROD_PLAN_ENDORSEMENT (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_ENDORSEMENT_PK" tableName="PROD_PLAN_ENDORSEMENT"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_ENDORSEMENT_PK" tableName="PROD_PLAN_ENDORSEMENT"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="46c33089-860c-4b95-af66-07a23196c5a2" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_ENDORSEMENT as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_ENDORSEMENT" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_ENDORSEMENT.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_ENDORSEMENT"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_ENDORSEMENT">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, USER_OID, CREATED_DATE_UTC) AS ROW_NUM FROM PROD_PLAN_ENDORSEMENT)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_ENDORSEMENT" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_METRIC changes -->

    <changeSet id="f34c8af0-9f2a-42ef-b069-3f7fa1a6e97c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_METRIC_FK1 of table PROD_PLAN_METRIC as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_METRIC" foreignKeyName="PROD_PLAN_METRIC_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_METRIC_FK1 from PROD_PLAN_METRIC (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_METRIC" constraintName="PROD_PLAN_METRIC_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_METRIC" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_METRIC_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="e6cdba90-8210-463e-8ca4-246c1b78515b" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID_IDX of table PROD_PLAN_METRIC as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID_IDX" tableName="PROD_PLAN_METRIC"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID_IDX from PROD_PLAN_METRIC (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID_IDX" tableName="PROD_PLAN_METRIC"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID_IDX" tableName="PROD_PLAN_METRIC">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="c294aac2-ea4f-4914-a920-9092676647e6" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_METRIC_PK of table PROD_PLAN_METRIC as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_METRIC_PK from PROD_PLAN_METRIC (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="45b50133-d9e7-49b8-b6ec-d56be7e8a021" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_METRIC as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_METRIC" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_METRIC.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_METRIC"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_METRIC">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, METRIC_TYPE, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_METRIC)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_METRIC" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="8e88d25d-c122-4f56-8489-961b8c66dd6e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_METRIC.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_METRIC" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_METRIC.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_METRIC WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_METRIC"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_METRIC" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="9bfb3c1f-7a4d-4643-a6ba-e7cceccd1245" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_METRIC_PK to table PROD_PLAN_METRIC as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_METRIC"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_METRIC_PK to PROD_PLAN_METRIC (PLAN_OID,METRIC_TYPE,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_METRIC WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, METRIC_TYPE, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_METRIC) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, METRIC_TYPE, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_METRIC) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,METRIC_TYPE,REFERENCE_ID" constraintName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_METRIC_PK" tableName="PROD_PLAN_METRIC"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="354831f6-92cd-47d6-a9d0-e1e7dfab3e1e" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_METRIC_PLAN_OID_FK to table PROD_PLAN_METRIC as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_METRIC" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_METRIC" foreignKeyName="PROD_PLAN_METRIC_PLAN_OID_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_METRIC_PLAN_OID_FK to PROD_PLAN_METRIC (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_METRIC WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_METRIC.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_METRIC" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_METRIC_PLAN_OID_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_METRIC" constraintName="PROD_PLAN_METRIC_PLAN_OID_FK"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_SOURCE_BLOCK changes -->

    <changeSet id="3e1b5cb4-8aab-4ce5-b4b6-522f976f028d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_SOURCE_BLOCK_PLAN_FK of table PROD_PLAN_SOURCE_BLOCK as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_SOURCE_BLOCK" foreignKeyName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_SOURCE_BLOCK_PLAN_FK from PROD_PLAN_SOURCE_BLOCK (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_BLOCK" constraintName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_BLOCK" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="8f8a0e74-d408-484e-ba3c-145488e89d74" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID of table PROD_PLAN_SOURCE_BLOCK as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID from PROD_PLAN_SOURCE_BLOCK (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_BLOCK">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="1ce2a823-f3e2-4385-939b-fe1f3a3befe7" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_SOURCE_BLOCK_PK of table PROD_PLAN_SOURCE_BLOCK as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_SOURCE_BLOCK_PK from PROD_PLAN_SOURCE_BLOCK (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="7f1a4f25-faad-4435-98f9-0aa6171a8d23" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_SOURCE_BLOCK as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_SOURCE_BLOCK" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_SOURCE_BLOCK.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_SOURCE_BLOCK">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_SOURCE_BLOCK)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_SOURCE_BLOCK" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="de085ac6-cedf-40f3-8bef-0938bbaef6eb" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_SOURCE_BLOCK.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_SOURCE_BLOCK" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_SOURCE_BLOCK.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_BLOCK WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_SOURCE_BLOCK" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="12e0967f-ba98-4051-978b-2f6e26aab869" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_SOURCE_BLOCK.REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_SOURCE_BLOCK" columnName="REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_SOURCE_BLOCK.REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_BLOCK WHERE REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE_ID" columnDataType="VARCHAR(254)" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_SOURCE_BLOCK" columnName="REFERENCE_ID" columnDataType="VARCHAR(254)"/>
        </rollback>
    </changeSet>

    <changeSet id="27bdbb8f-9f17-40f5-b609-e5cb0b3a393d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_SOURCE_BLOCK_PK to table PROD_PLAN_SOURCE_BLOCK as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_SOURCE_BLOCK"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_SOURCE_BLOCK_PK to PROD_PLAN_SOURCE_BLOCK (PLAN_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_SOURCE_BLOCK WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_SOURCE_BLOCK) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_SOURCE_BLOCK) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,REFERENCE_ID" constraintName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_SOURCE_BLOCK_PK" tableName="PROD_PLAN_SOURCE_BLOCK"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="c6caea59-ef3c-4b4a-b1d3-137f9bdc971a" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_SOURCE_BLOCK_PLAN_FK to table PROD_PLAN_SOURCE_BLOCK as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                       onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_SOURCE_BLOCK" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_SOURCE_BLOCK" foreignKeyName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_SOURCE_BLOCK_PLAN_FK to PROD_PLAN_SOURCE_BLOCK (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_BLOCK WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_SOURCE_BLOCK.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_BLOCK" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_BLOCK" constraintName="PROD_PLAN_SOURCE_BLOCK_PLAN_FK"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_SOURCE_STOCKPILE changes -->

    <changeSet id="5cbbe0cf-90f0-4392-9f27-8d85b7742503" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_SOURCE_STOCKPILE_FK1 of table PROD_PLAN_SOURCE_STOCKPILE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_SOURCE_STOCKPILE" foreignKeyName="PROD_PLAN_SOURCE_STOCKPILE_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_SOURCE_STOCKPILE_FK1 from PROD_PLAN_SOURCE_STOCKPILE (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_STOCKPILE" constraintName="PROD_PLAN_SOURCE_STOCKPILE_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_STOCKPILE" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_SOURCE_STOCKPILE_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="e63da9e3-6c68-47f1-b083-81ccdeb27a56" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID of table PROD_PLAN_SOURCE_STOCKPILE as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID from PROD_PLAN_SOURCE_STOCKPILE (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID" tableName="PROD_PLAN_SOURCE_STOCKPILE">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="844e7244-2cc2-4fff-8f9a-cf0554952166" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_SOURCE_STOCKPILE_PK of table PROD_PLAN_SOURCE_STOCKPILE as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_SOURCE_STOCKPILE_PK from PROD_PLAN_SOURCE_STOCKPILE (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="ccd2832c-0b79-46db-891b-f14b1ce35a86" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_SOURCE_STOCKPILE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_SOURCE_STOCKPILE.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_SOURCE_STOCKPILE">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, REFERENCE_ID) AS ROW_NUM FROM PROD_PLAN_SOURCE_STOCKPILE)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="3a166283-4cf1-4fd7-9d65-37be9c93bf8c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_SOURCE_STOCKPILE.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_SOURCE_STOCKPILE.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_STOCKPILE WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="19632044-1f71-4b66-830f-89c8634e0e0e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_SOURCE_STOCKPILE.REFERENCE_ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="REFERENCE_ID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_SOURCE_STOCKPILE.REFERENCE_ID</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_STOCKPILE WHERE REFERENCE_ID IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE_ID" columnDataType="VARCHAR(254)" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="REFERENCE_ID" columnDataType="VARCHAR(254)"/>
        </rollback>
    </changeSet>

    <changeSet id="698f5184-d624-4797-9a1a-0dbe5e353d45" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_SOURCE_STOCKPILE_PK to table PROD_PLAN_SOURCE_STOCKPILE as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_SOURCE_STOCKPILE_PK to PROD_PLAN_SOURCE_STOCKPILE (PLAN_OID,REFERENCE_ID)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_SOURCE_STOCKPILE WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY ROWID) RN FROM PROD_PLAN_SOURCE_STOCKPILE) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE_ID ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_SOURCE_STOCKPILE) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,REFERENCE_ID" constraintName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_SOURCE_STOCKPILE_PK" tableName="PROD_PLAN_SOURCE_STOCKPILE"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="d0798831-c71a-432d-b958-5346d70f0f19" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_SOURCE_STOCKPILE_FK1 to table PROD_PLAN_SOURCE_STOCKPILE as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_SOURCE_STOCKPILE" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_SOURCE_STOCKPILE" foreignKeyName="PROD_PLAN_SOURCE_STOCKPILE_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_SOURCE_STOCKPILE_FK1 to PROD_PLAN_SOURCE_STOCKPILE (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_SOURCE_STOCKPILE WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_SOURCE_STOCKPILE.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_STOCKPILE" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_SOURCE_STOCKPILE_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_SOURCE_STOCKPILE" constraintName="PROD_PLAN_SOURCE_STOCKPILE_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_REFERENCE_WARNING changes -->

    <changeSet id="9f063e38-d56b-4dfb-a999-40dde0b0fdd7" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_REFERENCE_WARNIN_FK1 of table PROD_PLAN_REFERENCE_WARNING as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_REFERENCE_WARNING" foreignKeyName="PROD_PLAN_REFERENCE_WARNIN_FK1"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_REFERENCE_WARNIN_FK1 from PROD_PLAN_REFERENCE_WARNING (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_REFERENCE_WARNING" constraintName="PROD_PLAN_REFERENCE_WARNIN_FK1"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_REFERENCE_WARNING" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_REFERENCE_WARNIN_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>
    
    <changeSet id="e1f41ab2-5c4f-45f3-b600-b655a4ea6119" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for PROD_PLAN_REFERENCE_WARNING_PK of table PROD_PLAN_REFERENCE_WARNING as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        </preConditions>
        <comment>MO-6498: DropPrimaryKey PROD_PLAN_REFERENCE_WARNING_PK from PROD_PLAN_REFERENCE_WARNING (OID)</comment>
        <dropPrimaryKey constraintName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        <rollback>
            <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="3e8d1d90-97d8-4b69-859b-66d337956666" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for OID of table PROD_PLAN_REFERENCE_WARNING as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_REFERENCE_WARNING" columnName="OID"/>
        </preConditions>
        <comment>MO-6498: DropColumn PROD_PLAN_REFERENCE_WARNING.OID</comment>
        <dropColumn columnName="OID" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        <rollback>
            <addColumn tableName="PROD_PLAN_REFERENCE_WARNING">
                <column name="OID" type="BIGINT"/>
            </addColumn>
            <!-- Fabricate some dodgy (but locally unique) OIDs to populate the column -->
            <sql dbms="mssql">
                WITH CTE AS (SELECT OID, ROW_NUMBER() OVER (ORDER BY PLAN_OID, REFERENCE, REFERENCE_TYPE) AS ROW_NUM FROM PROD_PLAN_REFERENCE_WARNING)
                UPDATE CTE SET OID = ROW_NUM</sql>
            <addNotNullConstraint tableName="PROD_PLAN_REFERENCE_WARNING" columnName="OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="be01b3d5-9a44-4439-ad76-27189c92452d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_REFERENCE_WARNING.REFERENCE as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_REFERENCE_WARNING" columnName="REFERENCE"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_REFERENCE_WARNING.REFERENCE</comment>
        <sql>DELETE FROM PROD_PLAN_REFERENCE_WARNING WHERE REFERENCE IS NULL</sql>
        <addNotNullConstraint columnName="REFERENCE" columnDataType="VARCHAR(254)" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_REFERENCE_WARNING" columnName="REFERENCE" columnDataType="VARCHAR(254)"/>
        </rollback>
    </changeSet>
    
    <changeSet id="31e4c23c-1333-4bbe-b18f-834e0345e235" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for PROD_PLAN_REFERENCE_WARNING_PK to table PROD_PLAN_REFERENCE_WARNING as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_REFERENCE_WARNING"/>
            <not>
                <primaryKeyExists primaryKeyName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddPrimaryKey PROD_PLAN_REFERENCE_WARNING_PK to PROD_PLAN_REFERENCE_WARNING (PLAN_OID,REFERENCE,REFERENCE_TYPE)</comment>
        <sql dbms="oracle">DELETE FROM PROD_PLAN_REFERENCE_WARNING WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE, REFERENCE_TYPE ORDER BY ROWID) RN FROM PROD_PLAN_REFERENCE_WARNING) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY PLAN_OID, REFERENCE, REFERENCE_TYPE ORDER BY %%physloc%%) AS ROW_NUM FROM PROD_PLAN_REFERENCE_WARNING) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="PLAN_OID,REFERENCE,REFERENCE_TYPE" constraintName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        <rollback>
            <dropPrimaryKey constraintName="PROD_PLAN_REFERENCE_WARNING_PK" tableName="PROD_PLAN_REFERENCE_WARNING"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="b8893156-1dcb-4278-a527-124565f4f893" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_REFERENCE_WARNIN_FK1 to table PROD_PLAN_REFERENCE_WARNING as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_REFERENCE_WARNING" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_REFERENCE_WARNING" foreignKeyName="PROD_PLAN_REFERENCE_WARNIN_FK1"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_REFERENCE_WARNIN_FK1 to PROD_PLAN_REFERENCE_WARNING (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_REFERENCE_WARNING WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_REFERENCE_WARNING.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_REFERENCE_WARNING" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_REFERENCE_WARNIN_FK1" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_REFERENCE_WARNING" constraintName="PROD_PLAN_REFERENCE_WARNIN_FK1"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_COMMENT changes -->

    <changeSet id="0290ffe3-a1ef-40d9-8dff-5c5d290872bf" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_COMMENT_PLAN_OID_FK of table PROD_PLAN_COMMENT as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_COMMENT" foreignKeyName="PROD_PLAN_COMMENT_PLAN_OID_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_COMMENT_PLAN_OID_FK from PROD_PLAN_COMMENT (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_COMMENT" constraintName="PROD_PLAN_COMMENT_PLAN_OID_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_COMMENT" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_COMMENT_PLAN_OID_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="4114ad8d-b72a-4f53-bdf9-7026c1214778" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_COMMENT_PLAN_OID_FK to table PROD_PLAN_COMMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_COMMENT" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_COMMENT" foreignKeyName="PROD_PLAN_COMMENT_PLAN_OID_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_COMMENT_PLAN_OID_FK to PROD_PLAN_COMMENT (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_COMMENT WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_COMMENT.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_COMMENT" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_COMMENT_PLAN_OID_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_COMMENT" constraintName="PROD_PLAN_COMMENT_PLAN_OID_FK"/>
        </rollback>
    </changeSet>

    <!-- PROD_PLAN_JOB changes -->

    <changeSet id="a5e6f7d0-e0f9-4057-9ba9-bd6d8a602b89" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_JOB_PLAN_OID_FK of table PROD_PLAN_JOB as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB" foreignKeyName="PROD_PLAN_JOB_PLAN_OID_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_JOB_PLAN_OID_FK from PROD_PLAN_JOB (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB" constraintName="PROD_PLAN_JOB_PLAN_OID_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_JOB_PLAN_OID_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="2d6f0188-f270-460d-a0d0-3d326e1c8ab5" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for PLAN_OID of table PROD_PLAN_JOB as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="PLAN_OID" tableName="PROD_PLAN_JOB"/>
        </preConditions>
        <comment>MO-6498: DropIndex PLAN_OID from PROD_PLAN_JOB (PLAN_OID)</comment>
        <dropIndex indexName="PLAN_OID" tableName="PROD_PLAN_JOB"/>
        <rollback>
            <createIndex unique="false" indexName="PLAN_OID" tableName="PROD_PLAN_JOB">
                <column name="PLAN_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="7fb3237e-cb19-4da4-9735-ac8206bc8ee0" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_JOB.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_JOB" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-6498: AddNotNullConstraint to PROD_PLAN_JOB.PLAN_OID</comment>
        <sql>DELETE FROM PROD_PLAN_JOB WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_JOB"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_JOB" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="540bf614-1b61-48be-bfdd-f997bb014b83" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored CreateIndex for PROD_PLAN_JOB_PLAN_OID to table PROD_PLAN_JOB as (1) table does not exist, or (2) index already exists." onFail="MARK_RAN">
            <tableExists tableName="PROD_PLAN_JOB"/>
            <not>
                <indexExists indexName="PROD_PLAN_JOB_PLAN_OID" tableName="PROD_PLAN_JOB"/>
            </not>
        </preConditions>
        <comment>MO-6498: CreateIndex PROD_PLAN_JOB_PLAN_OID on PROD_PLAN_JOB (PLAN_OID)</comment>
        <createIndex unique="false" indexName="PROD_PLAN_JOB_PLAN_OID" tableName="PROD_PLAN_JOB">
            <column name="PLAN_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    
    <changeSet id="67da0127-8e08-4b01-aba4-b5e703e528d4" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_JOB_PLAN_OID_FK to table PROD_PLAN_JOB as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_JOB" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_JOB" foreignKeyName="PROD_PLAN_JOB_PLAN_OID_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_JOB_PLAN_OID_FK to PROD_PLAN_JOB (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_JOB WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_JOB.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_JOB" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_JOB_PLAN_OID_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_JOB" constraintName="PROD_PLAN_JOB_PLAN_OID_FK"/>
        </rollback>
    </changeSet>
    
    <!-- PROD_PLAN_VARIATION changes -->

    <changeSet id="6eba7359-b154-43a6-9e2d-7b2b234bcbe3" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PROD_PLAN_VARIATION_PLAN_OI_FK of table PROD_PLAN_VARIATION as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_VARIATION" foreignKeyName="PROD_PLAN_VARIATION_PLAN_OI_FK"/>
        </preConditions>
        <comment>MO-6498: DropForeignKeyConstraint PROD_PLAN_VARIATION_PLAN_OI_FK from PROD_PLAN_VARIATION (PLAN_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PROD_PLAN_VARIATION" constraintName="PROD_PLAN_VARIATION_PLAN_OI_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="PROD_PLAN_VARIATION" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_VARIATION_PLAN_OI_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>
    
    <changeSet id="ac52fb2f-e476-4d73-a670-9038b31d9f54" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_VARIATION_PLAN_OI_FK to table PROD_PLAN_VARIATION as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_VARIATION" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_VARIATION" foreignKeyName="PROD_PLAN_VARIATION_PLAN_OI_FK"/>
            </not>
        </preConditions>
        <comment>MO-6498: AddForeignKeyConstraint PROD_PLAN_VARIATION_PLAN_OI_FK to PROD_PLAN_VARIATION (PLAN_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_VARIATION WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_VARIATION.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_VARIATION" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_VARIATION_PLAN_OI_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_VARIATION" constraintName="PROD_PLAN_VARIATION_PLAN_OI_FK"/>
        </rollback>
    </changeSet>    

</databaseChangeLog>
