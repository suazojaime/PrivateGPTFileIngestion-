<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="c628dc1e-73a5-4529-bf5d-1265161bcafb" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for LOW_ICON_NAME to table MACHINE_CLASS_ICON as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MACHINE_CLASS_ICON"/>
            <not>
                <columnExists tableName="MACHINE_CLASS_ICON" columnName="LOW_ICON_NAME"/>
            </not>
        </preConditions>
        <comment>AHS-7789: AddColumn MACHINE_CLASS_ICON.LOW_ICON_NAME</comment>
        <addColumn tableName="MACHINE_CLASS_ICON">
            <column name="LOW_ICON_NAME" type="VARCHAR(254)" remarks="The name of the low resolution icon."/>
        </addColumn>
    </changeSet>

    <changeSet id="0b0ff6ea-881c-4c54-a54b-2eae3c0f966f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for MACHINE_CLASS_ICON_ICON_OID_FK of table MACHINE_CLASS_ICON as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="MACHINE_CLASS_ICON" foreignKeyName="MACHINE_CLASS_ICON_ICON_OID_FK"/>
        </preConditions>
        <comment>AHS-7789: DropForeignKeyConstraint MACHINE_CLASS_ICON_ICON_OID_FK from MACHINE_CLASS_ICON (ICON_OID)</comment>
        <dropForeignKeyConstraint baseTableName="MACHINE_CLASS_ICON" constraintName="MACHINE_CLASS_ICON_ICON_OID_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="MACHINE_CLASS_ICON" baseColumnNames="ICON_OID" constraintName="MACHINE_CLASS_ICON_ICON_OID_FK" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="d6613d3b-32bd-42c5-86e7-f103ae8eb97a" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_CLASS_ICON_ICON_OID_FK to table MACHINE_CLASS_ICON as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="MACHINE_CLASS_ICON" columnName="ICON_OID"/>
            <columnExists tableName="MACHINECLASS" columnName="MACHINECLASS_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_CLASS_ICON" foreignKeyName="MACHINE_CLASS_ICON_ICON_OID_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7789: AddForeignKeyConstraint MACHINE_CLASS_ICON_ICON_OID_FK to MACHINE_CLASS_ICON (ICON_OID)</comment>
        <sql>DELETE FROM MACHINE_CLASS_ICON WHERE ICON_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINECLASS WHERE MACHINECLASS.MACHINECLASS_OID = MACHINE_CLASS_ICON.ICON_OID)</sql>
        <addForeignKeyConstraint baseTableName="MACHINE_CLASS_ICON" baseColumnNames="ICON_OID" constraintName="MACHINE_CLASS_ICON_ICON_OID_FK" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_CLASS_ICON" constraintName="MACHINE_CLASS_ICON_ICON_OID_FK"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
