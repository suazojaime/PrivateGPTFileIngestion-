<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="4b8c5eba-a5bc-4c5b-9fc6-a1f111ab3017" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for CLASS_LANE_TRAVEL_DATA_LANE_FK of table CLASS_LANE_TRAVEL_DATA as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="CLASS_LANE_TRAVEL_DATA" foreignKeyName="CLASS_LANE_TRAVEL_DATA_LANE_FK"/>
        </preConditions>
        <comment>AHS-7468: DropForeignKeyConstraint CLASS_LANE_TRAVEL_DATA_LANE_FK from CLASS_LANE_TRAVEL_DATA (LANE_TRAVEL_OID)</comment>
        <dropForeignKeyConstraint baseTableName="CLASS_LANE_TRAVEL_DATA" constraintName="CLASS_LANE_TRAVEL_DATA_LANE_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="CLASS_LANE_TRAVEL_DATA" baseColumnNames="LANE_TRAVEL_OID" constraintName="CLASS_LANE_TRAVEL_DATA_LANE_FK" referencedTableName="LANE_TRAVEL_DATA" referencedColumnNames="LANE_TRAVEL_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="3b4bab35-5cd1-43b8-81ff-56eb9cb35410" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropPrimaryKey for CLASS_LANE_TRAVEL_DATA_PK of table CLASS_LANE_TRAVEL_DATA as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="CLASS_LANE_TRAVEL_DATA_PK" tableName="CLASS_LANE_TRAVEL_DATA"/>
        </preConditions>
        <comment>AHS-7468: DropPrimaryKey CLASS_LANE_TRAVEL_DATA_PK from CLASS_LANE_TRAVEL_DATA (LANE_TRAVEL_OID,LIST_INDEX)</comment>
        <dropPrimaryKey constraintName="CLASS_LANE_TRAVEL_DATA_PK" tableName="CLASS_LANE_TRAVEL_DATA"/>
        <rollback>
            <addPrimaryKey columnNames="LANE_TRAVEL_OID,LIST_INDEX" constraintName="CLASS_LANE_TRAVEL_DATA_PK" tableName="CLASS_LANE_TRAVEL_DATA"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="533172d9-3c1f-432e-8382-dbc46c307f72" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored AddColumn for LANE_OID to table CLASS_LANE_TRAVEL_DATA as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="CLASS_LANE_TRAVEL_DATA"/>
            <not>
                <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="LANE_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7468: AddColumn CLASS_LANE_TRAVEL_DATA.LANE_OID</comment>
        <addColumn tableName="CLASS_LANE_TRAVEL_DATA">
            <column name="LANE_OID" type="BIGINT"/>
        </addColumn>
        <sql>UPDATE CLASS_LANE_TRAVEL_DATA SET LANE_OID = (SELECT LANE FROM LANE_TRAVEL_DATA LTD WHERE LTD.LANE_TRAVEL_OID = CLASS_LANE_TRAVEL_DATA.LANE_TRAVEL_OID)</sql>
        <sql>DELETE FROM CLASS_LANE_TRAVEL_DATA WHERE LANE_OID IS NULL</sql>
        <addNotNullConstraint tableName="CLASS_LANE_TRAVEL_DATA" columnName="LANE_OID" columnDataType="BIGINT"/>
        <rollback>
            <dropColumn tableName="CLASS_LANE_TRAVEL_DATA" columnName="LANE_OID"/>
        </rollback>
    </changeSet>

    <changeSet id="6a07a356-ad7d-43b9-8b7a-03af249cbbdf" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropColumn for LANE_TRAVEL_OID of table CLASS_LANE_TRAVEL_DATA as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="LANE_TRAVEL_OID"/>
        </preConditions>
        <comment>AHS-7468: DropColumn CLASS_LANE_TRAVEL_DATA.LANE_TRAVEL_OID</comment>
        <dropColumn columnName="LANE_TRAVEL_OID" tableName="CLASS_LANE_TRAVEL_DATA"/>
        <rollback>
            <sql>DELETE FROM CLASS_LANE_TRAVEL_DATA</sql>
            <addColumn tableName="CLASS_LANE_TRAVEL_DATA">
                <column name="LANE_TRAVEL_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="2af1b812-977f-442d-963a-c7997e23e058" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropColumn for LIST_INDEX of table CLASS_LANE_TRAVEL_DATA as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="LIST_INDEX"/>
        </preConditions>
        <comment>AHS-7468: DropColumn CLASS_LANE_TRAVEL_DATA.LIST_INDEX</comment>
        <dropColumn columnName="LIST_INDEX" tableName="CLASS_LANE_TRAVEL_DATA"/>
        <rollback>
            <sql>DELETE FROM CLASS_LANE_TRAVEL_DATA</sql>
            <addColumn tableName="CLASS_LANE_TRAVEL_DATA">
                <column name="LIST_INDEX" type="INT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="7998f747-783f-404f-9259-c1256c570719" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored RenameColumn CLASS to MACHINE_CLASS_OID to table CLASS_LANE_TRAVEL_DATA as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="CLASS_LANE_TRAVEL_DATA"/>
            <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="CLASS"/>
            <not>
                <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="MACHINE_CLASS_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7468: RenameColumn CLASS_LANE_TRAVEL_DATA.CLASS to CLASS_LANE_TRAVEL_DATA.MACHINE_CLASS_OID</comment>
        <renameColumn tableName="CLASS_LANE_TRAVEL_DATA" oldColumnName="CLASS" newColumnName="MACHINE_CLASS_OID"/>
    </changeSet>

    <changeSet id="533172d9-3c1f-432e-8382-dbc46c307f83" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for CLASS_LANE_TRAVEL_DATA.MACHINE_CLASS_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="CLASS_LANE_TRAVEL_DATA" columnName="MACHINE_CLASS_OID"/>
        </preConditions>
        <comment>AHS-7468: AddNotNullConstraint to CLASS_LANE_TRAVEL_DATA.MACHINE_CLASS_OID</comment>
        <sql>DELETE FROM CLASS_LANE_TRAVEL_DATA WHERE MACHINE_CLASS_OID IS NULL</sql>
        <addNotNullConstraint tableName="CLASS_LANE_TRAVEL_DATA" columnName="MACHINE_CLASS_OID" columnDataType="BIGINT"/>
        <rollback>
            <dropNotNullConstraint tableName="CLASS_LANE_TRAVEL_DATA" columnName="MACHINE_CLASS_OID"/>
        </rollback>
    </changeSet>

    <changeSet id="3cabf083-a697-4b5a-a163-5c44adda7068" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored AddPrimaryKey for CLASS_LANE_TRAVEL_DATA_PK to table CLASS_LANE_TRAVEL_DATA as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="CLASS_LANE_TRAVEL_DATA"/>
            <not>
                <primaryKeyExists primaryKeyName="CLASS_LANE_TRAVEL_DATA_PK" tableName="CLASS_LANE_TRAVEL_DATA"/>
            </not>
        </preConditions>
        <comment>AHS-7468: AddPrimaryKey CLASS_LANE_TRAVEL_DATA_PK to CLASS_LANE_TRAVEL_DATA (LANE_OID,MACHINE_CLASS_OID)</comment>
        <sql dbms="oracle">DELETE FROM CLASS_LANE_TRAVEL_DATA WHERE ROWID NOT IN (SELECT MIN(ROWID) FROM CLASS_LANE_TRAVEL_DATA GROUP BY LANE_OID, MACHINE_CLASS_OID)</sql>
        <addPrimaryKey columnNames="LANE_OID,MACHINE_CLASS_OID" constraintName="CLASS_LANE_TRAVEL_DATA_PK" tablespace="MW_IDXENT" tableName="CLASS_LANE_TRAVEL_DATA"/>
        <rollback>
            <dropPrimaryKey constraintName="CLASS_LANE_TRAVEL_DATA_PK" tableName="CLASS_LANE_TRAVEL_DATA"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="d22fd3c4-fc28-4c0b-bf78-f37e084625f1" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropIndex for LANE_TRAVEL_DATA_LANE of table LANE_TRAVEL_DATA as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="LANE_TRAVEL_DATA_LANE" tableName="LANE_TRAVEL_DATA"/>
        </preConditions>
        <comment>AHS-7468: DropIndex LANE_TRAVEL_DATA_LANE from LANE_TRAVEL_DATA (LANE)</comment>
        <dropIndex indexName="LANE_TRAVEL_DATA_LANE" tableName="LANE_TRAVEL_DATA"/>
        <rollback>
            <createIndex unique="true" tablespace="MW_IDXENT" tableName="LANE_TRAVEL_DATA" indexName="LANE_TRAVEL_DATA_LANE">
                <column name="LANE"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="f1a5cd29-fbfc-44db-a91e-5e1d96994c53" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropPrimaryKey for LANE_TRAVEL_DATA_PK of table LANE_TRAVEL_DATA as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="LANE_TRAVEL_DATA_PK" tableName="LANE_TRAVEL_DATA"/>
        </preConditions>
        <comment>AHS-7468: DropPrimaryKey LANE_TRAVEL_DATA_PK from LANE_TRAVEL_DATA (LANE_TRAVEL_OID)</comment>
        <dropPrimaryKey constraintName="LANE_TRAVEL_DATA_PK" tableName="LANE_TRAVEL_DATA"/>
        <rollback>
            <addPrimaryKey columnNames="LANE_TRAVEL_OID" constraintName="LANE_TRAVEL_DATA_PK" tableName="LANE_TRAVEL_DATA"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="e054a67c-9443-4086-bfd9-71e072a8e7e6" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored DropColumn for LANE_TRAVEL_OID of table LANE_TRAVEL_DATA as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="LANE_TRAVEL_DATA" columnName="LANE_TRAVEL_OID"/>
        </preConditions>
        <comment>AHS-7468: DropColumn LANE_TRAVEL_DATA.LANE_TRAVEL_OID</comment>
        <dropColumn columnName="LANE_TRAVEL_OID" tableName="LANE_TRAVEL_DATA"/>
        <rollback>
            <addColumn tableName="LANE_TRAVEL_DATA">
                <column name="LANE_TRAVEL_OID" type="BIGINT"/>
            </addColumn>
            <sql>UPDATE LANE_TRAVEL_DATA SET LANE_TRAVEL_OID = LANE WHERE LANE_TRAVEL_OID IS NULL</sql>
        </rollback>
    </changeSet>

    <changeSet id="e01f2092-98fd-4866-96a4-149bc859e3dc" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored RenameColumn LANE to LANE_OID to table LANE_TRAVEL_DATA as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE_TRAVEL_DATA"/>
            <columnExists tableName="LANE_TRAVEL_DATA" columnName="LANE"/>
            <not>
                <columnExists tableName="LANE_TRAVEL_DATA" columnName="LANE_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7468: RenameColumn LANE_TRAVEL_DATA.LANE to LANE_TRAVEL_DATA.LANE_OID</comment>
        <renameColumn tableName="LANE_TRAVEL_DATA" oldColumnName="LANE" newColumnName="LANE_OID"/>
    </changeSet>

    <changeSet id="d21bb09b-c2f6-45e5-aac2-bf3a096c3300" author="MineStar" failOnError="true">
        <preConditions onFailMessage="Ignored AddPrimaryKey for LANE_TRAVEL_DATA_PK to table LANE_TRAVEL_DATA as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE_TRAVEL_DATA"/>
            <not>
                <primaryKeyExists primaryKeyName="LANE_TRAVEL_DATA_PK" tableName="LANE_TRAVEL_DATA"/>
            </not>
        </preConditions>
        <comment>AHS-7468: AddPrimaryKey LANE_TRAVEL_DATA_PK to LANE_TRAVEL_DATA (LANE_OID)</comment>
        <sql dbms="oracle">DELETE FROM LANE_TRAVEL_DATA WHERE ROWID NOT IN (SELECT MIN(ROWID) FROM LANE_TRAVEL_DATA GROUP BY LANE_OID)</sql>
        <addPrimaryKey columnNames="LANE_OID" constraintName="LANE_TRAVEL_DATA_PK" tablespace="MW_IDXENT" tableName="LANE_TRAVEL_DATA"/>
        <rollback>
            <dropPrimaryKey constraintName="LANE_TRAVEL_DATA_PK" tableName="LANE_TRAVEL_DATA"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="71b6cbcb-b0c3-41a4-bf96-dc5135e216d1" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="true">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for CLASS_LANE_TRAVEL_DATA_LANE_FK to table CLASS_LANE_TRAVEL_DATA as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="CLASS_LANE_TRAVEL_DATA"/>
            <tableExists tableName="LANE_TRAVEL_DATA"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="CLASS_LANE_TRAVEL_DATA" foreignKeyName="CLASS_LANE_TRAVEL_DATA_LANE_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7468: AddForeignKeyConstraint CLASS_LANE_TRAVEL_DATA_LANE_FK to CLASS_LANE_TRAVEL_DATA (LANE_OID)</comment>
        <sql>DELETE FROM CLASS_LANE_TRAVEL_DATA WHERE NOT EXISTS (SELECT 'x' FROM LANE_TRAVEL_DATA WHERE LANE_TRAVEL_DATA.LANE_OID = CLASS_LANE_TRAVEL_DATA.LANE_OID)</sql>
        <addForeignKeyConstraint baseTableName="CLASS_LANE_TRAVEL_DATA" baseColumnNames="LANE_OID" constraintName="CLASS_LANE_TRAVEL_DATA_LANE_FK" referencedTableName="LANE_TRAVEL_DATA" referencedColumnNames="LANE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="CLASS_LANE_TRAVEL_DATA" constraintName="CLASS_LANE_TRAVEL_DATA_LANE_FK"/>
        </rollback>
    </changeSet>
    
</databaseChangeLog>
