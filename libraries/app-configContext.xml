<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (c) 2015, Caterpillar, Brisbane Australia. All rights reserved. -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:flex="http://www.springframework.org/schema/flex"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/flex http://www.springframework.org/schema/flex/spring-flex-1.5.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd"
>

    <flex:message-broker>
        <!-- invalidate-http-session is not enabled by default in the implementation so enable it here -->
        <flex:secured per-client-authentication="true" invalidate-http-session="true" />
    </flex:message-broker>

    <!-- Securing exported spring services -->
    <security:global-method-security secured-annotations="enabled" jsr250-annotations="enabled" pre-post-annotations="enabled"/>

    <bean id="defaultMessageTemplate" class="org.springframework.flex.messaging.MessageTemplate" >
        <property name="defaultDestination" value="event-bus"/>
    </bean>

    <flex:message-destination id="event-bus" channels="my-streaming-amf, my-polling-amf, my-amf, my-streaming-secure-amf, my-secure-amf"/>

	<!--
		Enable annotation-based configuration. companyService and industryService
		(used in the Company Manager sample) are configured using annotations.
		Open CompanyDAO.java and IndustryDAO.java for details.
	-->
    <context:annotation-config />
    <context:component-scan  base-package="minestar.ciods" />

    <!-- JMS Message Bus -->
    <bean id="jmsConnectionFactory" class="minestar.platform.jms.activemq.ActiveMQFactoryWrapper">
        <constructor-arg index="0" type="java.lang.String" value="${MSTAR_FSB_HOST}"/>
        <constructor-arg index="1" type="int" value="${MSTAR_FSB_PORT}"/>
        <constructor-arg index="2" type="boolean" value="false"/>
    </bean>

    <bean id="pooledJmsConnectionFactory" class="minestar.platform.jms.activemq.ActiveMQFactoryWrapper">
        <constructor-arg index="0" type="java.lang.String" value="${MSTAR_FSB_HOST}"/>
        <constructor-arg index="1" type="int" value="${MSTAR_FSB_PORT}"/>
        <constructor-arg index="2" type="boolean" value="false"/>
    </bean>

    <!--<bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate" lazy-init="false"-->
          <!--p:connectionFactory-ref="pooledJmsConnectionFactory"/>-->

    <bean id="meterUnitConverter" class="minestar.ciods.dozer.DozerUnitConverter">
        <property name="unitType" value="length"/>
        <property name="unitName" value="metre"/>
        <property name="quantityDTOConversion" ref="quantityDTOConversionFacade"/>
    </bean>

    <bean id="xMeterUnitConverter" class="minestar.ciods.dozer.DozerXYZConverter">
        <property name="unitConverter" ref="meterUnitConverter"/>
        <property name="fieldName" value="x"/>
    </bean>

    <bean id="yMeterUnitConverter" class="minestar.ciods.dozer.DozerXYZConverter">
        <property name="unitConverter" ref="meterUnitConverter"/>
        <property name="fieldName" value="y"/>
    </bean>

    <bean id="dozerBeanMapper" class="org.dozer.DozerBeanMapper" >
        <property name="mappingFiles">
            <list>
                <value>dozer-bean-mappings.xml</value>
            </list>
        </property>
        <property name="customConvertersWithId">
            <map>
                <entry key="meterUnitConverter" value-ref="meterUnitConverter"/>
                <entry key="xMeterUnitConverter" value-ref="xMeterUnitConverter"/>
                <entry key="yMeterUnitConverter" value-ref="yMeterUnitConverter"/>
            </map>
        </property>
    </bean>

    <!-- Message Queue -->
    <bean id="positionReportMessageWrapper" class="minestar.ciods.machine.service.PositionReport" scope="prototype">

    </bean>

    <bean id="maydayMessageWrapper" class="minestar.ciods.machine.service.MaydayMessage" scope="prototype"></bean>

    <bean id="genericMessageBridge" class="minestar.convergence.platform.bus.ObjectMessageBridge">
        <property name="messageTemplate" ref="defaultMessageTemplate" />
        <property name="transformers">
            <list>
                <!-- <bean class="minestar.convergence.platform.bus.PositionReportTransformer"/> -->
                <bean class="minestar.convergence.platform.bus.DataUpdateTransformer"/>
                <bean class="minestar.convergence.platform.bus.MaydayMessageTransformer"/>
                <bean class="minestar.ciods.operator.service.OperatorMachineUpdateTransformer"/>
                <bean class="minestar.ciods.hazard.service.HazardUpdateTransformer" />
                <bean class="minestar.ciods.gisimport.service.SyncEventTransformer"/>
                <bean class="minestar.ciods.app.service.MineStarLifecycleTransformer"/>
                <bean class="minestar.ciods.alarm.AlarmMessageTransformer">
                    <property name="alarmTypes">
                        <list>
                            <value>MisconfiguredMachine</value>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="updateDataMessageWrapper" class="minestar.ciods.machine.service.MachineCategoryDto" scope="prototype"/>

    <bean id="fieldEventTopic" class="org.apache.activemq.artemis.jms.client.ActiveMQTopic" lazy-init="true">
        <constructor-arg value="minestar.event.field.out"/>
    </bean>

    <bean id="updateEventTopic" class="org.apache.activemq.artemis.jms.client.ActiveMQTopic" lazy-init="true">
        <constructor-arg value="minestar.event.update.out"/>
    </bean>

    <bean id="genericMessageContainer" class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="fieldEventTopic"/>
        <property name="messageListener" ref="genericMessageBridge" />
        <property name="sessionTransacted" value="false"/>
    </bean>

    <bean id="appMessageContainer" class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="updateEventTopic"/>
        <property name="messageListener" ref="applicationService" />
        <property name="sessionTransacted" value="false"/>
    </bean>

    <bean id="lifeCycleTransformerImpl" class="minestar.ciods.machine.service.impl.LifeCycleTransformerImpl"/>

    <bean id="fieldEventMessageListenerImpl" class="minestar.ciods.machine.service.impl.FieldEventMessageListenerImpl"/>

    <bean id="fieldEventContainer" class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="fieldEventTopic"/>
        <property name="messageListener" ref="fieldEventMessageListenerImpl" />
        <property name="sessionTransacted" value="false"/>
    </bean>

    <bean id="genericMessageContainer1" class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="updateEventTopic"/>
        <property name="messageListener" ref="genericMessageBridge" />
        <property name="sessionTransacted" value="false"/>
    </bean>

    <bean id="jobEventTopicPublish" class="org.apache.activemq.artemis.jms.client.ActiveMQTopic" lazy-init="true">
        <constructor-arg value="minestar.event.job.publish"/>
    </bean>

    <bean class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="jobEventTopicPublish"/>
        <property name="messageListener" ref="jobEventBridge" />

        <property name="sessionTransacted" value="false"/>
    </bean>


    <bean id="jobEventBridge" class="minestar.ciods.job.service.JobEventResponseBridge">
        <property name="messageTemplate" ref="defaultMessageTemplate" />
        <property name="dozerBeanMapper" ref="dozerBeanMapper" />
    </bean>

    <bean id="systemEventTopic" class="org.apache.activemq.artemis.jms.client.ActiveMQTopic" lazy-init="true">
        <constructor-arg value="minestar.event.system"/>
    </bean>

    <bean class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="systemEventTopic"/>
        <property name="messageListener" ref="machineMessageResponseBridge" />

        <property name="sessionTransacted" value="false"/>
    </bean>


    <bean id="machineMessageResponseBridge" class="minestar.ciods.machine.service.MachineMessageResponseBridge">
        <property name="messageTemplate" ref="defaultMessageTemplate" />
        <property name="dozerBeanMapper" ref="dozerBeanMapper" />
    </bean>

    <bean id="systemNotificationMessageContainer" class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="pooledJmsConnectionFactory"/>
        <property name="destination" ref="updateEventTopic"/>
        <property name="messageListener" ref="systemNotificationMessageListener" />
        <property name="sessionTransacted" value="false"/>
    </bean>

    <bean id="systemNotificationMessageListener" class="minestar.convergence.platform.listener.SystemNotificationMessageListener">
        <property name="messageTemplate" ref="defaultMessageTemplate"/>
    </bean>


    <!-- RMI proxy -->

    <bean id="quantityDTOConversionFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/quantityDTOConversion"/>
        <property name="serviceInterface" value="com.mincom.util.unit.dto.QuantityDTOConversionFacade"/>
    </bean>

    <bean id="pitModelServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/pitModelServiceFacade"/>
        <property name="serviceInterface" value="minestar.pitlink.service.pitmodel.facade.PitModelServiceFacade"/>
    </bean>

	<!--<bean id="userServiceRemote" parent="parentRemote">-->
		<!--<property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/ServiceProvider/UserService/User_Service"/>-->
        <!--<property name="serviceInterface" value="com.mincom.env.service.provider.ServiceProvider"/>-->
    <!--</bean>-->

    <bean id="userServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/userServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.personnel.UserServiceFacade"/>
    </bean>

    <bean id="licenseServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/licenseServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.license.LicenseServiceFacade"/>
    </bean>

    <bean id="machineServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/machineServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.machine.MachineServiceFacade"/>
    </bean>

    <bean id="diagnosticServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/diagnosticServiceImpl"/>
        <property name="serviceInterface" value="minestar.mine.service.util.DiagnosticService"/>
    </bean>

    <bean id="jobSchedulerServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/jobSchedulerServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.job.minelayout.JobSchedulerServiceFacade"/>
    </bean>

    <bean id="configServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/configServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.util.ConfigServiceFacade"/>
    </bean>

    <bean id="reportServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/reportServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.report.ReportServiceFacade"/>
    </bean>
    <bean id="zoneServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/zoneServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.zone.ZoneServiceFacade"/>
    </bean>

    <bean id="hazardServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/hazardServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.hazard.HazardServiceFacade"/>
    </bean>

    <bean id="siteEditorServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/siteEditorServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.minemodel.SiteEditorService"/>
    </bean>

    <bean id="layerDefinitionService" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/layerDefinitionServiceImpl"/>
        <property name="serviceInterface" value="minestar.mine.service.layer.LayerDefinitionService"/>
    </bean>

    <bean id="securityService" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/securityServiceImpl"/>
        <property name="serviceInterface" value="minestar.control.service.security.SecurityService"/>
    </bean>

    <bean id="locationUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/locationUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.location.LocationUCCFacade"/>
    </bean>

    <bean id="waypointUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/waypointUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.waypoint.WaypointUCCFacade"/>
    </bean>

    <bean id="aStopUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/aStopUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.astop.AStopUCCFacade"/>
    </bean>

    <bean id="cycleUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/cycleUCC"/>
        <property name="serviceInterface" value="minestar.production.uifacade.cycle.CycleUCCFacade"/>
    </bean>

    <bean id="delayUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/delayUCC"/>
        <property name="serviceInterface" value="minestar.production.uifacade.delay.DelayUCCFacade"/>
    </bean>

    <bean id="drawCardUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/drawCardUCC"/>
        <property name="serviceInterface" value="minestar.production.uifacade.drawcard.DrawCardUCCFacade"/>
    </bean>

    <bean id="healthUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/healthUCC"/>
        <property name="serviceInterface" value="minestar.health.uifacade.measure.HealthUCCFacade"/>
    </bean>

    <bean id="incidentUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/incidentUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.incident.IncidentUCCFacade"/>
    </bean>

    <bean id="kpiUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/kpiUCC"/>
        <property name="serviceInterface" value="minestar.production.uifacade.kpi.KpiUCCFacade"/>
    </bean>

    <bean id="machineUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/machineUCC"/>
        <property name="serviceInterface" value="minestar.pitlink.uifacade.machine.MachineUCCFacade"/>
    </bean>

    <bean id="monitorUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/monitorUCC"/>
        <property name="serviceInterface" value="minestar.platform.uifacade.monitor.MonitorUCCFacade"/>
    </bean>

    <bean id="settingsUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/settingsUCC"/>
        <property name="serviceInterface" value="minestar.platform.uifacade.settings.SettingsUCCFacade"/>
    </bean>

    <bean id="finderUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/finderUCC"/>
        <property name="serviceInterface" value="minestar.platform.uifacade.search.FinderUCCFacade"/>
    </bean>

    <bean id="layerUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/layerUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.layer.LayerUCCFacade"/>
    </bean>

    <bean id="personUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/personUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.person.PersonUCCFacade"/>
    </bean>

    <bean id="replayUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/replayUCC"/>
        <property name="serviceInterface" value="minestar.pitlink.uifacade.replay.ReplayUCCFacade"/>
    </bean>

    <bean id="sharedLayerUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/sharedLayerUCC"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.layer.SharedLayerUCCFacade"/>
    </bean>

    <bean id="tpmUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/tpmUCC"/>
        <property name="serviceInterface" value="minestar.pitlink.uifacade.pitmodel.TpmUCCFacade"/>
    </bean>

    <bean id="unitUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/unitUCC"/>
        <property name="serviceInterface" value="minestar.platform.uifacade.unit.UnitUCCFacade"/>
    </bean>

    <bean id="userUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/userUCC"/>
        <property name="serviceInterface" value="minestar.platform.uifacade.user.UserUCCFacade"/>
    </bean>

    <bean id="searchService" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/searchServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.uifacade.search.SearchService"/>
    </bean>

    <bean id="machineModeChangeUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/machineModeChangeUCC"/>
        <property name="serviceInterface" value="minestar.autonomy.uifacade.mode.MachineModeChangeUCCFacade"/>
    </bean>

    <bean id="shiftProductionPlanUCC" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/shiftProductionPlanUCC"/>
        <property name="serviceInterface" value="minestar.production.uifacade.shift.ShiftProductionPlanUCCFacade"/>
    </bean>

    <bean id="wfsServiceFacade" parent="parentRemote">
        <property name="serviceUrl" value="rmi://${MSTAR_BUS_HOST}:${MSTAR_BUS_PORT}/wfsServiceFacade"/>
        <property name="serviceInterface" value="minestar.mine.service.wfs.WebFeatureServiceFacade"/>
    </bean>

    <bean id="wfsResource" class="minestar.mine.service.wfs.WebFeatureServiceResource">
        <property name="wfs" ref="wfsServiceFacade" />
    </bean>

</beans>
