<!-- Copyright (c) 2018, Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet id="66808e84-4f03-4eeb-b838-0c925f9d0811" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false" runAlways="true">
      <preConditions>
          <columnExists tableName="CLASS_LANE_TRAVEL_DATA" columnName="LANE_OID"/>
      </preConditions>
      <comment>AHS-5374 changing lanes to prevent autonomous travel for lanes with no machine class travel data</comment>
      <sql>
          update lane
             set autonomous = 0
           where is_active = 1
             and dynamic_gen = 0
             and (type != 'CALIBRATION_RACETRACK' and type != 'CALIBRATION_PRETZEL')
             and (select count(*)
                    from class_lane_travel_data ct
                   where ct.lane_oid = lane.lane_oid
                     and (ct.allow_loaded = 1 or ct.allow_empty = 1)) = 0;
      </sql>
      <rollback>
          <comment>@EmptyRollback</comment>
      </rollback>
  </changeSet>

</databaseChangeLog>
