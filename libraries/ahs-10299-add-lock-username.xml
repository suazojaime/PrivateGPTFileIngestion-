<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2019 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="543c04dd-1201-47bc-a99c-eec52b4ec137" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddColumn for USER_NAME to table GENERIC_USER_LOCKS as table does not exist or column already exists."
                onFail="MARK_RAN">
            <tableExists tableName="GENERIC_USER_LOCKS"/>
            <not>
                <columnExists tableName="GENERIC_USER_LOCKS" columnName="USER_NAME"/>
            </not>
        </preConditions>
        <comment>AHS-10299: AddColumn GENERIC_USER_LOCKS.USER_NAME</comment>
        <addColumn tableName="GENERIC_USER_LOCKS">
            <column name="USER_NAME" type="VARCHAR(255)"/>
        </addColumn>
        <sql>UPDATE GENERIC_USER_LOCKS SET USER_NAME = (SELECT NAME FROM USER1 WHERE USER_OID = USER_ID) WHERE USER_NAME IS NULL</sql>
        <sql>UPDATE GENERIC_USER_LOCKS SET USER_NAME = (SELECT NAME FROM PERSON WHERE PERSON_OID = USER_ID) WHERE USER_NAME IS NULL</sql>
        <sql>UPDATE GENERIC_USER_LOCKS SET USER_NAME = (SELECT NAME FROM MACHINE WHERE MACHINE_OID = USER_ID) WHERE USER_NAME IS NULL</sql>
        <sql>UPDATE GENERIC_USER_LOCKS SET USER_NAME = REASON WHERE USER_NAME IS NULL</sql>
        <addNotNullConstraint columnName="USER_NAME" columnDataType="VARCHAR(255)" tableName="GENERIC_USER_LOCKS"/>
        <rollback>
            <dropColumn tableName="GENERIC_USER_LOCKS" columnName="USER_NAME"/>
        </rollback>
    </changeSet>

    <changeSet id="18707b75-2030-4437-a1fc-2d3836ed4966" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropPrimaryKey for GENERIC_USER_LOCKS_PK of table GENERIC_USER_LOCKS as primaryKey does not exist."
                onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="GENERIC_USER_LOCKS_PK" tableName="GENERIC_USER_LOCKS"/>
        </preConditions>
        <comment>AHS-10299: DropPrimaryKey GENERIC_USER_LOCKS_PK from GENERIC_USER_LOCKS (OID,LOCK_NR)</comment>
        <dropPrimaryKey constraintName="GENERIC_USER_LOCKS_PK" tableName="GENERIC_USER_LOCKS"/>
        <rollback>
            <addPrimaryKey columnNames="OID,LOCK_NR" constraintName="GENERIC_USER_LOCKS_PK" tableName="GENERIC_USER_LOCKS"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="dfbc6993-4565-4243-ba4a-d2003c271258" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropColumn for LOCK_NR of table GENERIC_USER_LOCKS as column does not exist."
                onFail="MARK_RAN">
            <columnExists tableName="GENERIC_USER_LOCKS" columnName="LOCK_NR"/>
        </preConditions>
        <comment>AHS-10299: DropColumn GENERIC_USER_LOCKS.LOCK_NR</comment>
        <dropColumn columnName="LOCK_NR" tableName="GENERIC_USER_LOCKS"/>
        <rollback>
            <addColumn tableName="GENERIC_USER_LOCKS">
                <column name="LOCK_NR" type="INT" defaultValue="0">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
            <sqlFile dbms="oracle" path="db/changelog/functions/oracle/updateLockNr.sql" endDelimiter="/" stripComments="true"/>
            <sqlFile dbms="mssql" path="db/changelog/functions/sqlserver/updateLockNr.sql" endDelimiter="Go" stripComments="true"/>
        </rollback>
    </changeSet>

    <changeSet id="dcbcfcaf-ebf4-49c0-8250-7f6fc9dc65d7" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for GENERIC_USER_LOCKS_PK to table GENERIC_USER_LOCKS as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="GENERIC_USER_LOCKS"/>
            <not>
                <primaryKeyExists primaryKeyName="GENERIC_USER_LOCKS_PK" tableName="GENERIC_USER_LOCKS"/>
            </not>
        </preConditions>
        <comment>AHS-10299: AddPrimaryKey GENERIC_USER_LOCKS_PK to GENERIC_USER_LOCKS (OID,USER_ID,USER_TYPE)</comment>
        <sql dbms="oracle">DELETE FROM GENERIC_USER_LOCKS WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY OID, USER_ID, USER_TYPE ORDER BY ROWID) RN FROM GENERIC_USER_LOCKS) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY OID, USER_ID, USER_TYPE ORDER BY %%physloc%%) AS ROW_NUM FROM GENERIC_USER_LOCKS) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="OID,USER_ID,USER_TYPE" constraintName="GENERIC_USER_LOCKS_PK" tablespace="MW_IDXENT" tableName="GENERIC_USER_LOCKS"/>
        <rollback>
            <dropPrimaryKey constraintName="GENERIC_USER_LOCKS_PK" tableName="GENERIC_USER_LOCKS"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

</databaseChangeLog>
