<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2023 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

<changeSet id="3529fefe-6ce0-47d4-b604-679a9defa8e8" author="MineStar" dbms="mssql" failOnError="false">
    <preConditions onFailMessage="Ignored migrate 'Scale' to 'Payload Service' machine category" onFail="MARK_RAN">
        <sqlCheck expectedResult="1">
            SELECT COUNT(*) FROM MACHINECATEGORY WHERE ECF_CLASS_ID = 'XAEntity.MachineCategory.PayloadServiceCategory' AND NAME = 'Scales';
        </sqlCheck>
        <sqlCheck expectedResult="1">
            SELECT COUNT(*) FROM MACHINECATEGORY WHERE ECF_CLASS_ID = 'XAEntity.MachineCategory.PayloadServiceCategory' AND NAME = 'Payload Service';
        </sqlCheck>
    </preConditions>
    <comment>MO-13903: Migrate 'Scale' MachineCategory to 'Payload Service'</comment>
    <sql>
        DECLARE @SCALE_OID BIGINT = (SELECT MACHINECATEGORY_OID FROM MACHINECATEGORY WHERE ECF_CLASS_ID = 'XAEntity.MachineCategory.PayloadServiceCategory' AND NAME = 'Scales')
        DECLARE @PAYLOAD_SERVICE_OID BIGINT = (SELECT MACHINECATEGORY_OID FROM MACHINECATEGORY WHERE ECF_CLASS_ID = 'XAEntity.MachineCategory.PayloadServiceCategory' AND NAME = 'Payload Service')

        -- Update all 'Scale' category references to 'Payload Service'
        UPDATE ACTIVITY_ASSOCIATION SET MACHINE_CATEGORY_OID = @PAYLOAD_SERVICE_OID WHERE MACHINE_CATEGORY_OID = @SCALE_OID
        UPDATE DELAY_CLASS_ASSOCIATION SET MACHINE_CATEGORY_OID = @PAYLOAD_SERVICE_OID WHERE MACHINE_CATEGORY_OID = @SCALE_OID
        UPDATE JOB_CODE_ASSOCIATION SET MACHINE_CATEGORY_OID = @PAYLOAD_SERVICE_OID WHERE MACHINE_CATEGORY_OID = @SCALE_OID
        UPDATE MACHINECLASS SET CATEGORY = @PAYLOAD_SERVICE_OID WHERE CATEGORY = @SCALE_OID

        -- Delete the 'Scale' category
        DELETE FROM MACHINECATEGORY WHERE MACHINECATEGORY_OID = @SCALE_OID
    </sql>
    <rollback/>
</changeSet>
</databaseChangeLog>
