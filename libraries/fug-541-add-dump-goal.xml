<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="71b8439e-26cb-4318-b9f3-592b0c0288d0" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for DUMP_GOAL as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="DUMP_GOAL"/>
            </not>
        </preConditions>
        <comment>FUG-541: CreateTable DUMP_GOAL</comment>
        <createTable tablespace="MW_ENT" remarks="The approach of a command machine to dump into an ore pass." tableName="DUMP_GOAL">
            <column name="DUMP_GOAL_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="DUMP_GOAL_NAME" type="VARCHAR(254)" remarks="The unique, user-entered identifier for this dump goal.">
                <constraints nullable="false"/>
            </column>
            <column name="ID" type="INT" remarks="The unique, system-assigned identifier for this dump goal.">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this dump goal is active or archived. (This flag is '1' if it is active and '0' if archived.)">
                <constraints nullable="false"/>
            </column>
            <column name="ORE_PASS" type="BIGINT" remarks="The ore pass that this dump goal is linked to.">
                <constraints nullable="false"/>
            </column>
            <column name="POSITION_X" type="DOUBLE" remarks="The center point of the dump goal.">
                <constraints nullable="false"/>
            </column>
            <column name="POSITION_Y" type="DOUBLE" remarks="The center point of the dump goal.">
                <constraints nullable="false"/>
            </column>
            <column name="POSITION_Z" type="DOUBLE" remarks="The center point of the dump goal.">
                <constraints nullable="false"/>
            </column>
            <column name="DIRECTION" type="DOUBLE" remarks="The direction that the arrow is pointing away from the center point.">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="DUMP_GOAL_OID" constraintName="DUMP_GOAL_PK" tablespace="MW_IDXENT" tableName="DUMP_GOAL"/>
        <createIndex unique="true" tablespace="MW_IDXENT" indexName="DUMPGOAL_ID" tableName="DUMP_GOAL">
            <column name="ID"/>
        </createIndex>
        <createIndex unique="true" tablespace="MW_IDXENT" indexName="DUMPGOAL_NAME" tableName="DUMP_GOAL">
            <column name="DUMP_GOAL_NAME"/>
        </createIndex>
        <createIndex unique="false" tablespace="MW_IDXENT" indexName="DUMPGOAL_OREPASS" tableName="DUMP_GOAL">
            <column name="ORE_PASS"/>
        </createIndex>
        <rollback>
            <dropTable tableName="DUMP_GOAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="dfa72816-4854-4439-9923-16b9c29f2436" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for DUMP_GOAL_ORE_PASS_FK to table DUMP_GOAL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="DUMP_GOAL"/>
            <tableExists tableName="ORE_PASS"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DUMP_GOAL" foreignKeyName="DUMP_GOAL_ORE_PASS_FK"/>
            </not>
        </preConditions>
        <comment>FUG-541: AddForeignKeyConstraint DUMP_GOAL_ORE_PASS_FK to DUMP_GOAL (ORE_PASS)</comment>
        <sql>DELETE FROM DUMP_GOAL WHERE ORE_PASS IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM ORE_PASS WHERE ORE_PASS.OREPASS_OID = DUMP_GOAL.ORE_PASS)</sql>
        <addForeignKeyConstraint baseTableName="DUMP_GOAL" baseColumnNames="ORE_PASS" constraintName="DUMP_GOAL_ORE_PASS_FK" referencedTableName="ORE_PASS" referencedColumnNames="OREPASS_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DUMP_GOAL" constraintName="DUMP_GOAL_ORE_PASS_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
