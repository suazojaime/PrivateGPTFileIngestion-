<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="9e0b5d4a-f91c-4c39-ae6b-1dfbbce50ad3" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for WATERING_CIRCUIT as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="WATERING_CIRCUIT"/>
            </not>
        </preConditions>
        <comment>MO-779: CreateTable WATERING_CIRCUIT</comment>
        <createTable tablespace="MW_OBJ" remarks="Watering Circuits define the areas to be automatically watered." tableName="WATERING_CIRCUIT">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(255)"/>
            <column name="IS_VALID" type="BOOLEAN" remarks="Is this watering circuit valid">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_DATE_UTC" type="DATETIME2" remarks="The watering circuit creation timestamp"/>
            <column name="LAST_UPDATED_DATE_UTC" type="DATETIME2" remarks="The watering circuit updated timestamp"/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="WATERING_CIRCUIT_PK" tablespace="MW_IDXOBJ" tableName="WATERING_CIRCUIT"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="34627b56-8bed-4ca1-86b5-2a2be37bf3cb" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for WATERING_CIRCUIT_LEG as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="WATERING_CIRCUIT_LEG"/>
            </not>
        </preConditions>
        <comment>MO-779: CreateTable WATERING_CIRCUIT_LEG</comment>
        <createTable tablespace="MW_ENT" remarks="The start and end point in the mine model for watering" tableName="WATERING_CIRCUIT_LEG">
            <column name="CIRCUIT_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="LEG_NR" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(255)"/>
            <column name="IS_WATERING" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="IS_VALID" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="MACHINE_CLASS_OID" type="BIGINT"/>
            <column name="START_LANE" type="BIGINT"/>
            <column name="END_LANE" type="BIGINT"/>
            <column name="START_PLAN" type="BIGINT"/>
            <column name="END_PLAN" type="BIGINT"/>
        </createTable>
        <addPrimaryKey columnNames="CIRCUIT_OID,LEG_NR" constraintName="WATERING_CIRCUIT_LEG_PK" tablespace="MW_IDXENT" tableName="WATERING_CIRCUIT_LEG"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="7d10411f-16f7-43d1-b172-6d753f8a9ef1" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_CIRCUI_FK to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="CIRCUIT_OID"/>
            <columnExists tableName="WATERING_CIRCUIT" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_CIRCUI_FK"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_CIRCUI_FK to WATERING_CIRCUIT_LEG (CIRCUIT_OID)</comment>
        <sql>DELETE FROM WATERING_CIRCUIT_LEG WHERE CIRCUIT_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM WATERING_CIRCUIT WHERE WATERING_CIRCUIT.OID = WATERING_CIRCUIT_LEG.CIRCUIT_OID)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="CIRCUIT_OID" constraintName="WATERING_CIRCUIT_LEG_CIRCUI_FK" referencedTableName="WATERING_CIRCUIT" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_CIRCUI_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="c43a7f57-551b-46ab-8701-7c1cce343a22" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_MACHIN_FK to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="MACHINE_CLASS_OID"/>
            <columnExists tableName="MACHINECLASS" columnName="MACHINECLASS_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_MACHIN_FK"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_MACHIN_FK to WATERING_CIRCUIT_LEG (MACHINE_CLASS_OID)</comment>
        <sql>UPDATE WATERING_CIRCUIT_LEG SET MACHINE_CLASS_OID = NULL WHERE MACHINE_CLASS_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINECLASS WHERE MACHINECLASS.MACHINECLASS_OID = WATERING_CIRCUIT_LEG.MACHINE_CLASS_OID)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="MACHINE_CLASS_OID" constraintName="WATERING_CIRCUIT_LEG_MACHIN_FK" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_MACHIN_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="2cdcf0c7-5a73-41eb-b031-1ec938578db6" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_START_FK to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="START_LANE"/>
            <columnExists tableName="LANE" columnName="LANE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_START_FK"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_START_FK to WATERING_CIRCUIT_LEG (START_LANE)</comment>
        <sql>UPDATE WATERING_CIRCUIT_LEG SET START_LANE = NULL WHERE START_LANE IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM LANE WHERE LANE.LANE_OID = WATERING_CIRCUIT_LEG.START_LANE)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="START_LANE" constraintName="WATERING_CIRCUIT_LEG_START_FK" referencedTableName="LANE" referencedColumnNames="LANE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_START_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="b66f1584-65bd-4e8b-9605-9d881db04f65" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_END_LA_FK to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="END_LANE"/>
            <columnExists tableName="LANE" columnName="LANE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_END_LA_FK"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_END_LA_FK to WATERING_CIRCUIT_LEG (END_LANE)</comment>
        <sql>UPDATE WATERING_CIRCUIT_LEG SET END_LANE = NULL WHERE END_LANE IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM LANE WHERE LANE.LANE_OID = WATERING_CIRCUIT_LEG.END_LANE)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="END_LANE" constraintName="WATERING_CIRCUIT_LEG_END_LA_FK" referencedTableName="LANE" referencedColumnNames="LANE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_END_LA_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="05ccfa0c-1737-423f-978c-766510e7248f" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_FK1 to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="START_PLAN"/>
            <columnExists tableName="PLAN_MODEL" columnName="PLAN_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_FK1"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_FK1 to WATERING_CIRCUIT_LEG (START_PLAN)</comment>
        <sql>UPDATE WATERING_CIRCUIT_LEG SET START_PLAN = NULL WHERE START_PLAN IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PLAN_MODEL WHERE PLAN_MODEL.PLAN_OID = WATERING_CIRCUIT_LEG.START_PLAN)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="START_PLAN" constraintName="WATERING_CIRCUIT_LEG_FK1" referencedTableName="PLAN_MODEL" referencedColumnNames="PLAN_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_FK1"/>
        </rollback>
    </changeSet>
    <changeSet id="d204471c-f13d-4e09-af82-b3973113bed9" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for WATERING_CIRCUIT_LEG_END_PL_FK to table WATERING_CIRCUIT_LEG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="WATERING_CIRCUIT_LEG" columnName="END_PLAN"/>
            <columnExists tableName="PLAN_MODEL" columnName="PLAN_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="WATERING_CIRCUIT_LEG" foreignKeyName="WATERING_CIRCUIT_LEG_END_PL_FK"/>
            </not>
        </preConditions>
        <comment>MO-779: AddForeignKeyConstraint WATERING_CIRCUIT_LEG_END_PL_FK to WATERING_CIRCUIT_LEG (END_PLAN)</comment>
        <sql>UPDATE WATERING_CIRCUIT_LEG SET END_PLAN = NULL WHERE END_PLAN IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PLAN_MODEL WHERE PLAN_MODEL.PLAN_OID = WATERING_CIRCUIT_LEG.END_PLAN)</sql>
        <addForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" baseColumnNames="END_PLAN" constraintName="WATERING_CIRCUIT_LEG_END_PL_FK" referencedTableName="PLAN_MODEL" referencedColumnNames="PLAN_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="WATERING_CIRCUIT_LEG" constraintName="WATERING_CIRCUIT_LEG_END_PL_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
