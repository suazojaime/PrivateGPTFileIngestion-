<?xml version="1.0"?>
<!-- Copyright (c) 2018, Caterpillar -->

<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping default-access="field" schema="model">

    <class name="minestar.production.domain.drawcard.ActiveDrawCardImpl"
           proxy="minestar.production.domain.drawcard.ActiveDrawCard"
           table="ACTIVE_DRAW_CARD"
           dynamic-update="true">

        <meta attribute="alias" inherit="false">ACTIVEDRAWCARD</meta>
        <meta attribute="view-master">true</meta>
        <meta attribute="description">A draw card for the current period.</meta>
        <meta attribute="table">
            tablespace=MW_ENT
        </meta>
        <meta attribute="primary-key">
            tablespace=MW_IDXENT
        </meta>

        <cache usage="read-write" region="model"/>

        <id name="OID"
            type="java.lang.Long"
            column="ADC_OID">
            <generator class="com.mincom.env.base.persistence.IDGenerator"/>
        </id>

        <property name="createdDate" type="TimestampType">
            <meta attribute="timestamp">true</meta>
            <meta attribute="utc-description">The utc time the cycle was last updated.</meta>
            <meta attribute="description">The utc time the cycle was last updated.</meta>
            <meta attribute="view-localtime">true</meta>
            <column name="CREATED_DATE_UTC"/>
        </property>

        <property name="lastModified" type="TimestampType">
            <meta attribute="timestamp">true</meta>
            <meta attribute="utc-description">The utc time the cycle was last updated.</meta>
            <meta attribute="description">The utc time the cycle was last updated.</meta>
            <meta attribute="view-localtime">true</meta>
            <column name="LAST_MODIFIED_UTC"/>
        </property>


        <property name="drawCardDate"
                  type="java.util.Date"
                  column="DRAW_CARD_DATE"
                  not-null="true">
            <meta attribute="description">The date that the information in this draw card applies to.</meta>
        </property>

        <many-to-one name="shift"
                     class="minestar.platform.domain.calendar.ShiftImpl"
                     column="SHIFT"
                     not-null="false"
                     lazy="false"
                     unique="true">
            <meta attribute="description">
                A reference to the shift (MSMODEL.SHIFT) that the information in this draw card applies to.
                (Not applicable if this draw card is for the entire day.)
            </meta>
        </many-to-one>

        <map name="importedFileData" table="ADC_IMP_FILE_DATA" lazy="false" cascade="all-delete-orphan">
            <meta attribute="index-alias">importedFileName</meta>
            <meta attribute="description">
                The details of the CSV files that were imported for draw cards for the current period.
            </meta>
            <meta attribute="collection-table">
                tablespace=MW_ENT
            </meta>
            <meta attribute="collection-primary-key">
                tablespace=MW_IDXENT
            </meta>

            <key column="ADC_OID"/>
            <index column="ADC_IMP_FILE_NAME" type="java.lang.String"/>
            <element column="ADC_IMP_DATE_UTC" type="TimestampType"/>
        </map>

        <map name="areaData" lazy="false" inverse="true" cascade="all-delete-orphan">
            <meta attribute="description">The entries in this draw card grouped by underground areas.</meta>
            <meta attribute="collection-table">
                tablespace=MW_ENT
            </meta>
            <meta attribute="collection-primary-key">
                tablespace=MW_IDXENT
            </meta>

            <key column="ADC_OID"/>
            <map-key-many-to-many class="minestar.mine.domain.minemodel.underground.area.UndergroundAreaReference"
                                  column="AREA"/>
            <one-to-many class="minestar.production.domain.drawcard.ActiveDrawCardEntryList"/>
        </map>

    </class>

    <class name="minestar.production.domain.drawcard.ActiveDrawCardEntryList"
           table="ADC_ENTRY_LIST"
           dynamic-update="true">

        <meta attribute="alias" inherit="false">ActiveDrawCardEntryList</meta>
        <meta attribute="description">
            A list of entries in a draw card for the current period that are for draw points within the same underground
            area.
        </meta>
        <meta attribute="table">
            tablespace=MW_ENT
        </meta>
        <meta attribute="primary-key">
            tablespace=MW_IDXENT
        </meta>

        <id name="OID"
            type="java.lang.Long"
            column="ADCL_OID">
            <generator class="com.mincom.env.base.persistence.IDGenerator"/>
        </id>

        <many-to-one name="parent"
                     column="ADC_OID"
                     class="minestar.production.domain.drawcard.ActiveDrawCardImpl"
                     not-null="true">
            <meta attribute="description">
                A reference to the draw card (MSMODEL.ACTIVE_DRAW_CARD) that contains this entry list.
            </meta>
        </many-to-one>

        <many-to-one name="area"
                     class="minestar.mine.domain.minemodel.underground.area.UndergroundAreaReference"
                     column="AREA"
                     not-null="true">
            <meta attribute="description">
                A reference to the underground area (MSMODEL.UNDERGROUND_AREA) that the draw points belong to.
            </meta>
        </many-to-one>

        <map name="entryMap" lazy="false" inverse="true" cascade="all-delete-orphan">
            <meta attribute="description">The entries for draw points within the underground area.</meta>
            <meta attribute="collection-table">
                tablespace=MW_ENT
            </meta>
            <meta attribute="collection-primary-key">
                tablespace=MW_IDXENT
            </meta>

            <key column="ADCL_OID"/>
            <map-key-many-to-many class="minestar.mine.domain.minemodel.underground.drawpoint.DrawPointReference"
                                  column="DRAW_POINT"/>
            <one-to-many class="minestar.production.domain.drawcard.ActiveDrawCardEntry"/>
        </map>
    </class>

    <class name="minestar.production.domain.drawcard.ActiveDrawCardEntry"
           table="ADC_ENTRY"
           dynamic-update="true">

        <meta attribute="alias" inherit="false">ACTIVEDRAWCARDENTRY</meta>
        <meta attribute="description">An entry for a draw point in a draw card for the current period.</meta>
        <meta attribute="table">
            tablespace=MW_ENT
        </meta>
        <meta attribute="primary-key">
            tablespace=MW_IDXENT
        </meta>

        <cache usage="read-write" region="model"/>

        <id name="OID"
            type="java.lang.Long"
            column="ADC_ENTRY_OID">
            <generator class="com.mincom.env.base.persistence.IDGenerator"/>
        </id>

        <many-to-one name="parent"
                     column="ADCL_OID"
                     class="minestar.production.domain.drawcard.ActiveDrawCardEntryList"
                     not-null="true">
            <meta attribute="description">
                A reference to the entry list (MSMODEL.ADC_ENTRY_LIST) in the draw card that contains this entry.
            </meta>
        </many-to-one>

        <many-to-one name="drawPoint"
                     column="DRAW_POINT"
                     class="minestar.mine.domain.minemodel.underground.drawpoint.DrawPointReference"
                     not-null="true">
            <meta attribute="description">
                A reference to the draw point (MSMODEL.DRAW_POINT) that this entry applies to.
            </meta>
        </many-to-one>

        <property name="loadTakenCount"
                  column="LOAD_TAKEN_COUNT"
                  type="java.lang.Integer">
            <meta attribute="description">The number of loads that have been taken from the draw point.</meta>
        </property>

        <property name="taken"
                  column="TAKEN_TONS">
            <meta attribute="description">The amount of ore that has been taken from the draw point.</meta>
            <type name="quantity">
                <param name="unitType">mass</param>
            </type>
        </property>

        <property name="target"
                  column="TARGET_TONS">
            <meta attribute="description">The amount of ore that should be taken from the draw point.</meta>
            <type name="quantity">
                <param name="unitType">mass</param>
            </type>
        </property>

        <property name="extras"
                  column="EXTRA_TONS">
            <meta attribute="description">
                The amount of ore that can be taken from the draw point above the target.
            </meta>
            <type name="quantity">
                <param name="unitType">mass</param>
            </type>
        </property>

        <property name="caveOptimisationIndex"
                  column="CO_INDEX"
                  type="java.lang.Integer">
            <meta attribute="description">The line number of the draw point's entry in the draw card CSV file.</meta>
        </property>

        <property name="sortIndex"
                  column="SORT_INDEX"
                  type="java.lang.Integer">
            <meta attribute="description">The sort index for the draw point used to match pairs for TOPE sorting.</meta>
        </property>

    </class>

</hibernate-mapping>
