<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="66a962ec-57ce-487d-9b7c-0ad2f549afa9" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for AREA_MAP_OID to table UNDERGROUND_PANEL as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="UNDERGROUND_PANEL"/>
            <not>
                <columnExists tableName="UNDERGROUND_PANEL" columnName="AREA_MAP_OID"/>
            </not>
        </preConditions>
        <comment>FUG-310: AddColumn UNDERGROUND_PANEL.AREA_MAP_OID</comment>
        <addColumn tableName="UNDERGROUND_PANEL">
            <column name="AREA_MAP_OID" type="BIGINT" remarks="Area map that the panel is associated with"/>
        </addColumn>
        <rollback>
            <dropColumn tableName="UNDERGROUND_PANEL" columnName="AREA_MAP_OID"/>
        </rollback>
    </changeSet>
    <changeSet id="0855e3ed-949d-476e-b6f3-7b620afe05fd" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for AREA_MAP as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="AREA_MAP"/>
            </not>
        </preConditions>
        <comment>FUG-310: CreateTable AREA_MAP</comment>
        <createTable tablespace="MW_ENT" remarks="Represents a section of the mine site map." tableName="AREA_MAP">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(254)">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether the area map is active or archived">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_MODIFIED_DATE_UTC" type="DATETIME2" remarks="Timestamp of when the area map was last modified by a user">
                <constraints nullable="false"/>
            </column>
            <column name="COMMENTS" type="VARCHAR(255)" remarks="User-entered comments as to why the modification was made"/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="AREA_MAP_PK" tablespace="MW_IDXENT" tableName="AREA_MAP"/>
        <addUniqueConstraint columnNames="NAME" constraintName="AREA_MAP_NAME_UK" tableName="AREA_MAP"/>
        <rollback>
            <dropTable tableName="AREA_MAP"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="62c43ce9-c947-48cc-8221-1282314a4ce7" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for AREA_MAP_POLYGON as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="AREA_MAP_POLYGON"/>
            </not>
        </preConditions>
        <comment>FUG-310: CreateTable AREA_MAP_POLYGON</comment>
        <createTable tablespace="MW_ENT" remarks="The absolute polygon coordinates that form the area map's boundary" tableName="AREA_MAP_POLYGON">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="X_MAGNITUDE" type="DOUBLE"/>
            <column name="Y_MAGNITUDE" type="DOUBLE"/>
            <column name="Z_MAGNITUDE" type="DOUBLE"/>
            <column name="POINT_NR" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,POINT_NR" constraintName="AREA_MAP_POLYGON_PK" tablespace="MW_IDXENT" tableName="AREA_MAP_POLYGON"/>
        <rollback>
            <dropTable tableName="AREA_MAP_POLYGON"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="3d966fb9-2de0-442b-9db2-bad73ebf22b6" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for AREA_MAP_POLYGON_OID_FK to table AREA_MAP_POLYGON as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="AREA_MAP_POLYGON"/>
            <tableExists tableName="AREA_MAP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="AREA_MAP_POLYGON" foreignKeyName="AREA_MAP_POLYGON_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-310: AddForeignKeyConstraint AREA_MAP_POLYGON_OID_FK to AREA_MAP_POLYGON (OID)</comment>
        <sql>DELETE FROM AREA_MAP_POLYGON WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM AREA_MAP WHERE AREA_MAP.OID = AREA_MAP_POLYGON.OID)</sql>
        <addForeignKeyConstraint baseTableName="AREA_MAP_POLYGON" baseColumnNames="OID" constraintName="AREA_MAP_POLYGON_OID_FK" referencedTableName="AREA_MAP" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="AREA_MAP_POLYGON" constraintName="AREA_MAP_POLYGON_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="480a76b0-2ebd-4b9f-b1e8-029b8c64e2ef" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for UNDERGROUND_PANEL_AREA_MAP_FK to table UNDERGROUND_PANEL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="UNDERGROUND_PANEL"/>
            <tableExists tableName="AREA_MAP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="UNDERGROUND_PANEL" foreignKeyName="UNDERGROUND_PANEL_AREA_MAP_FK"/>
            </not>
        </preConditions>
        <comment>FUG-310: AddForeignKeyConstraint UNDERGROUND_PANEL_AREA_MAP_FK to UNDERGROUND_PANEL (AREA_MAP_OID)</comment>
        <sql>UPDATE UNDERGROUND_PANEL SET AREA_MAP_OID = NULL WHERE AREA_MAP_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM AREA_MAP WHERE AREA_MAP.OID = UNDERGROUND_PANEL.AREA_MAP_OID)</sql>
        <addForeignKeyConstraint baseTableName="UNDERGROUND_PANEL" baseColumnNames="AREA_MAP_OID" constraintName="UNDERGROUND_PANEL_AREA_MAP_FK" referencedTableName="AREA_MAP" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="UNDERGROUND_PANEL" constraintName="UNDERGROUND_PANEL_AREA_MAP_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
