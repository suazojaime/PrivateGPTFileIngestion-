<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2017, Caterpillar, Brisbane Australia. All rights reserved. -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!--If the DELAY_GROUP_ELEMENT.IDX column does not exits, drop the DELAY_GROUP_ELEMENT table-->
    <changeSet id="32eeea4e-c8cc-47b5-91dd-323820692fe5" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored drop table DELAY_GROUP_ELEMENT as column IDX already exists." onFail="MARK_RAN">
            <tableExists tableName="DELAY_GROUP_ELEMENT"/>
            <not>
                <columnExists tableName="DELAY_GROUP_ELEMENT" columnName="IDX"/>
            </not>
        </preConditions>
        <comment>FLT-6427: Drop Table DELAY_GROUP_ELEMENT</comment>
        <dropTable tableName="DELAY_GROUP_ELEMENT"/>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <!--If the DELAY_GROUP_SUBDIR.IDX column does not exits, drop the DELAY_GROUP_SUBDIR table-->
    <changeSet id="f84625b6-38e0-4466-a012-1ce14913ee31" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored drop table DELAY_GROUP_SUBDIR as column IDX already exists." onFail="MARK_RAN">
            <tableExists tableName="DELAY_GROUP_SUBDIR"/>
            <not>
                <columnExists tableName="DELAY_GROUP_SUBDIR" columnName="IDX"/>
            </not>
        </preConditions>
        <comment>FLT-6427: Drop Table DELAY_GROUP_SUBDIR</comment>
        <dropTable tableName="DELAY_GROUP_SUBDIR"/>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <!--If the DELAY_GROUP_ELEMENT table does not exits, create -->
    <changeSet id="8388313e-70c9-4d8a-9b63-02d42068bb23" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for DELAY_GROUP_ELEMENT as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="DELAY_GROUP_ELEMENT"/>
            </not>
        </preConditions>
        <comment>FLT-6427: CreateTable DELAY_GROUP_ELEMENT</comment>
        <createTable tablespace="MW_ENT" remarks="The elements for this delay group." tableName="DELAY_GROUP_ELEMENT">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="IDX" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="DELAY_CLASS_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,IDX" constraintName="DELAY_GROUP_ELEMENT_PK" tablespace="MW_IDXENT" tableName="DELAY_GROUP_ELEMENT"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!--If the DELAY_GROUP_SUBDIR table does not exits, create -->
    <changeSet id="25c58e3f-2455-457b-ad5e-b42eb4b70cba" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for DELAY_GROUP_SUBDIR as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="DELAY_GROUP_SUBDIR"/>
            </not>
        </preConditions>
        <comment>FLT-6427: CreateTable DELAY_GROUP_SUBDIR</comment>
        <createTable tablespace="MW_ENT" remarks="The subdirectories for this delay group." tableName="DELAY_GROUP_SUBDIR">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="IDX" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="DELAY_GROUP_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,IDX" constraintName="DELAY_GROUP_SUBDIR_PK" tablespace="MW_IDXENT" tableName="DELAY_GROUP_SUBDIR"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!--If the Foreign Key Constraint DELAY_GROUP_ELEMENT.DELAY_GROUP_ELEMENT_DELAY_C_FK does not exits, create-->
    <changeSet id="beada4a4-e1df-4597-810a-3660a5eb9fb2" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for DELAY_GROUP_ELEMENT_DELAY_C_FK to table DELAY_GROUP_ELEMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="DELAY_GROUP_ELEMENT" columnName="DELAY_CLASS_OID"/>
            <columnExists tableName="DELAYCLASS" columnName="DELAYCLASS_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DELAY_GROUP_ELEMENT" foreignKeyName="DELAY_GROUP_ELEMENT_DELAY_C_FK"/>
            </not>
        </preConditions>
        <comment>FLT-6427: AddForeignKeyConstraint DELAY_GROUP_ELEMENT_DELAY_C_FK to DELAY_GROUP_ELEMENT(DELAY_CLASS_OID)</comment>
        <sql>DELETE FROM DELAY_GROUP_ELEMENT WHERE DELAY_CLASS_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM
            DELAYCLASS WHERE DELAYCLASS.DELAYCLASS_OID = DELAY_GROUP_ELEMENT.DELAY_CLASS_OID)
        </sql>
        <addForeignKeyConstraint baseTableName="DELAY_GROUP_ELEMENT" baseColumnNames="DELAY_CLASS_OID"
                                 constraintName="DELAY_GROUP_ELEMENT_DELAY_C_FK" referencedTableName="DELAYCLASS"
                                 referencedColumnNames="DELAYCLASS_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DELAY_GROUP_ELEMENT" constraintName="DELAY_GROUP_ELEMENT_DELAY_C_FK"/>
        </rollback>
    </changeSet>

    <!--If the Foreign Key Constraint DELAY_GROUP_ELEMENT.DELAY_GROUP_ELEMENT_OID_FK does not exits, create-->
    <changeSet id="ef7b668a-d955-4247-a617-75541fa8fffe" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for DELAY_GROUP_ELEMENT_OID_FK to table DELAY_GROUP_ELEMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="DELAY_GROUP_ELEMENT" columnName="OID"/>
            <columnExists tableName="DELAY_GROUP" columnName="DELAY_GROUP_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DELAY_GROUP_ELEMENT" foreignKeyName="DELAY_GROUP_ELEMENT_OID_FK"/>
            </not>
        </preConditions>
        <comment>FLT-6427: AddForeignKeyConstraint DELAY_GROUP_ELEMENT_OID_FK to DELAY_GROUP_ELEMENT (OID)</comment>
        <sql>DELETE FROM DELAY_GROUP_ELEMENT WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM DELAY_GROUP WHERE
            DELAY_GROUP.DELAY_GROUP_OID = DELAY_GROUP_ELEMENT.OID)
        </sql>
        <addForeignKeyConstraint baseTableName="DELAY_GROUP_ELEMENT" baseColumnNames="OID"
                                 constraintName="DELAY_GROUP_ELEMENT_OID_FK" referencedTableName="DELAY_GROUP"
                                 referencedColumnNames="DELAY_GROUP_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DELAY_GROUP_ELEMENT" constraintName="DELAY_GROUP_ELEMENT_OID_FK"/>
        </rollback>
    </changeSet>

    <!--If the Foreign Key Constraint DELAY_GROUP_SUBDIR.DELAY_GROUP_SUBDIR_DELAY_GR_FK does not exits, create-->
    <changeSet id="75ad38c8-7b6b-4211-8815-cda25bcec00e" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for DELAY_GROUP_SUBDIR_DELAY_GR_FK to table DELAY_GROUP_SUBDIR as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="DELAY_GROUP_SUBDIR" columnName="DELAY_GROUP_OID"/>
            <columnExists tableName="DELAY_GROUP" columnName="DELAY_GROUP_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DELAY_GROUP_SUBDIR" foreignKeyName="DELAY_GROUP_SUBDIR_DELAY_GR_FK"/>
            </not>
        </preConditions>
        <comment>FLT-6427: AddForeignKeyConstraint DELAY_GROUP_SUBDIR_DELAY_GR_FK to DELAY_GROUP_SUBDIR (DELAY_GROUP_OID)</comment>
        <sql>DELETE FROM DELAY_GROUP_SUBDIR WHERE DELAY_GROUP_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM DELAY_GROUP WHERE DELAY_GROUP.DELAY_GROUP_OID = DELAY_GROUP_SUBDIR.DELAY_GROUP_OID)</sql>
        <addForeignKeyConstraint baseTableName="DELAY_GROUP_SUBDIR" baseColumnNames="DELAY_GROUP_OID"
                                 constraintName="DELAY_GROUP_SUBDIR_DELAY_GR_FK" referencedTableName="DELAY_GROUP"
                                 referencedColumnNames="DELAY_GROUP_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DELAY_GROUP_SUBDIR" constraintName="DELAY_GROUP_SUBDIR_DELAY_GR_FK"/>
        </rollback>
    </changeSet>

    <!--If the Foreign Key Constraint DELAY_GROUP_SUBDIR.DELAY_GROUP_SUBDIR_OID_FK does not exits, create-->
    <changeSet id="23769b0c-a360-44be-a2bf-954ac2fa61e4" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for DELAY_GROUP_SUBDIR_OID_FK to table DELAY_GROUP_SUBDIR as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="DELAY_GROUP_SUBDIR" columnName="OID"/>
            <columnExists tableName="DELAY_GROUP" columnName="DELAY_GROUP_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DELAY_GROUP_SUBDIR" foreignKeyName="DELAY_GROUP_SUBDIR_OID_FK"/>
            </not>
        </preConditions>
        <comment>FLT-6427: AddForeignKeyConstraint DELAY_GROUP_SUBDIR_OID_FK to DELAY_GROUP_SUBDIR (OID)</comment>
        <sql>DELETE FROM DELAY_GROUP_SUBDIR WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM DELAY_GROUP WHERE DELAY_GROUP.DELAY_GROUP_OID = DELAY_GROUP_SUBDIR.OID)</sql>
        <addForeignKeyConstraint baseTableName="DELAY_GROUP_SUBDIR" baseColumnNames="OID"
                                 constraintName="DELAY_GROUP_SUBDIR_OID_FK" referencedTableName="DELAY_GROUP"
                                 referencedColumnNames="DELAY_GROUP_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DELAY_GROUP_SUBDIR" constraintName="DELAY_GROUP_SUBDIR_OID_FK"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
