<?xml version="1.0"?>
<!-- Copyright (c) 2022 Caterpillar -->

<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping schema="model" default-access="field" default-lazy="false">

    <class name="minestar.mine.domain.minemodel.GenericLock"
           table="LOCKING"
           abstract="true"
           dynamic-update="true"
           proxy="minestar.mine.domain.minemodel.GenericLock">

        <meta attribute="table">
            tablespace=MW_ENT
        </meta>
        <meta attribute="primary-key">
            tablespace=MW_IDXENT
        </meta>

        <!-- Filtered unique index on ZONE -->
        <meta attribute="index">
            name=LOCKING_ZONE
            unique=true
            columns=ZONE
        </meta>
        <!-- Filtered unique index on LANE -->
        <meta attribute="index">
            name=LOCKING_LANE
            unique=true
            columns=LANE
        </meta>
        <!-- Filtered unique index on MACHINE -->
        <meta attribute="index">
            name=LOCKING_MACHINE
            unique=true
            columns=MACHINE
        </meta>

        <meta attribute="description">A generic lock.</meta>
        <cache usage="read-write" region="model"/>

        <id name="OID"
            type="java.lang.Long"
            column="LOCK_OID">
            <generator class="assigned"/>
        </id>

        <discriminator column="DISCRIMINATOR_ID"/>

        <property name="timeCreated"
                  type="TimestampType">
            <meta attribute="utc-description">The utc time that this lock was created.</meta>
            <meta attribute="description">The time that this lock was created.</meta>
            <meta attribute="view-localtime">true</meta>
            <column name="TIME_CREATED_UTC" not-null="true" default="01-JAN-1970"/>
        </property>

        <property name="committed"
                  type="boolean"
                  column="IS_COMMITTED"
                  not-null="true">
                <meta attribute="defaultValue">true</meta>
                <meta attribute="description">Is this lock committed.</meta>
        </property>

        <property name="timeCommitted"
                  type="TimestampType"
                  column="TIME_COMMITTED_UTC">
            <meta attribute="utc-description">If this lock was committed, the utc time this lock was committed.</meta>
            <meta attribute="description">If this lock was committed, the time this lock was committed.</meta>
            <meta attribute="view-localtime">true</meta>
        </property>

        <property name="estimatedRelease"
                  type="TimestampType"
                  column="ESTIMATED_RELEASE_UTC">
            <meta attribute="utc-description">The latest expected utc time that this lock will be released.</meta>
            <meta attribute="description">The latest expected time that this lock will be released.</meta>
            <meta attribute="view-localtime">true</meta>
        </property>

        <map name="userLocks"
             table="GENERIC_USER_LOCKS"
             lazy="false">
            <meta attribute="collection-table">
                tablespace=MW_ENT
            </meta>
            <meta attribute="collection-primary-key">
                tablespace=MW_IDXENT
                columns=OID,USER_ID,USER_TYPE
            </meta>

            <meta attribute="description">The information about each user lock.</meta>

            <cache usage="read-write" region="model"/>

            <key column="OID" not-null="true"/>
            <composite-map-key class="minestar.autonomy.service.lock.LockUser">
                <key-property name="userId"
                          type="java.lang.Long"
                          column="USER_ID">
                    <meta attribute="description">The unique identifier of the locking entity.</meta>
                </key-property>
                <key-property name="userType"
                          type="minestar.mine.persistence.minemodel.UserTypeEnumUserType"
                          column="USER_TYPE">
                    <meta attribute="defaultValue">UNKNOWN</meta>
                    <meta attribute="description">The type of the locking entity.</meta>
                </key-property>
                <key-property name="userName"
                          type="java.lang.String"
                          column="USER_NAME">
                    <meta attribute="description">The name of the locking entity.</meta>
                </key-property>
            </composite-map-key>
            <composite-element class="minestar.autonomy.service.lock.LockReasonAndTime">
                <property name="reason"
                          type="minestar.mine.persistence.minemodel.LockReasonEnumUserType"
                          column="REASON"
                          not-null="true">
                    <meta attribute="defaultValue">UNKNOWN</meta>
                    <meta attribute="description">The reason for the lock being taken.</meta>
                </property>
                <property name="timeTaken"
                          type="TimestampType">
                    <meta attribute="utc-description">The utc time this lock was created.</meta>
                    <meta attribute="description">The time this lock was created.</meta>
                    <meta attribute="view-localtime">true</meta>
                    <column name="TIME_TAKEN_UTC" not-null="true" default="01-JAN-1970"/>
                </property>
                <property name="sourceId"
                          type="java.lang.Long"
                          column="SOURCE_ID">
                    <meta attribute="description">The unique identifier of the aux machine that locked the entity.</meta>
                </property>
            </composite-element>
        </map>

        <subclass name="minestar.mine.domain.minemodel.EntityLock" discriminator-value="EntityLockImpl">
            <meta attribute="description">
                A lock on an entity.
            </meta>

            <property name="entityRevision" type="long">
                <meta attribute="description">The revision of the entity when it was locked.</meta>
                <column name="ENTITY_REVISION" not-null="true" default="0"/>
            </property>

            <property name="layerUpdateVersion" type="long">
                <meta attribute="description">The LayerUpdateVersion of the MS_LOCKS layer when the lock was last modified.</meta>
                <column name="LAYER_UPDATE_VERSION" not-null="true" default="0"/>
            </property>

            <subclass name="minestar.mine.domain.minemodel.AreaLock" discriminator-value="AreaLockImpl">
                <meta attribute="description">
                    A lock on a specific area.
                </meta>

                <many-to-one name="zoneRef"
                             class="minestar.mine.domain.minemodel.ZoneReference"
                             column="ZONE"
                             lazy="false">
                    <meta attribute="description">The zone associated with this lock.</meta>
                </many-to-one>

            </subclass>

            <subclass name="minestar.mine.domain.minemodel.LaneLock" discriminator-value="LaneLockImpl">
                <meta attribute="description">
                    A lock on a lane.
                </meta>

                <many-to-one name="laneRef"
                             class="minestar.mine.domain.minemodel.LaneReference"
                             column="LANE"
                             lazy="false">
                    <meta attribute="description">The lane that is locked.</meta>
                </many-to-one>
            </subclass>

            <subclass name="minestar.mine.domain.minemodel.MachineLock" discriminator-value="MachineLockImpl">
                <meta attribute="description">
                    A lock on a machine.
                </meta>

                <many-to-one name="machineRef"
                             class="minestar.pitlink.domain.machine.MachineReference"
                             column="MACHINE"
                             lazy="false">
                    <meta attribute="description">The machine that is locked.</meta>
                </many-to-one>
            </subclass>
        </subclass>

        <subclass name="minestar.mine.domain.minemodel.SiteLock" discriminator-value="SiteLockImpl">
            <meta attribute="description">
                A lock on the entire site.
            </meta>
        </subclass>        
        
        <subclass name="minestar.mine.domain.minemodel.SatsSiteLock" discriminator-value="SatsSiteLock">
            <meta attribute="description">
                A lock on the entire site.
            </meta>
        </subclass>

    </class>

</hibernate-mapping>
