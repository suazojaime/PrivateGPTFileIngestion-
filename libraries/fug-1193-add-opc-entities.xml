<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="33c4f547-7a9d-42e1-9952-0f2ca1690019" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for OPC_DATA as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="OPC_DATA"/>
            </not>
        </preConditions>
        <comment>FUG-1193: CreateTable OPC_DATA</comment>
        <createTable tablespace="MW_ENT" remarks="OPC-UA Data entities." tableName="OPC_DATA">
            <column name="OPCDATA_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="CONNECTION_OID" type="BIGINT" remarks="A reference to the OPC Connection (MSMODEL.OPC_CONNECTION) that manages this data entity."/>
            <column name="NODEID" type="VARCHAR(254)" remarks="The OPC-UA server's unique identifier of this OPC node."/>
            <column name="NAME" type="VARCHAR(254)" remarks="The unique, user-entered identifier for this connection."/>
            <column name="LAST_UPDATE_TIME" type="DATETIME2" remarks="The last time the entity value was updated."/>
            <column name="STATUS" type="BIGINT" remarks="The OPC-UA status code of the last recorded value."/>
            <column name="VALUE" type="VARCHAR(255)" remarks="The last-known value of the OPC-UA node."/>
            <column name="NUMERIC_VALUE" type="BLOB" remarks="The last-known numeric value of the OPC-UA node."/>
        </createTable>
        <addPrimaryKey columnNames="OPCDATA_OID" constraintName="OPC_DATA_PK" tablespace="MW_IDXENT" tableName="OPC_DATA"/>
        <createIndex unique="true" tablespace="MW_IDXENT" tableName="OPC_DATA" indexName="OPCDATA_NODEID">
            <column name="NODEID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="3aa42b0f-3ee1-4956-8c99-33c83c6c709f" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for NAMESPACE to table OPC_DATA as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="OPC_DATA"/>
            <not>
                <columnExists tableName="OPC_DATA" columnName="NAMESPACE"/>
            </not>
        </preConditions>
        <comment>FUG-1193: AddColumn OPC_DATA.NAMESPACE</comment>
        <addColumn tableName="OPC_DATA">
            <column name="NAMESPACE" type="VARCHAR(254)" remarks="The OPC namespace identifier for this OPC node."/>
        </addColumn>
    </changeSet>
    <changeSet id="4af2e259-db04-463a-8794-ff48fdddaa29" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for CONNECTION_OID of table OPC_DATA as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="OPC_DATA" columnName="CONNECTION_OID"/>
        </preConditions>
        <comment>FUG-1193: DropColumn OPC_DATA.CONNECTION_OID</comment>
        <dropColumn columnName="CONNECTION_OID" tableName="OPC_DATA"/>
        <rollback>
            <addColumn tableName="OPC_DATA">
                <column name="CONNECTION_OID" type="BIGINT" remarks="A reference to the OPC Connection (MSMODEL.OPC_CONNECTION) that manages this data entity."/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="8cc062d8-4a4a-400e-9550-66f750e0e85e" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CONNECTION_NAME to table OPC_DATA as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="OPC_DATA"/>
            <not>
                <columnExists tableName="OPC_DATA" columnName="CONNECTION_NAME"/>
            </not>
        </preConditions>
        <comment>FUG-1193: AddColumn OPC_DATA.CONNECTION_NAME</comment>
        <addColumn tableName="OPC_DATA">
            <column name="CONNECTION_NAME" type="VARCHAR(254)" remarks="A reference to the OPC Connection external task name that manages this data entity."/>
        </addColumn>
    </changeSet>
</databaseChangeLog>
