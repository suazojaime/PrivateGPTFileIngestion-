<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="26710195-a7c3-4e3b-a93e-ba24407c2c7c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for MATERIALMIX.NAME as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="MATERIALMIX" columnName="NAME"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to MATERIALMIX.NAME</comment>
        <dropIndex tableName="MATERIALMIX" indexName="MATERIALMIX_NAME"/>
        <addNotNullConstraint columnName="NAME" columnDataType="VARCHAR(254)" tableName="MATERIALMIX"/>
        <createIndex tableName="MATERIALMIX" indexName="MATERIALMIX_NAME" unique="true">
            <column name="NAME"/>
        </createIndex>
        <rollback>
            <dropNotNullConstraint tableName="MATERIALMIX" columnName="NAME" columnDataType="VARCHAR(254)"/>
        </rollback>
    </changeSet>

    <changeSet id="145da01b-c74a-4615-b7bf-f62958db7452" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropNotNullConstraint for MATERIAL.MATERIALGROUP as column does not exist or is already nullable" onFail="MARK_RAN">
            <ext:columnIsNotNullable tableName="MATERIAL" columnName="MATERIALGROUP"/>
        </preConditions>
        <comment>AHS-7648: DropNotNullConstraint from MATERIAL.MATERIALGROUP</comment>
        <dropNotNullConstraint tableName="MATERIAL" columnName="MATERIALGROUP" columnDataType="BIGINT"/>
    </changeSet>

    <!--  !!!!! DELETE EVERYTHING BELOW THIS LINE AFTER THE NEXT 5.1 RELEASE !!!!! -->

    <changeSet id="79398a90-3498-4a1b-82d7-9101a3c9bab6" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for MATERIALGROUP to table MATERIAL as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL"/>
            <not>
                <columnExists tableName="MATERIAL" columnName="MATERIALGROUP"/>
            </not>
        </preConditions>
        <comment>AHS-7648: AddColumn MATERIAL.MATERIALGROUP</comment>
        <addColumn tableName="MATERIAL">
            <column name="MATERIALGROUP" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <changeSet id="20924e88-8011-4d5a-b8c4-5fa40a941dc0" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for MATERIAL_GROUP_ELEMENT as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL_GROUP_ELEMENT"/>
        </preConditions>
        <comment>AHS-7648: DropTable MATERIAL_GROUP_ELEMENT</comment>
        <sql>UPDATE MATERIAL SET MATERIALGROUP = (SELECT MIN(MATERIAL_GROUP_OID) FROM MATERIAL_GROUP_ELEMENT WHERE MATERIAL_GROUP_ELEMENT.MATERIAL_OID = MATERIAL.MATERIAL_OID) WHERE MATERIAL.MATERIALGROUP IS NULL</sql>
        <dropTable tableName="MATERIAL_GROUP_ELEMENT"/>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <changeSet id="78a0f4a3-5d33-45f6-b05d-a524d819a451" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MATERIAL_MATERIALGROUP_FK to table MATERIAL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL"/>
            <tableExists tableName="MATERIAL_GROUP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MATERIAL" foreignKeyName="MATERIAL_MATERIALGROUP_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7648: AddForeignKeyConstraint MATERIAL_MATERIALGROUP_FK to MATERIAL (MATERIALGROUP)</comment>
        <addForeignKeyConstraint baseTableName="MATERIAL" baseColumnNames="MATERIALGROUP" constraintName="MATERIAL_MATERIALGROUP_FK" referencedTableName="MATERIAL_GROUP" referencedColumnNames="MATERIAL_GROUP_OID" onDelete="NO ACTION"/>
    </changeSet>

    <changeSet id="6fc6f310-54ed-460f-9324-dba97d500a4b" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for PARENT_GROUP_OID to table MATERIAL_GROUP as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL_GROUP"/>
            <not>
                <columnExists tableName="MATERIAL_GROUP" columnName="PARENT_GROUP_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7648: AddColumn MATERIAL_GROUP.PARENT_GROUP_OID</comment>
        <addColumn tableName="MATERIAL_GROUP">
            <column name="PARENT_GROUP_OID" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <changeSet id="0de49788-ef1b-4e69-a9fc-38a3218bb1b9" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for MATERIAL_GROUP_SUBDIR as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL_GROUP_SUBDIR"/>
        </preConditions>
        <comment>AHS-7648: DropTable MATERIAL_GROUP_SUBDIR</comment>
        <sql>UPDATE MATERIAL_GROUP SET PARENT_GROUP_OID = (SELECT MIN(MATERIAL_GROUP_OID) FROM MATERIAL_GROUP_SUBDIR WHERE CHILD_GROUP_OID = MATERIAL_GROUP.MATERIAL_GROUP_OID) WHERE MATERIAL_GROUP.PARENT_GROUP_OID IS NULL</sql>
        <dropTable tableName="MATERIAL_GROUP_SUBDIR"/>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <changeSet id="09b12b5f-c41b-4e13-b9f8-2ceba7541e51" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MATERIAL_GROUP_PARENT_GROUP_FK to table MATERIAL_GROUP as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="MATERIAL_GROUP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MATERIAL_GROUP" foreignKeyName="MATERIAL_GROUP_PARENT_GROUP_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7648: AddForeignKeyConstraint MATERIAL_GROUP_PARENT_GROUP_FK to MATERIAL_GROUP (PARENT_GROUP_OID)</comment>
        <addForeignKeyConstraint baseTableName="MATERIAL_GROUP" baseColumnNames="PARENT_GROUP_OID" constraintName="MATERIAL_GROUP_PARENT_GROUP_FK" referencedTableName="MATERIAL_GROUP" referencedColumnNames="MATERIAL_GROUP_OID" onDelete="NO ACTION"/>
    </changeSet>

</databaseChangeLog>
