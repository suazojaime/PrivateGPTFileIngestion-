<?xml version="1.0"?>
<kpiSummaries>

    <fact name="main">
        <measure if="loader" name="nominalLoadingDuration" expr="cycle.primaryMachine.machineClass.loadingTimes.getNominalLoadingTime(secondaryMachine.classOID)" unitType="duration" category="activity"/>
        <measure if="loader" name="loadingEfficiency" expr="main.nominalLoadingDuration*100/main.loadingDuration if main.loadingDuration else 0" unitType="ratio" category="activity" desc="For Dynamic shovel productivity kpi"/>
        <detail name="quarterHourInShift" expr="1.0 + int((main.endTime.getTime() - calendar.shiftStartTime.getTime() - 1000) // 900000)" type="java.lang.Double" />
    </fact>

    <realtimeKpi if="loader" name="loadingToolProductivity" fact="main" persisted="true" desc="For Dynamic loading tool productivity service" reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="machineOID"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingEfficiency"/>
            <measureRef name="loadingDuration"/>
            <measureRef name="nominalLoadingDuration"/>
        </measures>
        <kpis>
            <kpi if="main.ic == main.tc" name="productivity" stat="weighted" unitType="ratio" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="loadingEfficiency"/>
            </kpi>
            <kpi name="_loadingDurationByLoadingToolForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="_nominalLoadingDurationByLoadingToolForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="nominalLoadingDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="byLoadingToolForPeriod" if="kpi._loadingDurationByLoadingToolForPeriod > 0"
                              expr="kpi._nominalLoadingDurationByLoadingToolForPeriod * 100 / kpi._loadingDurationByLoadingToolForPeriod" unit="percent" unitType = "ratio"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="roadSegmentPerformance" persisted="true" desc="For Dynamic travel time service" reserved="true">
        <population set="cycle.roads" context="seg" />
        <timestamp>
            <detail name="endTime" expr="seg.endTime" type="java.util.Date" />
        </timestamp>
        <dimensions>
            <detail name="roadSegment" expr="seg.roadOID" type="java.lang.Long"/>
            <detail name="truckClass" expr="cycle.primaryMachineClassOID" type="java.lang.Long"/>
            <detail name="loadStateDirection" expr="seg.loadStateDirection" />
        </dimensions>
        <measures>
            <measure name="travelTimeDuration" expr="seg.travelTimeDuration" unitType="duration"/>
            <measure name="targetTravelDuration" expr="seg.targetTravelDuration" unitType="duration"/>
            <measure name="expectedTravelDuration" expr="seg.expectedTravelDuration" unitType="duration"/>
        </measures>
        <kpis>
            <kpi name="travelTime" if="not seg.isPredicted()" stat="weighted" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="travelTimeDuration"/>
                <parameter name="target" valueRef="targetTravelDuration"/>
                <parameter name="altTarget" valueRef="expectedTravelDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="tonsMined" fact="main" persisted="true" desc="For FUA status line" reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="primeForShift" if="main.rehandle == 0" stat="sum" type="shift" label="Prime" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="rehandleForShift" if="main.rehandle" stat="sum" type="shift" label="Rehandle" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="totalForShift" stat="sum" type="shift" label="Total" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loadHaulDump" name="lhdTonsMined" fact="main" persisted="true" desc="For KPI dashboard" reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="totalForShift" stat="sum" type="shift" label="Total" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="tonsMovedPerProductionArc" fact="main" persisted="true" desc="For Assignment Decision Support" reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="sourceDestination" dimension="destination">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <dimensionRef name="sinkDestination" dimension="destination">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <dimensionRef name="loaderMaterial" dimension="material">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>

        <kpis>
            <kpi name="tonsMoved" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="freePercent" fact="main" persisted="true" desc="For FUA status line" reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <measures>
            <measureRef name="freeDestPercent"/>
            <measureRef name="freeGrpDestPercent"/>
        </measures>
        <kpis>
            <kpi name="averageFreeDestPercentForShift" stat="mean" type="shift" label="FreeDestPercent" unitType="ratio" active="true">
                <parameter name="measure" valueRef="freeDestPercent"/>
            </kpi>
            <kpi name="averageFreeGrpDestPercentForShift" stat="mean" type="shift" label="FreeGrpDestPercent" unitType="ratio" active="true">
                <parameter name="measure" valueRef="freeGrpDestPercent"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="tkphMassDistance" fact="main" persisted="true" desc="For assignment, accumulate mass distance for cycles within a time period" reserved="false">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="tkphMassDistanceFront"/>
            <measureRef name="tkphMassDistanceRear"/>
            <measureRef name="cycleDuration"/>
        </measures>
        <kpis>
            <kpi name="massDistanceFrontForPeriod" stat="sum" unitType="mass distance" active="true">
                <parameter name="period" value="4" unit="hour" unitType="duration"/>
                <parameter name="measure" valueRef="tkphMassDistanceFront"/>
            </kpi>
            <kpi name="massDistanceRearForPeriod" stat="sum" unitType="mass distance" active="true">
                <parameter name="period" value="4" unit="hour" unitType="duration"/>
                <parameter name="measure" valueRef="tkphMassDistanceRear"/>
            </kpi>
            <kpi name="cycleDurationForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="4" unit="hour" unitType="duration"/>
                <parameter name="measure" valueRef="cycleDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolLoadTime" fact="main" persisted="true" desc="LoadingTool load time">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="secondaryMachine" dimension="machine">
                <dimensionAttributeRef name="className"/>
            </dimensionRef>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingDuration"/>
        </measures>
        <kpis>
            <kpi name="byLoadingToolByTruckClassForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="byLoadingToolByTruckClassForShift" stat="sum" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <rolledupKpi name="byTruckClassForPeriod" rollupOf="byLoadingToolByTruckClassForPeriod" />
            <rolledupKpi name="byTruckClassForShift" rollupOf="byLoadingToolByTruckClassForShift" />
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolActivity" fact="main" machineType="loadingTool" persisted="true" desc="Activity Kpis">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingDuration"/>
            <measureRef name="hangTimeDuration"/>
        </measures>
        <kpis>
            <kpi name="loadingTime" stat="weighted" label="Loading Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="hangTime" stat="weighted" label="Hang Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="hangTimeDuration"/>
            </kpi>
            <kpi name="loadingTimeByLoadingToolForShift" stat="sum" label="Loading Time/Shift" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="hangTimeByLoadingToolForShift" stat="sum" label="Hang Time/Shift" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="hangTimeDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolCycleInfo" fact="main" machineType="loadingTool" persisted="true" desc="Loading tool cycle info">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="cycleDuration"/>
        </measures>
        <kpis>
            <kpi name="lastCycleTime" if="main.completedCycleCount == 1" stat="weighted" label="Last Cycle Time" unitType="duration" active="true">
                <parameter name="weights" value="100" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="cycleDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="loadingToolAssocCycleInfo" fact="main" machineType="truck" persisted="true" desc="Avg Truck Cycle Duration per Loader">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="secondaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="completedCycleCount"/>
            <measureRef name="completedCycleDuration"/>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="_completedCycleCountByLoadingTool" stat="sum" type="shift" label="Truck cycle completed cycle count" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <kpi name="_truckCycleDurationByLoadingTool" stat="sum" type="shift" label="Truck cycle duration" unitType="duration">
                <parameter name="measure" valueRef="completedCycleDuration"/>
            </kpi>
            <kpi name="_truckCyclePayloadByLoadingTool" stat="sum" type="shift" label="Loading tool associated cycle payload" unitType="mass">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_loadingToolDestMessage" stat="sum" type="shift" label="Truck Loaded and sent to Destination " unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <rolledupKpi name="_completedCycleCountForLoader" rollupOf="_completedCycleCountByLoadingTool" />
            <rolledupKpi name="_truckCycleDurationForLoadingTool" rollupOf="_truckCycleDurationByLoadingTool" />
            <rolledupKpi name="_truckCyclePayloadForLoadingTool" rollupOf="_truckCyclePayloadByLoadingTool" />
        </kpis>
    <calculatedMembers>
            <calculatedMember name="averageTruckCycleDurationByLoadingTool"
                              if="kpi._completedCycleCountByLoadingTool &gt; 0"
                              expr="kpi._truckCycleDurationByLoadingTool / kpi._completedCycleCountByLoadingTool"
                              unitType="duration"/>
        <calculatedMember name="averageTruckCyclePayloadByLoadingTool"
                          if="kpi._completedCycleCountByLoadingTool &gt; 0"
                          expr="kpi._truckCyclePayloadByLoadingTool / kpi._completedCycleCountByLoadingTool"
                          unitType="mass"/>
    </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loaderHourlyHangAndQueueTime" fact="main" machineType="loadingTool" persisted="true" desc="Loader info for shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <detailRef name="hourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="hangTimeDurCompleted"/>
            <measureRef name="completedCycleCount"/>
            <measureRef name="truckQueueDurCmplCycle"/>
        </measures>
        <kpis>
            <kpi name="totalHangTimeForPeriodByLoadingTime" stat="sum" type="shift" label="Loader hang time for current shift hour" unitType="duration">
                <parameter name="measure" valueRef="hangTimeDurCompleted"/>
            </kpi>
            <kpi name="totalTruckQueueTimeForPeriodByLoadingTool" stat="sum" type="shift" label="Truck queue time for current shift hour" unitType="duration">
                <parameter name="measure" valueRef="truckQueueDurCmplCycle"/>
            </kpi>
            <kpi name="cycleCountForPeriodByLoadingTool" stat="sum" type="shift" label="Loader cycle count for current shift hour" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="_totalHangTimeForPeriod" rollupOf="totalHangTimeForPeriodByLoadingTime" />
            <rolledupKpi name="_totalTruckQueueTimeForPeriod" rollupOf="totalTruckQueueTimeForPeriodByLoadingTool" />
            <rolledupKpi name="_cycleCountForPeriod" rollupOf="cycleCountForPeriodByLoadingTool" />
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="processorHourlyQueueTime" fact="main" machineType="truck" persisted="true"
                 desc="Processor hourly queue time">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName"/>
            <detailRef name="hourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="completedCycleCount"/>
            <measureRef name="queueAtSinkDuration"/>
        </measures>
        <kpis>
            <kpi name="totalTruckQueueTimeForPeriodByProcessor" stat="sum" type="shift"
                 label="Truck queue time at processor for current shift hour" unitType="duration">
                <parameter name="measure" valueRef="queueAtSinkDuration"/>
            </kpi>
            <kpi name="cycleCountForPeriodByProcessor" stat="sum" type="shift"
                 label="Truck cycle count for current shift hour" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="_totalTruckQueueTimeForPeriod" rollupOf="totalTruckQueueTimeForPeriodByProcessor"/>
            <rolledupKpi name="_cycleCountForPeriod" rollupOf="cycleCountForPeriodByProcessor"/>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loaderQuarterHourHangAndQueueTime" fact="main" machineType="loadingTool" persisted="true" desc="Loader info for shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <detailRef name="quarterHourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="hangTimeDurCompleted"/>
            <measureRef name="completedCycleCount"/>
            <measureRef name="truckQueueDurCmplCycle"/>
        </measures>
        <kpis>
            <kpi name="totalHangTimeForPeriodByLoadingTime" stat="sum" type="shift" label="Loader hang time for current shift quarter hour" unitType="duration">
                <parameter name="measure" valueRef="hangTimeDurCompleted"/>
            </kpi>
            <kpi name="totalTruckQueueTimeForPeriodByLoadingTool" stat="sum" type="shift" label="Truck queue time for current shift quarter hour" unitType="duration">
                <parameter name="measure" valueRef="truckQueueDurCmplCycle"/>
            </kpi>
            <kpi name="cycleCountForPeriodByLoadingTool" stat="sum" type="shift" label="Loader cycle count for current shift quarter hour" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="totalHangTimeForPeriod" rollupOf="totalHangTimeForPeriodByLoadingTime" />
            <rolledupKpi name="totalTruckQueueTimeForPeriod" rollupOf="totalTruckQueueTimeForPeriodByLoadingTool" />
            <rolledupKpi name="cycleCountForPeriod" rollupOf="cycleCountForPeriodByLoadingTool" />
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="processorQuarterlyQueueTime" fact="main" machineType="truck" persisted="true"
                 desc="Processor quarterly queue time">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName"/>
            <detailRef name="quarterHourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="completedCycleCount"/>
            <measureRef name="queueAtSinkDuration"/>
        </measures>
        <kpis>
            <kpi name="totalTruckQueueTimeForPeriodByProcessor" stat="sum" type="shift"
                 label="Truck queue time at processor for current shift quarter hour" unitType="duration">
                <parameter name="measure" valueRef="queueAtSinkDuration"/>
            </kpi>
            <kpi name="cycleCountForPeriodByProcessor" stat="sum" type="shift"
                 label="Truck cycle count for current shift quarter hour" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="_totalTruckQueueTimeForPeriod" rollupOf="totalTruckQueueTimeForPeriodByProcessor"/>
            <rolledupKpi name="_cycleCountForPeriod" rollupOf="cycleCountForPeriodByProcessor"/>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckActivitiesByProcessor" fact="main" machineType="truck" persisted="true" desc="Truck Activity Kpis by Processors">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName"/>
        </dimensions>
        <measures>
            <measureRef name="queueAtSinkDuration"/>
            <measureRef name="completedCycleCount"/>
        </measures>
        <kpis>
            <kpi name="_truckQueuingTimeByProcessor" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="queueAtSinkDuration"/>
            </kpi>
            <kpi name="_rollingAverageQueuingTimeByProcessor" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="queueAtSinkDuration"/>
            </kpi>
            <kpi name="_truckCompletedCycleCountByProcessor" stat="sum" type="shift" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="_truckQueuingTime" rollupOf="_truckQueuingTimeByProcessor" />
            <rolledupKpi name="_rollingAverageQueuingTime" rollupOf="_rollingAverageQueuingTimeByProcessor" />
            <rolledupKpi name="_truckCompletedCycleCount" rollupOf="_truckCompletedCycleCountByProcessor" />
        </kpis>
        <calculatedMembers>
            <calculatedMember name="averageTruckQueuingTimeByProcessor"
                              if="kpi._truckCompletedCycleCountByProcessor &gt; 0"
                              expr="kpi._truckQueuingTimeByProcessor / kpi._truckCompletedCycleCountByProcessor"
                              unitType="duration"/>
            <calculatedMember name="averageTruckQueuingTime"
                              if="kpi._truckCompletedCycleCount &gt; 0"
                              expr="kpi._truckQueuingTime / kpi._truckCompletedCycleCount"
                              unitType="duration"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckLoadingActivity" fact="main" machineType="truck" persisted="true" desc="Loading Activity Kpis">
        <timestamp>
            <detailRef name="loadingEndTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="queuingAtSourceDuration"/>
            <measureRef name="spottingAtSourceDuration"/>
            <measureRef name="waitForLoadDuration"/>
            <measureRef name="loadingDuration"/>
        </measures>
        <kpis>
            <kpi name="loadQueuingTime" stat="weighted" label="Load Queuing Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="queuingAtSourceDuration"/>
            </kpi>
            <kpi name="loadSpottingTime" stat="weighted" label="Load Spotting Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="spottingAtSourceDuration"/>
            </kpi>
            <kpi name="loadWaitForLoadTime" stat="weighted" label="Wait for Load Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="waitForLoadDuration"/>
            </kpi>
            <kpi name="loadingTime" stat="weighted" label="Loading Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckDumpingActivity" fact="main" machineType="truck" persisted="true" desc="Dumping Activity Kpis">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="queuingAtSinkDuration"/>
            <measureRef name="spottingAtSinkDuration"/>
            <measureRef name="waitForDumpDuration"/>
            <measureRef name="dumpingDuration"/>
        </measures>
        <kpis>
            <kpi name="dumpQueuingTime" stat="weighted" label="Dump Queuing Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="queuingAtSinkDuration"/>
            </kpi>
            <kpi name="dumpSpottingTime" stat="weighted" label="Dump Spotting Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="spottingAtSinkDuration"/>
            </kpi>
            <kpi name="dumpWaitForDumpTime" stat="weighted" label="Dump Waiting Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="waitForDumpDuration"/>
            </kpi>
            <kpi name="dumpingTime" stat="weighted" label="Dumping Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="dumpingDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckCycleInfo" fact="main" machineType="truck" persisted="true" desc="Truck cycle info">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="cycleDuration"/>
        </measures>
        <kpis>
            <kpi name="lastCycleTime" if="main.completedCycleCount == 1" stat="weighted" label="Last Cycle Time" unitType="duration" active="true">
                <parameter name="weights" value="100" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="cycleDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckShiftCycleInfo" fact="main" machineType="truck" persisted="true"
                 desc="truck shift cycle info">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName"/>
        </dimensions>
        <measures>
            <measureRef name="completedCycleCount"/>
            <measureRef name="cycleDuration"/>
            <measureRef name="payloadNominalDry"/>
        </measures>
        <kpis>
            <kpi name="completedCycleCountByProcessor" stat="sum" type="shift"
                 label="Truck completed cycle count fir shift by processor" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <kpi name="_truckCycleDurationByProcessor" stat="sum" type="shift"
                 label="Truck cycle duration for shift by processor" unitType="duration">
                <parameter name="measure" valueRef="cycleDuration"/>
            </kpi>
            <kpi name="_truckCyclePayloadByProcessor" stat="sum" type="shift"
                 label="Truck cycle payload for shift by processor" unitType="mass">
                <parameter name="measure" valueRef="payloadNominalDry"/>
            </kpi>
            <rolledupKpi name="_completedCycleCountForProcessor" rollupOf="completedCycleCountByProcessor"/>
            <rolledupKpi name="_truckCycleDurationForProcessor" rollupOf="_truckCycleDurationByProcessor"/>
            <rolledupKpi name="_truckCyclePayloadForProcessor" rollupOf="_truckCyclePayloadByProcessor"/>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="averageTruckCycleDurationByProcessor"
                              if="kpi.completedCycleCountByProcessor &gt; 0"
                              expr="kpi._truckCycleDurationByProcessor / kpi.completedCycleCountByProcessor"
                              unitType="duration"/>
            <calculatedMember name="averageTruckCyclePayloadByProcessor"
                              if="kpi.completedCycleCountByProcessor &gt; 0"
                              expr="kpi._truckCyclePayloadByProcessor / kpi.completedCycleCountByProcessor"
                              unitType="mass"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="processorActivity" fact="main" machineType="processor" persisted="true" desc="Activity Kpis">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName" />
        </dimensions>
        <measures>
            <measureRef name="queuingAtSinkDuration"/>
            <measureRef name="spottingAtSinkDuration"/>
            <measureRef name="dumpingDuration"/>
        </measures>
        <kpis>
            <kpi name="queuingTime" stat="weighted" label="Queuing Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="queuingAtSinkDuration"/>
            </kpi>
            <kpi name="spottingTime" stat="weighted" label="Spotting Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="spottingAtSinkDuration"/>
            </kpi>
            <kpi name="dumpingTime" stat="weighted" label="Dumping Time" unitType="duration" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="dumpingDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckLoadingStats" fact="main" machineType="truck" persisted="true" desc="Loading stats for trucks">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="totalPayloadForShift" stat="sum" type="shift" label="Payload/Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="cyclesForShift" stat="count" type="shift" label="Cycles/Shift" unitType="unitless" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="meanPayloadForShift" type="shift" label="Mean Payload/Shift" unitType="mass"
                              expr="kpi.totalPayloadForShift / kpi.cyclesForShift if kpi.cyclesForShift > 0 else 0"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckBCMStats" fact="main" machineType="truck" persisted="true" desc="Loading stats for trucks">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="volumeBCMNominalDry"/>
        </measures>
        <kpis>
            <kpi name="totalVolumeForShift" stat="sum" type="shift" label="bcm/Shift" unitType="volume" active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            <kpi name="cyclesForShift" stat="count" type="shift" label="Cycles/Shift" unitType="unitless" active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            <kpi name="meanVolumeForShift" stat="mean" type="shift" label="Mean bcm/Shift" unitType="volume"
                 active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolLoadingStats" fact="main" machineType="loadingTool" persisted="true" desc="Loading stats for loading tools">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="totalPayloadForShift" stat="sum" type="shift" label="Payload In Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="cyclesForShift" stat="count" type="shift" label="Cycles In Shift" unitType="unitless" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="meanPayloadForShift" type="shift" label="Mean Payload In Shift" unitType="mass"
                              expr="kpi.totalPayloadForShift / kpi.cyclesForShift if kpi.cyclesForShift > 0 else 0"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loaderTonsMined" machineType="loadingTool" fact="main" persisted="true" desc="Tons mined from LoaderCycles per hour and cumulative per shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReportingCC"/>
        </measures>
        <kpis>
            <kpi name="perHourByLoadingToolForPeriod" stat="rate" label="Tons/Hour" unitType="rate" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="perHourByLoadingToolPrimeForPeriod" if="main.rehandle == 0" stat="rate" label="PrimeTons/Hour" unitType="rate" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="perHourByLoadingToolRehandleForPeriod" if="main.rehandle" stat="rate" label="RehandleTons/Hour" unitType="rate" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="byLoadingToolForShift" stat="sum" type="shift" label="Tons/Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="byLoadingToolPrimeForShift" if="main.rehandle == 0" stat="sum" type="shift" label="PrimeTons/Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="byLoadingToolRehandleForShift" if="main.rehandle" stat="sum" type="shift" label="RehandleTons/Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <rolledupKpi name="perHourForPeriod" rollupOf="perHourByLoadingToolForPeriod" label="Tons/Hour"/>
            <rolledupKpi name="perHourPrimeForPeriod" rollupOf="perHourByLoadingToolPrimeForPeriod" label="PrimeTons/Hour"/>
            <rolledupKpi name="perHourRehandleForPeriod" rollupOf="perHourByLoadingToolRehandleForPeriod" label="RehandleTons/Hour"/>
            <rolledupKpi name="forShift" rollupOf="byLoadingToolForShift" label="Tons/Shift"/>
            <rolledupKpi name="primeForShift" rollupOf="byLoadingToolPrimeForShift" label="PrimeTons/Shift"/>
            <rolledupKpi name="rehandleForShift" rollupOf="byLoadingToolRehandleForShift" label="RehandleTons/Shift"/>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loaderBCMMined" machineType="loadingTool" fact="main" persisted="true"
                 desc="Volume mined from LoaderCycles per hour and cumulative per shift">
        −
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        −
        <dimensions>
            −
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        −
        <measures>
            <measureRef name="volumeBCMNominalDry"/>
        </measures>
        −
        <kpis>
            −
            <kpi name="perHourByLoadingToolForPeriod" stat="rate" label="bcm/Hour" unit="bcms per hour"
                 unitType="material flow" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            −
            <kpi name="perHourByLoadingToolPrimeForPeriod" if="main.rehandle == 0" stat="rate" label="Prime bcms/Hour"
                 unit="bcms per hour" unitType="material flow" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            −
            <kpi name="perHourByLoadingToolRehandleForPeriod" if="main.rehandle" stat="rate" label="Rehandle bcms/Hour"
                 unit="bcms per hour" unitType="material flow" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            −
            <kpi name="byLoadingToolForShift" stat="sum" type="shift" label="bcms/Shift" unitType="volume"
                 active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            −
            <kpi name="byLoadingToolPrimeForShift" if="main.rehandle == 0" stat="sum" type="shift"
                 label="Prime bcms/Shift" unitType="volume" active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            −
            <kpi name="byLoadingToolRehandleForShift" if="main.rehandle" stat="sum" type="shift"
                 label="Rehandle bcms/Shift" unitType="volume" active="true">
                <parameter name="measure" valueRef="volumeBCMNominalDry"/>
            </kpi>
            <rolledupKpi name="perHourForPeriod" rollupOf="perHourByLoadingToolForPeriod" label="bcms/Hour"/>
            <rolledupKpi name="perHourPrimeForPeriod" rollupOf="perHourByLoadingToolPrimeForPeriod"
                         label="Prime bcms/Hour"/>
            <rolledupKpi name="perHourRehandleForPeriod" rollupOf="perHourByLoadingToolRehandleForPeriod"
                         label="Rehandle bcms/Hour"/>
            <rolledupKpi name="forShift" rollupOf="byLoadingToolForShift" label="bcms/Shift"/>
            <rolledupKpi name="primeForShift" rollupOf="byLoadingToolPrimeForShift" label="Primebcms/Shift"/>
            <rolledupKpi name="rehandleForShift" rollupOf="byLoadingToolRehandleForShift" label="Rehandle bcms/Shift"/>
        </kpis>
    </realtimeKpi>
    −
    <realtimeKpi if="loader" name="trucksLoaded" machineType="loadingTool" fact="main" persisted="true" desc="Trucks loaded per hour and cumulative per shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingCount"/>
        </measures>
        <kpis>
            <kpi name="perHourByLoadingToolForPeriod" stat="rate" label="Trucks/Hour" unitType="count per time" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="loadingCount"/>
            </kpi>
            <kpi name="byLoadingToolForShift" stat="sum" type="shift" label="Trucks/Shift" unitType="unitless" active="true">
                <parameter name="measure" valueRef="loadingCount"/>
            </kpi>
            <rolledupKpi name="perHourForPeriod" rollupOf="perHourByLoadingToolForPeriod" label="Trucks/Hour"/>
            <rolledupKpi name="forShift" rollupOf="byLoadingToolForShift" label="Trucks/Shift"/>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolDigRate" machineType="loadingTool" fact="main" persisted="true" desc="LoadingTool dig rate">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
            <measureRef name="loadingDuration"/>
        </measures>
        <kpis>
            <kpi name="_tonsMinedByLoadingToolForPeriod" stat="sum" unitType="mass" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_loadingDurationByLoadingToolForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="byLoadingToolForPeriod" if="kpi._loadingDurationByLoadingToolForPeriod > 0" label="Dig Rate"
                              expr="kpi._tonsMinedByLoadingToolForPeriod * 3600 / kpi._loadingDurationByLoadingToolForPeriod" unitType = "rate"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolProductivityForFUA" machineType="loadingTool" fact="main" persisted="true" desc="LoadingTool productivity">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingDuration"/>
            <measureRef name="nominalLoadingDuration"/>
        </measures>
        <kpis>
            <kpi name="_loadingDurationByLoadingToolForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="_nominalLoadingDurationByLoadingToolForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="nominalLoadingDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="byLoadingToolForPeriod" if="kpi._loadingDurationByLoadingToolForPeriod > 0" label="Productivity"
                              expr="kpi._nominalLoadingDurationByLoadingToolForPeriod * 100 / kpi._loadingDurationByLoadingToolForPeriod" unit="percent" unitType = "ratio"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="drill" name="drillKpis" machineType="aux" fact="main" persisted="true" desc="Holes and feet drilled per hour and per shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="count" measure="completedCycleCount"/>
            <measureRef name="depth" measure="depthDesign"/>
        </measures>
        <kpis>
            <kpi name="holesByDrillForShift" stat="sum" type="shift" label="Holes/Shift" unitType="unitless" active="true">
                <parameter name="measure" valueRef="count"/>
            </kpi>
            <kpi name="holesPerHourByDrillForPeriod" stat="rate" label="Holes/Hour" unitType="count per time" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="count"/>
            </kpi>

            <kpi name="feetByDrillForShift" stat="sum" type="shift" label="Feet Drilled/Shift" unitType="depth" active="true">
                <parameter name="measure" valueRef="depth"/>
            </kpi>
            <kpi name="feetPerHourByDrillForPeriod" stat="rate" label="Feet Drilled/Hour" unit="feet per hour" unitType="drill speed" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="depth"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <!-- This has been removed from the FUA (by removing the machineType="truck" attribute) since it has been superceded
         by the TKPH Monitor column. It has been left here so it can easily be resuscitated by a custom xml file -->
    <realtimeKpi if="truck" name="tmph" fact="main" persisted="true" desc="Ton miles per hour (or equivalent in other units)">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="tmph"/>
            <measure name="tm" expr="main.tmph * main.cycleDuration / 3600" unitType="mass distance"/>
            <measureRef name="cycleDuration"/>
        </measures>
        <kpis>
            <kpi name="byTruck" stat="weighted" label="TMPH" unitType="mass speed" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="tmph"/>
            </kpi>
            <kpi name="byTruckForPeriod" stat="rate" label="TMPH(90mins)" unitType="mass speed" active="true">
                <parameter name="period" value="90" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="tm"/>
                <parameter name="duration" valueRef="cycleDuration"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckSpeed" fact="main" machineType="truck" persisted="true" desc="Travel speed for trucks">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measure name="expectedTravelDuration" expr="main.emptyExpectedTravelDuration + main.fullExpectedTravelDuration" unitType="duration"/>
            <measure name="travelDuration" expr="main.emptyTravelDuration + main.fullTravelDuration" unitType="duration"/>
        </measures>
        <kpis>
            <kpi name="_expectedByTruckForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="expectedTravelDuration"/>
            </kpi>
            <kpi name="_actualByTruckForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="travelDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="byTruckForPeriod" if="kpi._actualByTruckForPeriod > 0" label="Truck Speed"
                              expr="kpi._expectedByTruckForPeriod * 100 / kpi._actualByTruckForPeriod" unitType = "ratio"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="processorTonsDumped" fact="main" machineType="processor" persisted="true" desc="Tons dumped from Processors per hour and cumulative per shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <detailRef name="endProcessorName"/>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="perHourByProcessorForPeriod" stat="rate" label="Tons/Hour" unitType="rate" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="byProcessorForShift" stat="sum" type="shift" label="Tons/Shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <rolledupKpi name="perHourForPeriod" rollupOf="perHourByProcessorForPeriod" label="Tons/Hour"/>
            <rolledupKpi name="forShift" rollupOf="byProcessorForShift" label="Tons/Shift"/>
        </kpis>
    </realtimeKpi>


    <realtimeKpi if="truck" name="hourlyTonsDumpedByProcessor" fact="main" persisted="true"
                 desc="Tons dumped of material in each hour of shift by processor">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>

        <dimensions>
            <detailRef name="endProcessorName"/>
            <dimensionRef name="loaderMaterial" dimension="material">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <detailRef name="hourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="_primeTonsDumped" if="not main.rehandle" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_rehandleTonsDumped" if="main.rehandle" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="tonsDumped" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckTonsMined" machineType="truck" fact="main" persisted="true" desc="Tons mined per hour by trucks">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
            <measureRef name="operHoursSeconds"/>
            <measureRef name="totalTime"/>
        </measures>
        <kpis>
            <kpi name="_payloadByTruckForPeriod" stat="sum" unitType="mass" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_totalTimeByTruckForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="totalTime"/>
            </kpi>
            <kpi name="_operSecondsByTruckForPeriod" stat="sum" unitType="duration" active="true">
                <parameter name="period" value="60" unit="minute" unitType="duration"/>
                <parameter name="measure" valueRef="operHoursSeconds"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="perHourByTruckForPeriod" label="Tons/Hour"
                              expr="kpi._payloadByTruckForPeriod * 3600 / kpi._totalTimeByTruckForPeriod if kpi._totalTimeByTruckForPeriod > 0 else 0"
                              unitType="rate" active="true"/>
            <calculatedMember name="perOperHourByTruckForPeriod" label="Tons/OperHour"
                              expr="kpi._payloadByTruckForPeriod * 3600 / kpi._operSecondsByTruckForPeriod if kpi._operSecondsByTruckForPeriod > 0 else 0"
                              unitType="rate" active="true"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckEFHInfoForShift" fact="main" persisted="true" desc="Truck EFH Kpi for shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="machineOID"/>
            </dimensionRef>
            <!-- Kpi will only be persisted when the cycle is completed due the if check on efhCycleDuration.
                  this means endTime should be accurate-->
            <detailRef name="endTimeMs"/>
        </dimensions>
        <measures>
            <measureRef name="totalEfhLength"/>
            <measureRef name="payloadReporting"/>
            <measureRef name="completedCycleDuration"/>
        </measures>
        <kpis>
            <kpi name="_efhCumulativeLength" if="main.completedCycleCount == 1" stat="sum" type="shift"
                 unitType="length" active="true">
                <parameter name="measure" valueRef="totalEfhLength"/>
            </kpi>
            <kpi name="_efhCumulativePayload" if="main.completedCycleCount == 1" stat="sum" type="shift"
                 unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_efhCycleDuration" stat="sum" type="shift"
                 unitType="duration" active="true">
                <parameter name="measure" valueRef="completedCycleDuration"/> <!-- Will be zero until the cycle finishes-->
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="massSpeedEFH" label="Mass * Speed"
                              if="kpi._efhCycleDuration &gt; 0"
                              expr="kpi._efhCumulativeLength * kpi._efhCumulativePayload / kpi._efhCycleDuration"
                              unitType="mass speed" active="true"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="hourlyCumulativeMaterialMovedForLoader" machineType="loadingTool" fact="main" persisted="true" desc="Material moved from Loader per hour for shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <detailRef name="hourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="cumulativeMaterialMoved" if="main.completedCycleCount == 1" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <rolledupKpi name="_cumulativeMaterialMovedForShift" rollupOf="cumulativeMaterialMoved"/>
        </kpis>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolDigRateForShift" machineType="loadingTool" fact="main" persisted="true" desc="LoadingTool dig rate for shift">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
            <measureRef name="loadingDuration"/>
        </measures>
        <kpis>
            <kpi name="_tonsMinedByLoadingToolForShift" if="main.completedCycleCount == 1" stat="sum" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
            <kpi name="_loadingDurationByLoadingToolForShift" if="main.completedCycleCount == 1" stat="sum" unitType="duration" active="true">
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="byLoadingToolForShift" if="kpi._loadingDurationByLoadingToolForShift > 0 and kpi._tonsMinedByLoadingToolForShift > 0" label="Dig Rate for shift"
                              expr="kpi._tonsMinedByLoadingToolForShift * 3600 / kpi._loadingDurationByLoadingToolForShift" unitType = "rate"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolEfficiency" fact="main" persisted="true" desc="Rolling and shift weighted avg for loader efficiency " reserved="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingEfficiency"/>
            <measureRef name="loadingDuration"/>
            <measureRef name="nominalLoadingDuration"/>
        </measures>
        <kpis>
            <kpi name="_rollingProductivity" stat="weighted" unitType="ratio" active="true">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="loadingEfficiency"/>
            </kpi>

            <kpi name="_loadingDurationByLoadingToolForShift" stat="sum" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="_nominalLoadingDurationByLoadingToolForShift" stat="sum" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="nominalLoadingDuration"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="efficiencyByLoadingToolForShift" if="kpi._loadingDurationByLoadingToolForShift > 0"
                              expr="kpi._nominalLoadingDurationByLoadingToolForShift * 100 / kpi._loadingDurationByLoadingToolForShift" unit="percent" unitType = "ratio"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="loader" name="loaderUtilisation" fact="main" persisted="true" desc="Loader Utilisation Kpi" shiftCheck="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="operatingTime"/>
            <measureRef name="timeElapsedToCycleEndTime"/>
            <measureRef name="operatingDelayTime"/>
        </measures>
        <kpis>
            <kpi name="_loaderOperatingTime" stat="sum" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="operatingTime"/>
            </kpi>
            <kpi name="_elapsedShiftTime" stat="weighted" unitType="duration" active="true">
                <parameter name="weights" value="100" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="timeElapsedToCycleEndTime"/>
            </kpi>
            <kpi name="_loaderOperatingDelayTime" stat="sum" type="shift" unitType="duration" active="true">
                <parameter name="measure" valueRef="operatingDelayTime"/>
            </kpi>
        </kpis>
        <calculatedMembers>
            <calculatedMember name="loaderUtilisationForShift"
                              if="kpi._elapsedShiftTime &gt; 0"
                              expr="(kpi._loaderOperatingTime + kpi._loaderOperatingDelayTime) * 100 / kpi._elapsedShiftTime"
                              label="Loader Utilisation" unitType="ratio"/>
        </calculatedMembers>
    </realtimeKpi>
    <realtimeKpi if="loader" name="sourceBlockInfoForLoadingTool" machineType="loadingTool" fact="main" persisted="true" desc="Source block information for loading tool">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <dimensionRef name="sourceBlock" dimension="block">
                <dimensionAttributeRef name="gradeBlockOid"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="compPayloadReporting"/>
            <measureRef name="sourceBlockRemainingMass"/>
        </measures>
        <kpis>
            <kpi name="materialMinedFromSourceBlock" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="compPayloadReporting"/>
            </kpi>
            <kpi name="materialRemainingInSourceBlock" stat="weighted" unitType="mass" active="true">
                <parameter name="weights" value="100" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="sourceBlockRemainingMass"/>
            </kpi>
        </kpis>
    </realtimeKpi>
</kpiSummaries>
