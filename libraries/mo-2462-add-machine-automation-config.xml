<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="b3ba64d1-bb6c-4846-85be-cecb9f73aaa4" author="MineStar" context="Pit_Link/Pit_Link_Management"
               failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for MACHINE_AUTOMATION_CONFIG as table already exists."
                       onFail="MARK_RAN">
            <not>
                <tableExists tableName="MACHINE_AUTOMATION_CONFIG"/>
            </not>
        </preConditions>
        <comment>MO-2462: CreateTable MACHINE_AUTOMATION_CONFIG</comment>
        <createTable remarks="The automation config for various actions." tableName="MACHINE_AUTOMATION_CONFIG">
            <column name="MACHINE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ACTION_NAME" type="VARCHAR(255)" remarks="The name of the automation action">
                <constraints nullable="false"/>
            </column>
            <column name="AUTOMATION_LEVEL" type="TINYINT" remarks="The level of automation (0..3)">
                <constraints nullable="false"/>
            </column>
            <column name="TIMEOUT_DURATION" type="DOUBLE" remarks="For automation level 2 (accept/reject), an optional timeout duration.  0 implies no timeout">
                <constraints nullable="false"/>
            </column>
            <column name="TIMEOUT_ACTION" type="VARCHAR(255)" remarks="For automation level 2 (accept/reject), the action to take on timeout">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="MACHINE_OID,ACTION_NAME" constraintName="MACHINE_AUTOMATION_CONFIG_PK"
                       tableName="MACHINE_AUTOMATION_CONFIG"/>
    </changeSet>

    <changeSet id="ecb5aeec-5929-43f9-94ec-97239e66992a" author="MineStar" context="Pit_Link/Pit_Link_Management"
               failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_AUTOMATION_CONFIG_FK1 to table MACHINE_AUTOMATION_CONFIG as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="MACHINE_AUTOMATION_CONFIG" columnName="MACHINE_OID"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_AUTOMATION_CONFIG"
                                            foreignKeyName="MACHINE_AUTOMATION_CONFIG_FK1"/>
            </not>
        </preConditions>
        <comment>MO-2462: AddForeignKeyConstraint MACHINE_AUTOMATION_CONFIG_FK1 to MACHINE_AUTOMATION_CONFIG (MACHINE_OID)</comment>
        <sql>DELETE FROM MACHINE_AUTOMATION_CONFIG
             WHERE MACHINE_OID IS NOT NULL
             AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = MACHINE_AUTOMATION_CONFIG.MACHINE_OID)
        </sql>
        <addForeignKeyConstraint baseTableName="MACHINE_AUTOMATION_CONFIG" baseColumnNames="MACHINE_OID"
                                 constraintName="MACHINE_AUTOMATION_CONFIG_FK1" referencedTableName="MACHINE"
                                 referencedColumnNames="MACHINE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_AUTOMATION_CONFIG"
                                      constraintName="MACHINE_AUTOMATION_CONFIG_FK1"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
