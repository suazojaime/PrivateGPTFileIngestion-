<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="b1c4e4c4-3c7a-406d-b5bf-a806eaa23386" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropIndex for TKPH_READING_1 of table TKPH_READING as index does not exist."
                onFail="MARK_RAN">
            <indexExists indexName="TKPH_READING_1" tableName="TKPH_READING"/>
        </preConditions>
        <comment>MO-473: DropIndex TKPH_READING_1 from TKPH_READING (MACHINE_OID,READING_TIME_UTC)</comment>
        <dropIndex tableName="TKPH_READING" indexName="TKPH_READING_1"/>
        <rollback>
            <createIndex unique="false" indexName="TKPH_READING_1" tableName="TKPH_READING">
                <column name="MACHINE_OID"/>
                <column name="READING_TIME_UTC"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="c6d73ca2-9632-47d8-b206-33f1550041ec" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropColumn for ECF_CLASS_ID of table TKPH_READING as column does not exist."
                onFail="MARK_RAN">
            <columnExists tableName="TKPH_READING" columnName="ECF_CLASS_ID"/>
        </preConditions>
        <comment>MO-473: DropColumn TKPH_READING.ECF_CLASS_ID</comment>
        <dropColumn columnName="ECF_CLASS_ID" tableName="TKPH_READING"/>
        <rollback>
            <addColumn tableName="TKPH_READING">
                <column name="ECF_CLASS_ID" type="NVARCHAR(255)"/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="a5e8305e-b5e5-40a7-991c-12b022cc40cf" author="MineStar" failOnError="false">
        <comment>MO-473: Delete bad rows from TPKH_READING</comment>
        <sql>DELETE FROM TKPH_READING WHERE MACHINE_OID IS NULL OR READING_TIME_UTC IS NULL OR TKPH_ACTIVITY IS NULL OR TKPH_VALUE IS NULL</sql>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <changeSet id="c169c78e-7118-4722-8518-4c5de6c9c783" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for TKPH_READING.MACHINE_OID as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="TKPH_READING" columnName="MACHINE_OID"/>
        </preConditions>
        <comment>MO-473: AddNotNullConstraint to TKPH_READING.MACHINE_OID</comment>
        <addNotNullConstraint columnName="MACHINE_OID" columnDataType="BIGINT" tableName="TKPH_READING"/>
    </changeSet>

    <changeSet id="9b817121-62fe-480e-877f-7a7b12a41085" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for TKPH_READING.READING_TIME_UTC as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="TKPH_READING" columnName="READING_TIME_UTC"/>
        </preConditions>
        <comment>MO-473: AddNotNullConstraint to TKPH_READING.READING_TIME_UTC</comment>
        <addNotNullConstraint columnName="READING_TIME_UTC" columnDataType="DATETIME2" tableName="TKPH_READING"/>
    </changeSet>

    <changeSet id="0826a5cb-580a-474f-aec4-6a6f6ab95e2a" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for TKPH_READING.TKPH_VALUE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="TKPH_READING" columnName="TKPH_VALUE"/>
        </preConditions>
        <comment>MO-473: AddNotNullConstraint to TKPH_READING.TKPH_VALUE</comment>
        <addNotNullConstraint columnName="TKPH_VALUE" columnDataType="DOUBLE" tableName="TKPH_READING"/>
    </changeSet>

    <changeSet id="2caacef8-9991-4a6f-8f3c-ca077e199563" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for TKPH_READING.TKPH_ACTIVITY as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="TKPH_READING" columnName="TKPH_ACTIVITY"/>
        </preConditions>
        <comment>MO-473: AddNotNullConstraint to TKPH_READING.TKPH_ACTIVITY</comment>
        <addNotNullConstraint columnName="TKPH_ACTIVITY" columnDataType="VARCHAR(255)" tableName="TKPH_READING"/>
    </changeSet>

    <changeSet id="cf77989c-6b36-4eaf-837c-23619923f63b" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored CreateUniqueIndex for TKPH_READING_MACHINE_TIME to table TKPH_READING as (1) table does not exist, or (2) index already exists."
                onFail="MARK_RAN">
            <tableExists tableName="TKPH_READING"/>
            <not>
                <indexExists indexName="TKPH_READING_MACHINE_TIME" tableName="TKPH_READING"/>
            </not>
        </preConditions>
        <comment>MO-473: CreateUniqueIndex TKPH_READING_MACHINE_TIME on TKPH_READING (MACHINE_OID,READING_TIME_UTC)</comment>
        <sql dbms="oracle">DELETE FROM TKPH_READING WHERE ROWID IN (SELECT RID FROM (SELECT ROWID RID, ROW_NUMBER() OVER (PARTITION BY MACHINE_OID, READING_TIME_UTC ORDER BY ROWID) RN FROM TKPH_READING) WHERE RN &lt;&gt; 1)</sql>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY MACHINE_OID, READING_TIME_UTC ORDER BY %%physloc%%) AS ROW_NUM FROM TKPH_READING) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <createIndex unique="true" tablespace="MW_IDXENT" indexName="TKPH_READING_MACHINE_TIME"
                     tableName="TKPH_READING">
            <column name="MACHINE_OID"/>
            <column name="READING_TIME_UTC"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="TKPH_READING" indexName="TKPH_READING_MACHINE_TIME"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

</databaseChangeLog>
