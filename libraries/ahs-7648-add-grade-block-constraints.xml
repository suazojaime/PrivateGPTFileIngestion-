<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="76f8d2bd-2c5f-44f4-bcd1-b8ef14c4726d" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.NAME as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="NAME"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.NAME</comment>
        <addNotNullConstraint columnName="NAME" columnDataType="VARCHAR(254)" tableName="GRADEBLOCK"/>
    </changeSet>

    <changeSet id="798a6fdf-1c8d-45e6-b802-531c59efaadb" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.STOCKPILE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="STOCKPILE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.STOCKPILE</comment>
        <sql>UPDATE GRADEBLOCK SET STOCKPILE = 0 WHERE STOCKPILE IS NULL</sql>
        <addNotNullConstraint columnName="STOCKPILE" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="STOCKPILE" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="d9d19557-bc03-4ffd-93f6-6280939631f2" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropIndex for GRADEBLOCK_IS_ACTIVE_IDX of table GRADEBLOCK as index does not exist."
                onFail="MARK_RAN">
            <indexExists indexName="GRADEBLOCK_IS_ACTIVE_IDX" tableName="GRADEBLOCK"/>
        </preConditions>
        <comment>AHS-7648: DropIndex GRADEBLOCK_IS_ACTIVE_IDX from GRADEBLOCK (IS_ACTIVE)</comment>
        <dropIndex tableName="GRADEBLOCK" indexName="GRADEBLOCK_IS_ACTIVE_IDX"/>
        <rollback>
            <createIndex unique="false" tablespace="MW_IDXENT" indexName="GRADEBLOCK_IS_ACTIVE_IDX" tableName="GRADEBLOCK">
                <column name="IS_ACTIVE"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>


    <changeSet id="97747fc2-c8d3-4551-afe1-7662b3c73644" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.IS_ACTIVE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="IS_ACTIVE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.IS_ACTIVE</comment>
        <sql>UPDATE GRADEBLOCK SET IS_ACTIVE = 0 WHERE IS_ACTIVE IS NULL</sql>
        <addNotNullConstraint columnName="IS_ACTIVE" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="IS_ACTIVE" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="6c50c1ab-d395-4da8-9bfe-e44a7caa3095" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.INUSE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="INUSE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.INUSE</comment>
        <sql>UPDATE GRADEBLOCK SET INUSE = 0 WHERE INUSE IS NULL</sql>
        <addNotNullConstraint columnName="INUSE" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="INUSE" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="3dd633cc-f8d9-4c30-abdb-35b497f32f66" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.READONLY as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="READONLY"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.READONLY</comment>
        <sql>UPDATE GRADEBLOCK SET READONLY = 0 WHERE READONLY IS NULL</sql>
        <addNotNullConstraint columnName="READONLY" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="READONLY" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="977a9e55-9b77-416f-8a76-645542add010" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.VERSION as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="VERSION"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.VERSION</comment>
        <sql>UPDATE GRADEBLOCK SET VERSION = 0 WHERE VERSION IS NULL</sql>
        <addNotNullConstraint columnName="VERSION" columnDataType="BIGINT" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="VERSION" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

    <changeSet id="e274c27c-bfee-4c4a-bc25-e72a92b160d9" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.OPENFORDUMPING as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="OPENFORDUMPING"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.OPENFORDUMPING</comment>
        <sql>UPDATE GRADEBLOCK SET OPENFORDUMPING = 0 WHERE OPENFORDUMPING IS NULL</sql>
        <addNotNullConstraint columnName="OPENFORDUMPING" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="OPENFORDUMPING" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="990c6fcc-7186-4223-a0fe-8b047614d21d" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK.OPENFORLOADING as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK" columnName="OPENFORLOADING"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK.OPENFORLOADING</comment>
        <sql>UPDATE GRADEBLOCK SET OPENFORLOADING = 0 WHERE OPENFORLOADING IS NULL</sql>
        <addNotNullConstraint columnName="OPENFORLOADING" columnDataType="BOOLEAN" tableName="GRADEBLOCK"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK" columnName="OPENFORLOADING" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="c0c5a17f-0993-470c-b385-f4e5cbeb7214" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_DISC_VALUE.VALUE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_DISC_VALUE" columnName="VALUE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK_DISC_VALUE.VALUE</comment>
        <sql>DELETE FROM GRADEBLOCK_DISC_VALUE WHERE VALUE IS NULL</sql>
        <addNotNullConstraint columnName="VALUE" columnDataType="VARCHAR(255)" tableName="GRADEBLOCK_DISC_VALUE"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK_DISC_VALUE" columnName="VALUE" columnDataType="VARCHAR(255)"/>
        </rollback>
    </changeSet>

    <changeSet id="327d3ffa-01c3-4652-960e-1d05d4d6dfd9" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_POLYGON.X_MAGNITUDE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_POLYGON" columnName="X_MAGNITUDE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK_POLYGON.X_MAGNITUDE</comment>
        <sql>UPDATE GRADEBLOCK_POLYGON SET X_MAGNITUDE = 0 WHERE X_MAGNITUDE IS NULL</sql>
        <addNotNullConstraint columnName="X_MAGNITUDE" columnDataType="DOUBLE" tableName="GRADEBLOCK_POLYGON"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK_POLYGON" columnName="X_MAGNITUDE" columnDataType="DOUBLE"/>
        </rollback>
    </changeSet>

    <changeSet id="c7e0ed4b-5363-4569-8433-775b75d992fa" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_POLYGON.Y_MAGNITUDE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_POLYGON" columnName="Y_MAGNITUDE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK_POLYGON.Y_MAGNITUDE</comment>
        <sql>UPDATE GRADEBLOCK_POLYGON SET Y_MAGNITUDE = 0 WHERE Y_MAGNITUDE IS NULL</sql>
        <addNotNullConstraint columnName="Y_MAGNITUDE" columnDataType="DOUBLE" tableName="GRADEBLOCK_POLYGON"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK_POLYGON" columnName="Y_MAGNITUDE" columnDataType="DOUBLE"/>
        </rollback>
    </changeSet>

    <changeSet id="4db08c77-6641-4b38-8f63-c00d25c101d5" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_POLYGON.Z_MAGNITUDE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_POLYGON" columnName="Z_MAGNITUDE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK_POLYGON.Z_MAGNITUDE</comment>
        <sql>UPDATE GRADEBLOCK_POLYGON SET Z_MAGNITUDE = 0 WHERE Z_MAGNITUDE IS NULL</sql>
        <addNotNullConstraint columnName="Z_MAGNITUDE" columnDataType="DOUBLE" tableName="GRADEBLOCK_POLYGON"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK_POLYGON" columnName="Z_MAGNITUDE" columnDataType="DOUBLE"/>
        </rollback>
    </changeSet>

    <changeSet id="e6818b26-a1be-4b01-b1ea-78166d8fa79f" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropForeignKeyConstraint for GRADEBLOCK_LOCATION_FK of table GRADEBLOCK as foreignKey does not exist."
                onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="GRADEBLOCK" foreignKeyName="GRADEBLOCK_LOCATION_FK"/>
        </preConditions>
        <comment>AHS-7648: DropForeignKeyConstraint GRADEBLOCK_LOCATION_FK from GRADEBLOCK (LOCATION)</comment>
        <dropForeignKeyConstraint baseTableName="GRADEBLOCK" constraintName="GRADEBLOCK_LOCATION_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="GRADEBLOCK" baseColumnNames="LOCATION" constraintName="GRADEBLOCK_LOCATION_FK" referencedTableName="LOCATION" referencedColumnNames="LOCATION_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="a5904a2a-378e-4c7c-b182-b9b2fdc37af4" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropForeignKeyConstraint for GRADEBLOCK_MATERIALGROUP_FK of table GRADEBLOCK as foreignKey does not exist."
                onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="GRADEBLOCK" foreignKeyName="GRADEBLOCK_MATERIALGROUP_FK"/>
        </preConditions>
        <comment>AHS-7648: DropForeignKeyConstraint GRADEBLOCK_MATERIALGROUP_FK from GRADEBLOCK (MATERIALGROUP)</comment>
        <dropForeignKeyConstraint baseTableName="GRADEBLOCK" constraintName="GRADEBLOCK_MATERIALGROUP_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="GRADEBLOCK" baseColumnNames="MATERIALGROUP" constraintName="GRADEBLOCK_MATERIALGROUP_FK" referencedTableName="MATERIAL_GROUP" referencedColumnNames="MATERIAL_GROUP_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="4d012c00-ff9d-4e97-abcd-baacf6ec45b9" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropColumn for LOCATION of table GRADEBLOCK as column does not exist."
                onFail="MARK_RAN">
            <columnExists tableName="GRADEBLOCK" columnName="LOCATION"/>
        </preConditions>
        <comment>AHS-7648: DropColumn GRADEBLOCK.LOCATION</comment>
        <sql>UPDATE GRADEBLOCK SET DESTINATION_OID = LOCATION WHERE DESTINATION_OID IS NULL AND LOCATION IS NOT NULL</sql>
        <dropColumn columnName="LOCATION" tableName="GRADEBLOCK"/>
        <rollback>
            <addColumn tableName="GRADEBLOCK">
                <column name="LOCATION" type="BIGINT"/>
            </addColumn>
            <sql>UPDATE GRADEBLOCK SET LOCATION = DESTINATION_OID</sql>
        </rollback>
    </changeSet>

    <changeSet id="90b4e515-4012-4d0c-a535-6c2e89aa9d1d" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored DropColumn for MATERIALGROUP of table GRADEBLOCK as column does not exist."
                onFail="MARK_RAN">
            <columnExists tableName="GRADEBLOCK" columnName="MATERIALGROUP"/>
        </preConditions>
        <comment>AHS-7648: DropColumn GRADEBLOCK.MATERIALGROUP</comment>
        <dropColumn columnName="MATERIALGROUP" tableName="GRADEBLOCK"/>
        <rollback>
            <addColumn tableName="GRADEBLOCK">
                <column name="MATERIALGROUP" type="BIGINT"/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="54bcdc34-5319-4a52-8f07-00597d490dbf" author="MineStar" failOnError="false">
        <preConditions
                onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_CONT_VALUE.VALUE as column does not exist or is already not-nullable"
                onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_CONT_VALUE" columnName="VALUE"/>
        </preConditions>
        <comment>AHS-7648: AddNotNullConstraint to GRADEBLOCK_CONT_VALUE.VALUE</comment>
        <sql>UPDATE GRADEBLOCK_CONT_VALUE SET VALUE = 0 WHERE VALUE IS NULL</sql>
        <addNotNullConstraint columnName="VALUE" columnDataType="FLOAT" tableName="GRADEBLOCK_CONT_VALUE"/>
        <rollback>
            <dropNotNullConstraint tableName="GRADEBLOCK_CONT_VALUE" columnName="VALUE" columnDataType="FLOAT"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
