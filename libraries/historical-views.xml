<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="4f458043-8f7f-40d4-b7c8-b94d410d3f16" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>AHS-7698: CreateView VM_JOBCODEGROUP_JOBCODEGROUPS</comment>
        <createView viewName="VM_JOBCODEGROUP_JOBCODEGROUPS" replaceIfExists="true">
            SELECT PARENT_GROUP_OID AS parentOID,
                   JOBCODE_GROUP_OID AS OID,
                   DESCRIPTION AS JobCodeGroup
              FROM ${model}.JOBCODE_GROUP
             WHERE PARENT_GROUP_OID IS NOT NULL
        </createView>
    </changeSet>

    <changeSet id="d362b4de-d474-4e59-ab01-a6bf0174e5d1" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>AHS-7698: CreateView VM_JOBCODEGROUP_JOBCODES</comment>
        <createView viewName="VM_JOBCODEGROUP_JOBCODES" replaceIfExists="true">
            SELECT PARENT_GROUP_OID AS parentOID,
                   JOBCODE_OID AS OID,
                   DESCRIPTION AS description,
                   EXTERNALDESC AS externalDesc,
                   EXTERNALREF AS externalRef,
                   ID AS id,
                   NAME AS name
              FROM ${model}.JOBCODE
             WHERE PARENT_GROUP_OID IS NOT NULL
        </createView>
    </changeSet>

    <changeSet id="92b15f99-8e7d-4931-b046-261c731fbd94" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>AHS-7698: CreateView VM_MACHSSTATE_MACHSSTATEGROUPS</comment>
        <createView viewName="VM_MACHSSTATE_MACHSSTATEGROUPS" replaceIfExists="true">
            SELECT PARENT_GROUP_OID AS parentOID,
                   ACTIVITY_GROUP_OID AS OID,
                   DESCRIPTION AS description,
                   NAME AS name,
                   IS_READ_ONLY AS readOnly,
                   (Select Description from VC_booleanValue Where Code = IS_READ_ONLY) AS readOnly_D
              FROM ${model}.ACTIVITY_GROUP
             WHERE PARENT_GROUP_OID IS NOT NULL
        </createView>
    </changeSet>

    <changeSet id="1ed8b2b9-6550-4b97-9eb8-707a4fe60e3c" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>AHS-7698: CreateView VM_MACHSSTATEGR_MACHSOFTSTATES</comment>
        <createView viewName="VM_MACHSSTATEGR_MACHSOFTSTATES" replaceIfExists="true">
            SELECT PARENT_GROUP_OID AS parentOID,
                   ACTIVITY_OID AS OID,
                   ABBREVIATION AS abbreviation,
                   DESTINATION AS destinationOID,
                   (Select name From V_Destination Where OID = DESTINATION) AS destination_N,
                   ID AS id,
                   NAME AS name,
                   ISWORKING AS working,
                   (Select Description from VC_booleanValue Where Code = ISWORKING) AS working_D
              FROM ${model}.ACTIVITY
             WHERE PARENT_GROUP_OID IS NOT NULL
        </createView>
    </changeSet>

    <changeSet id="a4360ab0-75da-4a24-8e92-85d2a7225c3c" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>AHS-7789: CreateView VO_MACHINE_ONBOARDHWINFO</comment>
        <createView viewName="VO_MACHINE_ONBOARDHWINFO" replaceIfExists="true">
            SELECT V.OID AS PARENTOID, V.*  FROM V_MACHINE_ONBOARD_HARDWARE V
        </createView>
    </changeSet>

    <changeSet id="4f458043-8f7f-40d4-b7c8-b94d410d3f17" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>HLT-1366:Create view for Truck Payload Distribution Report</comment>
        <createView viewName="VM_TRUCKPAYLOADDISTRIBUTION" replaceIfExists="true">
            SELECT
            V_SHIFT.STARTTIME AS SHIFTBEGIN,
            V_SHIFT.ENDTIME AS SHIFTEND,
            V_PRODUCTION_EVENT.EVENTSOURCE AS TRUCKNAME,
            SUM(CASE WHEN PAYLOAD_Q &gt; 390 THEN 1 END) "390_ABOVE",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 360 AND PAYLOAD_Q &lt;=390) THEN 1 END)  "360-390",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 330 AND PAYLOAD_Q &lt;=360) THEN 1 END)  "330-360",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 300 AND PAYLOAD_Q &lt;=330) THEN 1 END)  "300-330",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 270 AND PAYLOAD_Q &lt;=300) THEN 1 END)  "270-300",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 240 AND PAYLOAD_Q &lt;=270) THEN 1 END)  "240-270",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 210 AND PAYLOAD_Q &lt;=240) THEN 1 END)  "210-240",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 180 AND PAYLOAD_Q &lt;=210) THEN 1 END)  "180-210",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 150 AND PAYLOAD_Q &lt;=180) THEN 1 END)  "150-180",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 120 AND PAYLOAD_Q &lt;=150) THEN 1 END)  "120-150",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 90 AND PAYLOAD_Q &lt;=120) THEN 1 END)  "90-120",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 60 AND PAYLOAD_Q &lt;= 90) THEN 1 END)  "60-90",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 30 AND PAYLOAD_Q &lt;= 60) THEN 1 END)  "30-60",
            SUM(CASE WHEN (PAYLOAD_Q &gt; 0 AND PAYLOAD_Q &lt;= 30) THEN 1 END)  "0-30",
            SUM(CASE WHEN (PAYLOAD_Q = 0) THEN 1 END)  "0",
            SUM(CASE WHEN PAYLOAD_Q &lt; 0 THEN 1 END) "Under 0"
            FROM
            V_SHIFT INNER JOIN V_PRODUCTION_EVENT
            ON V_PRODUCTION_EVENT.TIMESTAMP_UTC BETWEEN V_SHIFT.STARTTIME_UTC AND V_SHIFT.ENDTIME_UTC
            GROUP BY
            V_SHIFT.STARTTIME ,
            V_SHIFT.ENDTIME,
            V_PRODUCTION_EVENT.EVENTSOURCE
        </createView>
    </changeSet>

    <changeSet id="4f458043-8f7f-40d4-b7c8-b94d410d3f18" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
        <comment>HLT-1364:Create view for Truck Load Distribution Report</comment>
        <createView viewName="VM_TRUCKLOADTIMEDISTRIBUTION" replaceIfExists="true">
            SELECT
            V_SHIFT.STARTTIME AS SHIFTBEGIN,
            V_SHIFT.ENDTIME AS SHIFTEND,
            V_PRODUCTION_EVENT.EVENTSOURCE AS TRUCKNAME,
            SUM(CASE WHEN LOADDURATION_Q &gt; 390 THEN 1 END) "390_ABOVE",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 360 AND LOADDURATION_Q &lt;=390) THEN 1 END)  "360-390",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 330 AND LOADDURATION_Q &lt;=360) THEN 1 END)  "330-360",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 300 AND LOADDURATION_Q &lt;=330) THEN 1 END)  "300-330",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 270 AND LOADDURATION_Q &lt;=300) THEN 1 END)  "270-300",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 240 AND LOADDURATION_Q &lt;=270) THEN 1 END)  "240-270",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 210 AND LOADDURATION_Q &lt;=240) THEN 1 END)  "210-240",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 180 AND LOADDURATION_Q &lt;=210) THEN 1 END)  "180-210",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 150 AND LOADDURATION_Q &lt;=180) THEN 1 END)  "150-180",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 120 AND LOADDURATION_Q &lt;=150) THEN 1 END)  "120-150",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 90 AND LOADDURATION_Q &lt;=120) THEN 1 END)  "90-120",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 60 AND LOADDURATION_Q &lt;=90) THEN 1 END)  "60-90",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 30 AND LOADDURATION_Q &lt;=60) THEN 1 END)  "30-60",
            SUM(CASE WHEN (LOADDURATION_Q &gt; 0 AND LOADDURATION_Q &lt;=30) THEN 1 END)  "0-30",
            SUM(CASE WHEN (LOADDURATION_Q = 0) THEN 1 END)  "0",
            SUM(CASE WHEN LOADDURATION_Q &lt; 0 THEN 1 END) "Under 0"
            FROM
            V_SHIFT
            INNER JOIN
            V_PRODUCTION_EVENT
            ON
            V_PRODUCTION_EVENT.TIMESTAMP_UTC BETWEEN V_SHIFT.STARTTIME_UTC AND V_SHIFT.ENDTIME_UTC
            GROUP BY
            V_SHIFT.STARTTIME ,
            V_SHIFT.ENDTIME,
            V_PRODUCTION_EVENT.EVENTSOURCE
        </createView>
    </changeSet>

  <changeSet id="d48943eb-9fd7-4c8f-8c66-f399f4a028b2" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
    <comment>FLT-7479: CreateView VO_CYCLE_HOLE</comment>
    <createView viewName="VO_CYCLE_HOLE" replaceIfExists="true">
      SELECT V.OID AS PARENTOID,
        V.HOLEBLASTACTUAL AS BLASTACTUAL,
        V.HOLEBLASTDESIGN AS BLASTDESIGN,
        V.HOLEBREAKINGGROUNDDURATION AS BREAKINGGROUNDDUR,
        V.HOLEBREAKINGGROUNDDURATION_Q AS BREAKINGGROUNDDUR_Q,
        V.HOLEBREAKINGGROUNDDURATION_U AS BREAKINGGROUNDDUR_U,
        V.HOLEDEPTHACTUAL AS DEPTHACTUAL,
        V.HOLEDEPTHACTUAL_Q AS DEPTHACTUAL_Q,
        V.HOLEDEPTHACTUAL_U AS DEPTHACTUAL_U,
        V.HOLEDEPTHDESIGN AS DEPTHDESIGN,
        V.HOLEDEPTHDESIGN_Q AS DEPTHDESIGN_Q,
        V.HOLEDEPTHDESIGN_U AS DEPTHDESIGN_U,
        V.HOLEDRILLFINISH AS DRILLFINISH,
        V.HOLEDRILLFINISH_SOID AS DRILLFINISH_SOID,
        V.HOLEDRILLFINISH_T AS DRILLFINISH_T,
        V.HOLEDRILLFINISH_UTC AS DRILLFINISH_UTC,
        V.HOLEDRILLSTART AS DRILLSTART,
        V.HOLEDRILLSTART_SOID AS DRILLSTART_SOID,
        V.HOLEDRILLSTART_T AS DRILLSTART_T,
        V.HOLEDRILLSTART_UTC AS DRILLSTART_UTC,
        V.HOLEHOLETYPE AS HOLETYPE,
        V.HOLEHOLETYPE_D AS HOLETYPE_D,
        V.HOLENAMEACTUAL AS NAMEACTUAL,
        V.HOLENAMEDESIGN AS NAMEDESIGN,
        V.HOLEPATTERNACTUAL AS PATTERNACTUAL,
        V.HOLEPATTERNDESIGN AS PATTERNDESIGN
      FROM V_CYCLE V
    </createView>
  </changeSet>

  <changeSet id="2ef50f04-f539-42f2-bd78-d95de2a4a431" author="MineStar" failOnError="false" runAlways="true" runOnChange="true">
    <comment>FLT-7479: CreateView VO_CYCLE_HOLEPOSITION</comment>
    <createView viewName="VO_CYCLE_HOLEPOSITION" replaceIfExists="true">
      SELECT V.OID AS PARENTOID,
      V.HOLEPOSITIONACCURACYHORIZONTAL AS ACCURACYHORIZONTAL,
      V.HOLEPOSITIONACCURACYHORIZONT_Q AS ACCURACYHORIZONTAL_Q,
      V.HOLEPOSITIONACCURACYHORIZONT_U AS ACCURACYHORIZONTAL_U,
      V.HOLEPOSITIONACCURACYVERTICAL AS ACCURACYVERTICAL,
      V.HOLEPOSITIONACCURACYVERTICAL_Q AS ACCURACYVERTICAL_Q,
      V.HOLEPOSITIONACCURACYVERTICAL_U AS ACCURACYVERTICAL_U,
      V.HOLEPOSITIONCOLLARELEVATIONACT AS COLLARELEVATIONACTUAL,
      V.HOLEPOSITIONCOLLARELEVATIONA_Q AS COLLARELEVATIONACTUAL_Q,
      V.HOLEPOSITIONCOLLARELEVATIONA_U AS COLLARELEVATIONACTUAL_U,
      V.HOLEPOSITIONDRILLFINISH AS DRILLFINISH,
      V.HOLEPOSITIONDRILLFINISH_SOID AS DRILLFINISH_SOID,
      V.HOLEPOSITIONDRILLFINISH_T AS DRILLFINISH_T,
      V.HOLEPOSITIONDRILLFINISH_UTC AS DRILLFINISH_UTC,
      V.HOLEPOSITIONDRILLSTART AS DRILLSTART,
      V.HOLEPOSITIONDRILLSTART_SOID AS DRILLSTART_SOID,
      V.HOLEPOSITIONDRILLSTART_T AS DRILLSTART_T,
      V.HOLEPOSITIONDRILLSTART_UTC AS DRILLSTART_UTC,
      V.HOLEPOSITIONEASTINGACTUAL AS EASTINGACTUAL,
      V.HOLEPOSITIONEASTINGACTUAL_Q AS EASTINGACTUAL_Q,
      V.HOLEPOSITIONEASTINGACTUAL_U AS EASTINGACTUAL_U,
      V.HOLEPOSITIONEASTINGDESIGN AS EASTINGDESIGN,
      V.HOLEPOSITIONEASTINGDESIGN_Q AS EASTINGDESIGN_Q,
      V.HOLEPOSITIONEASTINGDESIGN_U AS EASTINGDESIGN_U,
      V.HOLEPOSITIONELEVATIONACTUAL AS ELEVATIONACTUAL,
      V.HOLEPOSITIONELEVATIONACTUAL_Q AS ELEVATIONACTUAL_Q,
      V.HOLEPOSITIONELEVATIONACTUAL_U AS ELEVATIONACTUAL_U,
      V.HOLEPOSITIONELEVATIONDESIGN AS ELEVATIONDESIGN,
      V.HOLEPOSITIONELEVATIONDESIGN_Q AS ELEVATIONDESIGN_Q,
      V.HOLEPOSITIONELEVATIONDESIGN_U AS ELEVATIONDESIGN_U,
      V.HOLEPOSITIONHEADINGACTUAL AS HEADINGACTUAL,
      V.HOLEPOSITIONHEADINGACTUAL_Q AS HEADINGACTUAL_Q,
      V.HOLEPOSITIONHEADINGACTUAL_U AS HEADINGACTUAL_U,
      V.HOLEPOSITIONHEADINGDESIGN AS HEADINGDESIGN,
      V.HOLEPOSITIONHEADINGDESIGN_Q AS HEADINGDESIGN_Q,
      V.HOLEPOSITIONHEADINGDESIGN_U AS HEADINGDESIGN_U,
      V.HOLEPOSITIONMASTANGLEACTUAL AS MASTANGLEACTUAL,
      V.HOLEPOSITIONMASTANGLEACTUAL_Q AS MASTANGLEACTUAL_Q,
      V.HOLEPOSITIONMASTANGLEACTUAL_U AS MASTANGLEACTUAL_U,
      V.HOLEPOSITIONMASTANGLEDESIGN AS MASTANGLEDESIGN,
      V.HOLEPOSITIONMASTANGLEDESIGN_Q AS MASTANGLEDESIGN_Q,
      V.HOLEPOSITIONMASTANGLEDESIGN_U AS MASTANGLEDESIGN_U,
      V.HOLEPOSITIONNORTHINGACTUAL AS NORTHINGACTUAL,
      V.HOLEPOSITIONNORTHINGACTUAL_Q AS NORTHINGACTUAL_Q,
      V.HOLEPOSITIONNORTHINGACTUAL_U AS NORTHINGACTUAL_U,
      V.HOLEPOSITIONNORTHINGDESIGN AS NORTHINGDESIGN,
      V.HOLEPOSITIONNORTHINGDESIGN_Q AS NORTHINGDESIGN_Q,
      V.HOLEPOSITIONNORTHINGDESIGN_U AS NORTHINGDESIGN_U
      FROM V_CYCLE V
    </createView>
  </changeSet>

    <changeSet id="9cdd3702-f1ae-4e7b-8ed2-ff5164db4a1e" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <comment>MO-3261 - Create View V_WATERTRUCK_METRICS</comment>
        <createView viewName="V_WATERTRUCK_METRICS" replaceIfExists="true">
            SELECT
                LAG (TIMESTAMP_UTC) OVER (PARTITION BY MACHINE ORDER BY TIMESTAMP_UTC) AS STARTTIME_UTC,
                TIMESTAMP_UTC as ENDTIME_UTC,
                MACHINE as WATERTRUCK_OID,
                MACHINE_NAME as WATERTRUCK_NAME,
                WATER_LEVEL,
                FUEL_LEVEL,
                CASE WHEN LAG (WATER_LEVEL) OVER (PARTITION BY MACHINE ORDER BY TIMESTAMP_UTC) - WATER_LEVEL >= 0
                THEN LAG (WATER_LEVEL) OVER (PARTITION BY MACHINE ORDER BY TIMESTAMP_UTC) - WATER_LEVEL
                ELSE 0
                END AS WATER_USED,
                CASE WHEN LAG (FUEL_LEVEL) OVER (PARTITION BY MACHINE ORDER BY TIMESTAMP_UTC) - FUEL_LEVEL >= 0
                THEN LAG (FUEL_LEVEL) OVER (PARTITION BY MACHINE ORDER BY TIMESTAMP_UTC) - FUEL_LEVEL
                ELSE 0
                END AS FUEL_USED,
                AREA_WATERED,
                WATER_DISTRIBUTED,
                DISTANCE_TRAVELLED,
                MACHINE_MODE
            FROM WATERTRUCK_METRICS_EVENT
        </createView>
    </changeSet>

    <changeSet id="34496c38-4271-4262-bc7b-b6f4663ba6b4" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <comment>MO-3261 - Create View V_WATERTRUCK_REFILL_CYCLE</comment>
        <createView viewName="V_WATERTRUCK_REFILL_CYCLE" replaceIfExists="true">
            SELECT
                LAG (TIMESTAMP_UTC) OVER (PARTITION BY WATERTRUCK_OID ORDER BY TIMESTAMP_UTC) AS STARTTIME_UTC,
                TIMESTAMP_UTC as ENDTIME_UTC,
                WATERTRUCK_OID,
                WATERTRUCK_NAME,
                REFILL_AMOUNT,
                DURATION,
                WATERTRUCK_MODE as MACHINE_MODE
            FROM WATERTRUCK_REFILL_EVENT
        </createView>
    </changeSet>

</databaseChangeLog>
