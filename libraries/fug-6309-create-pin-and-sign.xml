<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="d2ef1bc2-7a18-48a2-9895-fdb91abbcf1b" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for PIN as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="PIN"/>
            </not>
        </preConditions>
        <comment>FUG-6309: CreateTable PIN</comment>
        <createTable tablespace="MW_ENT" remarks="A pin is used to mark the location of an object or point of interest." tableName="PIN">
            <column name="PIN_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this wall is active or archived. (This flag is '1' if it is active and '0' if archived.)">
                <constraints nullable="false"/>
            </column>
            <column name="MODEL_UPDATE_VERSION" type="BIGINT" remarks="Copy of the system wide version number"/>
            <column name="TEXT" type="VARCHAR(254)" remarks="The text to display for the pin">
                <constraints nullable="false"/>
            </column>
            <column name="POSITION_X" type="DOUBLE" remarks="The position of the pin."/>
            <column name="POSITION_Y" type="DOUBLE" remarks="The position of the pin."/>
            <column name="POSITION_Z" type="DOUBLE" remarks="The position of the pin."/>
            <column name="LAST_UPDATED_BY" type="BIGINT" remarks="A reference to the user (MSMODEL.USER) who last updated the pin.">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_UPDATED_ON_UTC" type="DATETIME2" remarks="The utc time the cycle was last updated."/>
        </createTable>
        <addPrimaryKey columnNames="PIN_OID" constraintName="PIN_PK" tablespace="MW_IDXENT" tableName="PIN"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="140929d2-679c-4199-8a34-157c8085787a" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SIGN as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SIGN"/>
            </not>
        </preConditions>
        <comment>FUG-6309: CreateTable SIGN</comment>
        <createTable tablespace="MW_ENT" remarks="A sign is used to mark the location of an sign." tableName="SIGN">
            <column name="SIGN_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this wall is active or archived. (This flag is '1' if it is active and '0' if archived.)">
                <constraints nullable="false"/>
            </column>
            <column name="MODEL_UPDATE_VERSION" type="BIGINT" remarks="Copy of the system wide version number"/>
            <column name="TEXT" type="VARCHAR(254)" remarks="The type of sign">
                <constraints nullable="false"/>
            </column>
            <column name="CONTACT" type="VARCHAR(254)" remarks="The contact information for the sign"/>
            <column name="NOTES" type="VARCHAR(1024)" remarks="The notes about the sign"/>
            <column name="IDENTIFIER" type="VARCHAR(254)" remarks="The sign identifier"/>
            <column name="CENTROID_POINT_X" type="DOUBLE" remarks="The signs polygon"/>
            <column name="CENTROID_POINT_Y" type="DOUBLE" remarks="The signs polygon"/>
            <column name="CENTROID_POINT_Z" type="DOUBLE" remarks="The signs polygon"/>
            <column name="LAST_UPDATED_BY" type="BIGINT" remarks="A reference to the user (MSMODEL.USER) who applied the override.">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_UPDATED_ON_UTC" type="DATETIME2" remarks="The utc time the cycle was last updated."/>
        </createTable>
        <addPrimaryKey columnNames="SIGN_OID" constraintName="SIGN_PK" tablespace="MW_IDXENT" tableName="SIGN"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="24ab3b04-dfdd-4bd0-9ce0-094b2d138271" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SIGN_POLYGON_POINT as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SIGN_POLYGON_POINT"/>
            </not>
        </preConditions>
        <comment>FUG-6309: CreateTable SIGN_POLYGON_POINT</comment>
        <createTable tableName="SIGN_POLYGON_POINT">
            <column name="SIGN_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="POINT_NR" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="POINT_X" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="POINT_Y" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="POINT_Z" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="SIGN_OID,POINT_NR" constraintName="SIGN_POLYGON_POINT_PK" tableName="SIGN_POLYGON_POINT"/>
        <modifySql dbms="mssql,h2,postgresql" applyToRollback="true">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="08d78bc1-6ddd-4615-90b0-72a621e25d6d" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PIN_LAST_UPDATED_BY_FK to table PIN as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PIN" columnName="LAST_UPDATED_BY"/>
            <columnExists tableName="USER1" columnName="USER_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PIN" foreignKeyName="PIN_LAST_UPDATED_BY_FK"/>
            </not>
        </preConditions>
        <comment>FUG-6309: AddForeignKeyConstraint PIN_LAST_UPDATED_BY_FK to PIN (LAST_UPDATED_BY)</comment>
        <sql>DELETE FROM PIN WHERE LAST_UPDATED_BY IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM USER1 WHERE USER1.USER_OID = PIN.LAST_UPDATED_BY)</sql>
        <addForeignKeyConstraint baseTableName="PIN" baseColumnNames="LAST_UPDATED_BY" constraintName="PIN_LAST_UPDATED_BY_FK" referencedTableName="USER1" referencedColumnNames="USER_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PIN" constraintName="PIN_LAST_UPDATED_BY_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="99b8dfbd-7e5d-475f-b7db-3933e2f8264a" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SIGN_LAST_UPDATED_BY_FK to table SIGN as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="SIGN" columnName="LAST_UPDATED_BY"/>
            <columnExists tableName="USER1" columnName="USER_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SIGN" foreignKeyName="SIGN_LAST_UPDATED_BY_FK"/>
            </not>
        </preConditions>
        <comment>FUG-6309: AddForeignKeyConstraint SIGN_LAST_UPDATED_BY_FK to SIGN (LAST_UPDATED_BY)</comment>
        <sql>DELETE FROM SIGN WHERE LAST_UPDATED_BY IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM USER1 WHERE USER1.USER_OID = SIGN.LAST_UPDATED_BY)</sql>
        <addForeignKeyConstraint baseTableName="SIGN" baseColumnNames="LAST_UPDATED_BY" constraintName="SIGN_LAST_UPDATED_BY_FK" referencedTableName="USER1" referencedColumnNames="USER_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SIGN" constraintName="SIGN_LAST_UPDATED_BY_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="f68092f3-3a63-4cc9-a2af-5a8ee5cb2b9a" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SIGN_POLYGON_POINT_SIGN_OID_FK to table SIGN_POLYGON_POINT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="SIGN_POLYGON_POINT" columnName="SIGN_OID"/>
            <columnExists tableName="SIGN" columnName="SIGN_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SIGN_POLYGON_POINT" foreignKeyName="SIGN_POLYGON_POINT_SIGN_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-6309: AddForeignKeyConstraint SIGN_POLYGON_POINT_SIGN_OID_FK to SIGN_POLYGON_POINT (SIGN_OID)</comment>
        <sql>DELETE FROM SIGN_POLYGON_POINT WHERE SIGN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM SIGN WHERE SIGN.SIGN_OID = SIGN_POLYGON_POINT.SIGN_OID)</sql>
        <addForeignKeyConstraint baseTableName="SIGN_POLYGON_POINT" baseColumnNames="SIGN_OID" constraintName="SIGN_POLYGON_POINT_SIGN_OID_FK" referencedTableName="SIGN" referencedColumnNames="SIGN_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SIGN_POLYGON_POINT" constraintName="SIGN_POLYGON_POINT_SIGN_OID_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
