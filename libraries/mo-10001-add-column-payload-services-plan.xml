<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="1aa55222-4405-441e-ab9d-d3f83ffc0aba" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored RenameColumn for GROUND_SCALE of table PLAN_MODEL as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="PLAN_MODEL" columnName="GROUND_SCALE"/>
        </preConditions>
        <comment>MO-10001 : Drop Column PLAN_MODEL.GROUND_SCALE</comment>
        <dropColumn columnName="GROUND_SCALE" tableName="PLAN_MODEL"/>
        <rollback/>
    </changeSet>

    <changeSet id="776acc83-c9e8-4eec-9344-4bd6e320a367" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for PLAN_MODEL_GROUND_SCALE_FK of table PLAN_MODEL as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="PLAN_MODEL" foreignKeyName="PLAN_MODEL_GROUND_SCALE_FK"/>
        </preConditions>
        <comment>MO-10001 DropForeignKeyConstraint PLAN_MODEL_GROUND_SCALE_FK from PLAN_MODEL (MACHINE_OID)</comment>
        <dropForeignKeyConstraint baseTableName="PLAN_MODEL" constraintName="PLAN_MODEL_GROUND_SCALE_FK"/>
        <rollback/>
    </changeSet>

    <changeSet id="4d0817db-2da0-42dd-becf-2fbaa2b4706a" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for PAYLOAD_SERVICE to table PLAN_MODEL as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="PLAN_MODEL"/>
            <not>
                <columnExists tableName="PLAN_MODEL" columnName="PAYLOAD_SERVICE"/>
            </not>
        </preConditions>
        <comment>MO-10001 AddColumn PLAN_MODEL.PAYLOAD_SERVICE</comment>
        <addColumn tableName="PLAN_MODEL">
            <column name="PAYLOAD_SERVICE" type="BIGINT" remarks="The payload service that this plan is for."/>
        </addColumn>
    </changeSet>

    <changeSet id="ac811043-b996-4a5a-b98e-d9a761076498" author="MineStar" context="Machine_Tracking/Machine_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PLAN_MODEL_PAYLOAD_SERVICE_FK to table PLAN_MODEL as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PLAN_MODEL" columnName="PAYLOAD_SERVICE"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PLAN_MODEL" foreignKeyName="PLAN_MODEL_PAYLOAD_SERVICE_FK"/>
            </not>
        </preConditions>
        <comment>MO-10001 AddForeignKeyConstraint PLAN_MODEL_PAYLOAD_SERVICE_FK to PLAN_MODEL (PAYLOAD_SERVICE)</comment>
        <sql>UPDATE PLAN_MODEL SET PAYLOAD_SERVICE = NULL WHERE PAYLOAD_SERVICE IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = PLAN_MODEL.PAYLOAD_SERVICE)</sql>
        <addForeignKeyConstraint baseTableName="PLAN_MODEL" baseColumnNames="PAYLOAD_SERVICE" constraintName="PLAN_MODEL_PAYLOAD_SERVICE_FK" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PLAN_MODEL" constraintName="PLAN_MODEL_PAYLOAD_SERVICE_FK"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
