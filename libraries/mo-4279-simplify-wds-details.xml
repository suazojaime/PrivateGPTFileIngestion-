<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="ee438400-7b59-4e4b-8594-071396a6cf3f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for WDS_DETAILS.REAR_SPRAY_HEAD_COUNT as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="WDS_DETAILS" columnName="REAR_SPRAY_HEAD_COUNT"/>
        </preConditions>
        <comment>MO-4279: AddNotNullConstraint to WDS_DETAILS.REAR_SPRAY_HEAD_COUNT</comment>
        <sql>UPDATE WDS_DETAILS SET REAR_SPRAY_HEAD_COUNT = 0 WHERE REAR_SPRAY_HEAD_COUNT IS NULL</sql>
        <addNotNullConstraint columnName="REAR_SPRAY_HEAD_COUNT" columnDataType="INT" tableName="WDS_DETAILS"/>
        <rollback>
            <dropNotNullConstraint tableName="WDS_DETAILS" columnName="REAR_SPRAY_HEAD_COUNT" columnDataType="INT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="35d548e3-e020-4df7-ac35-8014ac96a6ed" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for WDS_DETAILS.LEFT_SPRAY_HEAD_COUNT as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="WDS_DETAILS" columnName="LEFT_SPRAY_HEAD_COUNT"/>
        </preConditions>
        <comment>MO-4279: AddNotNullConstraint to WDS_DETAILS.LEFT_SPRAY_HEAD_COUNT</comment>
        <sql>UPDATE WDS_DETAILS SET LEFT_SPRAY_HEAD_COUNT = 0 WHERE LEFT_SPRAY_HEAD_COUNT IS NULL</sql>
        <addNotNullConstraint columnName="LEFT_SPRAY_HEAD_COUNT" columnDataType="INT" tableName="WDS_DETAILS"/>
        <rollback>
            <dropNotNullConstraint tableName="WDS_DETAILS" columnName="LEFT_SPRAY_HEAD_COUNT" columnDataType="INT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="ec9934c6-61bd-4f9b-a73d-e7138723fad3" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for WDS_DETAILS.RIGHT_SPRAY_HEAD_COUNT as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="WDS_DETAILS" columnName="RIGHT_SPRAY_HEAD_COUNT"/>
        </preConditions>
        <comment>MO-4279: AddNotNullConstraint to WDS_DETAILS.RIGHT_SPRAY_HEAD_COUNT</comment>
        <sql>UPDATE WDS_DETAILS SET RIGHT_SPRAY_HEAD_COUNT = 0 WHERE RIGHT_SPRAY_HEAD_COUNT IS NULL</sql>
        <addNotNullConstraint columnName="RIGHT_SPRAY_HEAD_COUNT" columnDataType="INT" tableName="WDS_DETAILS"/>
        <rollback>
            <dropNotNullConstraint tableName="WDS_DETAILS" columnName="RIGHT_SPRAY_HEAD_COUNT" columnDataType="INT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="f2589410-7108-4bce-9dc6-b855cec5e003" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for MACHINECLASS_SPRAYHEADID_UQ of table WDS_SPRAY_HEADS as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="MACHINECLASS_SPRAYHEADID_UQ" tableName="WDS_SPRAY_HEADS"/>
        </preConditions>
        <comment>MO-4279: DropIndex MACHINECLASS_SPRAYHEADID_UQ from WDS_SPRAY_HEADS (MACHINE_CLASS_OID,SPRAY_HEAD_ID)</comment>
        <dropIndex indexName="MACHINECLASS_SPRAYHEADID_UQ" tableName="WDS_SPRAY_HEADS"/>
        <rollback>
            <createIndex unique="true" tableName="WDS_SPRAY_HEADS" indexName="MACHINECLASS_SPRAYHEADID_UQ">
                <column name="MACHINE_CLASS_OID"/>
                <column name="SPRAY_HEAD_ID"/>
            </createIndex>
        </rollback>
    </changeSet>
    
    <changeSet id="9971781f-a213-4fe0-9d1a-4cfca1c52166" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for SPRAY_HEAD_GROUPS to table WDS_SPRAY_HEADS as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="WDS_SPRAY_HEADS"/>
            <not>
                <columnExists tableName="WDS_SPRAY_HEADS" columnName="SPRAY_HEAD_GROUPS"/>
            </not>
        </preConditions>
        <comment>MO-4279: AddColumn WDS_SPRAY_HEADS.SPRAY_HEAD_GROUPS</comment>
        <addColumn tableName="WDS_SPRAY_HEADS">
            <column name="SPRAY_HEAD_GROUPS" type="VARCHAR(255)"/>
        </addColumn>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = ''</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'REAR_ALL,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.rearAll')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'REAR_CENTER,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.rearCenter')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'REAR_LEFT,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.rearLeft')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'REAR_OUTER,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.rearOuter')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'REAR_RIGHT,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.rearRight')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'SIDE_LEFT,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.sideLeft')</sql>
        <sql>UPDATE WDS_SPRAY_HEADS SET SPRAY_HEAD_GROUPS = SPRAY_HEAD_GROUPS + 'SIDE_RIGHT,' WHERE EXISTS (SELECT 'x' FROM SPRAY_HEAD_GROUP_ALLOCATION A INNER JOIN SPRAY_HEAD_GROUP G ON A.SPRAY_HEAD_GROUP_OID = G.OID WHERE A.SPRAY_HEAD_OID = WDS_SPRAY_HEAD_OID AND G.NAME = 'sprayHeadGroup.sideRight')</sql>
        <rollback>
            <dropColumn tableName="WDS_SPRAY_HEADS" columnName="SPRAY_HEAD_GROUPS"/>
        </rollback>
    </changeSet>

    <changeSet id="e1e585cb-e338-4fbf-bb54-07c4efa583bd" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for SPRAY_HEAD_GROUP_ALLOCATION as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="SPRAY_HEAD_GROUP_ALLOCATION"/>
        </preConditions>
        <comment>MO-4279: DropTable SPRAY_HEAD_GROUP_ALLOCATION</comment>
        <dropTable tableName="SPRAY_HEAD_GROUP_ALLOCATION"/>
        <rollback/>
    </changeSet>

    <changeSet id="89f69f93-466a-4d4b-9ff4-2202235baab2" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for SPRAY_HEAD_GROUP as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="SPRAY_HEAD_GROUP"/>
        </preConditions>
        <comment>MO-4279: DropTable SPRAY_HEAD_GROUP</comment>
        <dropTable tableName="SPRAY_HEAD_GROUP"/>
        <rollback/>
    </changeSet>

    <changeSet id="157cc3ff-0d88-40a6-856d-49414599d971" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for WDS_SPRAY_HEADS_PK of table WDS_SPRAY_HEADS as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="WDS_SPRAY_HEADS_PK" tableName="WDS_SPRAY_HEADS"/>
        </preConditions>
        <comment>MO-4279: DropPrimaryKey WDS_SPRAY_HEADS_PK from WDS_SPRAY_HEADS (WDS_SPRAY_HEAD_OID)</comment>
        <dropPrimaryKey constraintName="WDS_SPRAY_HEADS_PK" tableName="WDS_SPRAY_HEADS"/>
        <rollback>
            <addPrimaryKey columnNames="WDS_SPRAY_HEAD_OID" constraintName="WDS_SPRAY_HEADS_PK" tableName="WDS_SPRAY_HEADS"/>
        </rollback>
    </changeSet>

    <changeSet id="1b821997-e628-4bd9-a7a4-df6b2a52e70e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for WDS_SPRAY_HEAD_OID of table WDS_SPRAY_HEADS as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="WDS_SPRAY_HEADS" columnName="WDS_SPRAY_HEAD_OID"/>
        </preConditions>
        <comment>MO-4279: DropColumn WDS_SPRAY_HEADS.WDS_SPRAY_HEAD_OID</comment>
        <dropColumn columnName="WDS_SPRAY_HEAD_OID" tableName="WDS_SPRAY_HEADS"/>
        <rollback>
            <addColumn tableName="WDS_SPRAY_HEADS">
                <column name="WDS_SPRAY_HEAD_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="d72e1693-e980-4962-9a29-606642ab9d11" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for WDS_SPRAY_HEAD_PK to table WDS_SPRAY_HEADS as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="WDS_SPRAY_HEADS"/>
            <not>
                <primaryKeyExists primaryKeyName="WDS_SPRAY_HEAD_PK" tableName="WDS_SPRAY_HEADS"/>
            </not>
        </preConditions>
        <comment>MO-4279: AddPrimaryKey WDS_SPRAY_HEAD_PK to WDS_SPRAY_HEADS (MACHINE_CLASS_OID,SPRAY_HEAD_ID)</comment>
        <sql dbms="mssql">WITH CTE AS (SELECT ROW_NUMBER() OVER (PARTITION BY MACHINE_CLASS_OID, SPRAY_HEAD_ID ORDER BY %%physloc%%) AS ROW_NUM FROM WDS_SPRAY_HEADS) DELETE FROM CTE WHERE ROW_NUM &gt; 1</sql>
        <addPrimaryKey columnNames="MACHINE_CLASS_OID,SPRAY_HEAD_ID" constraintName="WDS_SPRAY_HEAD_PK" tableName="WDS_SPRAY_HEADS"/>
        <rollback>
            <dropPrimaryKey constraintName="WDS_SPRAY_HEAD_PK" tableName="WDS_SPRAY_HEADS"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
