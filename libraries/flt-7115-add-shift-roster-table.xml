<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2018, Caterpillar, Brisbane Australia. All rights reserved. -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="1ca2521a-ba9b-4821-96a1-af39fd68b2a0" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SHIFT_ROSTER as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SHIFT_ROSTER"/>
            </not>
        </preConditions>
        <comment>FLT-7115: CreateTable SHIFT_ROSTER</comment>
        <createTable tablespace="MW_OBJ" remarks="An instance of a shift." tableName="SHIFT_ROSTER">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="PATTERN_DATE_UTC" type="DATETIME2" defaultValue="01-JAN-1970" remarks="The time that the pattern reoccurs.">
                <constraints nullable="false"/>
            </column>
            <column name="DAYS_IN_PATTERN" type="INT" defaultValueNumeric="0" remarks="The number of days in this shift roster pattern.">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="SHIFT_ROSTER_PK" tablespace="MW_IDXOBJ" tableName="SHIFT_ROSTER"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="8b3aaa32-fdd0-4860-af2d-ca481920b6e7" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SHIFT_ROSTER_ITEM as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SHIFT_ROSTER_ITEM"/>
            </not>
        </preConditions>
        <comment>FLT-7115: CreateTable SHIFT_ROSTER_ITEM</comment>
        <createTable tablespace="MW_ENT" remarks="The start offset for the shift." tableName="SHIFT_ROSTER_ITEM">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="START_OFFSET" type="BIGINT"/>
            <column name="CREW" type="BIGINT"/>
            <column name="SHIFT_TYPE" type="TINYINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="d8f8a3cc-3595-4263-9ba8-0e519873cd1d" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SHIFT_ROSTER_ITEM_OID_FK to table SHIFT_ROSTER_ITEM as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="SHIFT_ROSTER_ITEM" columnName="OID"/>
            <columnExists tableName="SHIFT_ROSTER" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SHIFT_ROSTER_ITEM" foreignKeyName="SHIFT_ROSTER_ITEM_OID_FK"/>
            </not>
        </preConditions>
        <comment>FLT-7115: AddForeignKeyConstraint SHIFT_ROSTER_ITEM_OID_FK to SHIFT_ROSTER_ITEM (OID)</comment>
        <sql>DELETE FROM SHIFT_ROSTER_ITEM WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM SHIFT_ROSTER WHERE SHIFT_ROSTER.OID = SHIFT_ROSTER_ITEM.OID)</sql>
        <addForeignKeyConstraint baseTableName="SHIFT_ROSTER_ITEM" baseColumnNames="OID" constraintName="SHIFT_ROSTER_ITEM_OID_FK" referencedTableName="SHIFT_ROSTER" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SHIFT_ROSTER_ITEM" constraintName="SHIFT_ROSTER_ITEM_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="6ffd6b3f-f5c8-4344-9207-ee88d3b60d0d" author="MineStar" context="Platform/Platform_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SHIFT_ROSTER_ITEM_CREW_FK to table SHIFT_ROSTER_ITEM as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="SHIFT_ROSTER_ITEM" columnName="CREW"/>
            <columnExists tableName="CREW" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SHIFT_ROSTER_ITEM" foreignKeyName="SHIFT_ROSTER_ITEM_CREW_FK"/>
            </not>
        </preConditions>
        <comment>FLT-7115: AddForeignKeyConstraint SHIFT_ROSTER_ITEM_CREW_FK to SHIFT_ROSTER_ITEM (CREW)</comment>
        <sql>UPDATE SHIFT_ROSTER_ITEM SET CREW = NULL WHERE CREW IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM CREW WHERE CREW.OID = SHIFT_ROSTER_ITEM.CREW)</sql>

        <addForeignKeyConstraint baseTableName="SHIFT_ROSTER_ITEM" baseColumnNames="CREW" constraintName="SHIFT_ROSTER_ITEM_CREW_FK" referencedTableName="CREW"
                                 referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SHIFT_ROSTER_ITEM" constraintName="SHIFT_ROSTER_ITEM_CREW_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
