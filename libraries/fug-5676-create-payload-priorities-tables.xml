<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="3e63f3ea-c0ee-4aa2-9ac2-f4cb1ad10aac" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for MACHINE_PAYLOAD_PRIORITIES as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="MACHINE_PAYLOAD_PRIORITIES"/>
            </not>
        </preConditions>
        <comment>FUG-5676: CreateTable MACHINE_PAYLOAD_PRIORITIES</comment>
        <createTable tablespace="MW_ENT" remarks="An list of payload source systems ordered by priority." tableName="MACHINE_PAYLOAD_PRIORITIES">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SORT_ORDER" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="SOURCE_SYSTEM" type="TINYINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,SORT_ORDER" constraintName="MACHINE_PAYLOAD_PRIORITIES_PK" tablespace="MW_IDXENT" tableName="MACHINE_PAYLOAD_PRIORITIES"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="7e61990c-111c-4ea0-88b4-8873243136f4" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_PAYLOAD_PRIORITIES_FK1 to table MACHINE_PAYLOAD_PRIORITIES as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="MACHINE_PAYLOAD_PRIORITIES" columnName="OID"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_PAYLOAD_PRIORITIES" foreignKeyName="MACHINE_PAYLOAD_PRIORITIES_FK1"/>
            </not>
        </preConditions>
        <comment>FUG-5676: AddForeignKeyConstraint MACHINE_PAYLOAD_PRIORITIES_FK1 to MACHINE_PAYLOAD_PRIORITIES (OID)</comment>
        <sql>DELETE FROM MACHINE_PAYLOAD_PRIORITIES WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = MACHINE_PAYLOAD_PRIORITIES.OID)</sql>
        <addForeignKeyConstraint baseTableName="MACHINE_PAYLOAD_PRIORITIES" baseColumnNames="OID" constraintName="MACHINE_PAYLOAD_PRIORITIES_FK1" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_PAYLOAD_PRIORITIES" constraintName="MACHINE_PAYLOAD_PRIORITIES_FK1"/>
        </rollback>
    </changeSet>

    <!--Fix max name length 30 chars -->
    <changeSet id="44d0bd4f-e040-4291-9054-9d66f2424689" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for MACHINE_CLASS_PAYLOAD_PRIORITIES as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="MACHINE_CLASS_PAYLOAD_PRIORITIES"/>
        </preConditions>
        <comment>FUG-5676: DropTable MACHINE_CLASS_PAYLOAD_PRIORITIES</comment>
        <dropTable tableName="MACHINE_CLASS_PAYLOAD_PRIORITIES"/>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>
    <changeSet id="c562ba20-29fb-4300-986a-9fd5f946e275" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for MACHINE_CLS_PAYLOAD_PRIORITIES as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="MACHINE_CLS_PAYLOAD_PRIORITIES"/>
            </not>
        </preConditions>
        <comment>FUG-5676: CreateTable MACHINE_CLS_PAYLOAD_PRIORITIES</comment>
        <createTable tablespace="MW_ENT" remarks="An list of payload source systems ordered by priority." tableName="MACHINE_CLS_PAYLOAD_PRIORITIES">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SORT_ORDER" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="SOURCE_SYSTEM" type="TINYINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,SORT_ORDER" constraintName="MACHINE_CLS_PAYLOAD_PRIORIT_PK" tablespace="MW_IDXENT" tableName="MACHINE_CLS_PAYLOAD_PRIORITIES"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="e0535357-327e-4e4f-983b-3df698e003f5" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_CLS_PAYLOAD_PRIORI_FK1 to table MACHINE_CLS_PAYLOAD_PRIORITIES as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="MACHINE_CLS_PAYLOAD_PRIORITIES" columnName="OID"/>
            <columnExists tableName="MACHINECLASS" columnName="MACHINECLASS_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_CLS_PAYLOAD_PRIORITIES" foreignKeyName="MACHINE_CLS_PAYLOAD_PRIORI_FK1"/>
            </not>
        </preConditions>
        <comment>FUG-5676: AddForeignKeyConstraint MACHINE_CLS_PAYLOAD_PRIORI_FK1 to MACHINE_CLS_PAYLOAD_PRIORITIES (OID)</comment>
        <sql>DELETE FROM MACHINE_CLS_PAYLOAD_PRIORITIES WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINECLASS WHERE MACHINECLASS.MACHINECLASS_OID = MACHINE_CLS_PAYLOAD_PRIORITIES.OID)</sql>
        <addForeignKeyConstraint baseTableName="MACHINE_CLS_PAYLOAD_PRIORITIES" baseColumnNames="OID" constraintName="MACHINE_CLS_PAYLOAD_PRIORI_FK1" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_CLS_PAYLOAD_PRIORITIES" constraintName="MACHINE_CLS_PAYLOAD_PRIORI_FK1"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
