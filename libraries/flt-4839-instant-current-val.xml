<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


    <changeSet id="15bdd265-6945-4b8b-a956-d4dbec55b190" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn and AddForeignKeyConstraint key constraint for CYCLE_OID to table BLEND_INFORMATION_RECORD as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="BLEND_INFORMATION_RECORD"/>
            <not>
                <columnExists tableName="BLEND_INFORMATION_RECORD" columnName="CYCLE_OID"/>
            </not>
        </preConditions>
        <comment>[FLT-4839] 4.6 AddColumn BLEND_INFORMATION_RECORD.CYCLE_OID</comment>
        <addColumn tableName="BLEND_INFORMATION_RECORD">
            <column name="CYCLE_OID" type="BIGINT" remarks="referenced cycle">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint baseTableName="BLEND_INFORMATION_RECORD" baseColumnNames="CYCLE_OID" constraintName="BLND_INF_REC_CYC_OID_FK" referencedTableName="CYCLE" referencedColumnNames="CYCLE_OID" deleteCascade="false"/>
    </changeSet>

    <changeSet id="60ecf03a-00b6-4755-b23b-fb6aec2bf23a" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CURRENT_VALUE_TYPE to table CURRENT_VALUE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="CURRENT_VALUE"/>
            <not>
                <columnExists tableName="CURRENT_VALUE" columnName="CURRENT_VALUE_TYPE"/>
            </not>
        </preConditions>
        <comment>[FLT-4839] 4.6 AddColumn CURRENT_VALUE.CURRENT_VALUE_TYPE</comment>
        <addColumn tableName="CURRENT_VALUE">
            <column name="CURRENT_VALUE_TYPE" type="VARCHAR(255)" remarks="Current value type CONTROL | INSTANT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="b32c7011-076d-46b2-be6a-90a984e3001f" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored update to CURRENT_VALUE.CURRENT_VALUE_TYPE rows already updated" onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from current_value where current_value_type = 'CONTROL'</sqlCheck>
        </preConditions>
        <comment>[FLT-4839] 4.6 Update new column CURRENT_VALUE_TYPE</comment>
        <update tableName="CURRENT_VALUE">
            <column name="CURRENT_VALUE_TYPE" value="CONTROL"/>
        </update>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

</databaseChangeLog>
