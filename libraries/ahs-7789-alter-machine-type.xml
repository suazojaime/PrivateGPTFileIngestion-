<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="054cb4a9-22c0-4b51-b73c-f73f4f8f7728" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for MACHINE_TYPE_TYPE_OID_FK of table MACHINE_TYPE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="MACHINE_TYPE" foreignKeyName="MACHINE_TYPE_TYPE_OID_FK"/>
        </preConditions>
        <comment>AHS-7798: DropForeignKeyConstraint MACHINE_TYPE_TYPE_OID_FK from MACHINE_TYPE (TYPE_OID)</comment>
        <dropForeignKeyConstraint baseTableName="MACHINE_TYPE" constraintName="MACHINE_TYPE_TYPE_OID_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="MACHINE_TYPE" baseColumnNames="TYPE_OID" constraintName="MACHINE_TYPE_TYPE_OID_FK" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="49951b11-b3dd-42e9-9b05-4246aa0323e0" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_TYPE_TYPE_OID_FK to table MACHINE_TYPE as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="MACHINE_TYPE" columnName="TYPE_OID"/>
            <columnExists tableName="MACHINECLASS" columnName="MACHINECLASS_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_TYPE" foreignKeyName="MACHINE_TYPE_TYPE_OID_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7798: AddForeignKeyConstraint MACHINE_TYPE_TYPE_OID_FK to MACHINE_TYPE (TYPE_OID)</comment>
        <sql>DELETE FROM MACHINE_TYPE WHERE TYPE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINECLASS WHERE MACHINECLASS.MACHINECLASS_OID = MACHINE_TYPE.TYPE_OID)</sql>
        <addForeignKeyConstraint baseTableName="MACHINE_TYPE" baseColumnNames="TYPE_OID" constraintName="MACHINE_TYPE_TYPE_OID_FK" referencedTableName="MACHINECLASS" referencedColumnNames="MACHINECLASS_OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_TYPE" constraintName="MACHINE_TYPE_TYPE_OID_FK"/>
        </rollback>
    </changeSet>
    
</databaseChangeLog>
