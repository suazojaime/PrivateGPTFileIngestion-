<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="147d1ead-aec3-4c92-aa3c-aeef59da0ce2" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for PARENT_GROUP_OID to table JOBCODE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="JOBCODE"/>
            <not>
                <columnExists tableName="JOBCODE" columnName="PARENT_GROUP_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7698: AddColumn JOBCODE.PARENT_GROUP_OID</comment>
        <addColumn tableName="JOBCODE">
            <column name="PARENT_GROUP_OID" type="BIGINT" remarks="A reference to the parent group"/>
        </addColumn>
    </changeSet>

    <changeSet id="a8a1655b-ed84-43c4-9308-51a0558bf735" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for JOB_CODE_GROUP_ELEMENT as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="JOB_CODE_GROUP_ELEMENT"/>
            <columnExists tableName="JOBCODE" columnName="PARENT_GROUP_OID"/>
        </preConditions>
        <comment>AHS-7698: DropTable JOB_CODE_GROUP_ELEMENT</comment>
        <sql>
            UPDATE JOBCODE SET PARENT_GROUP_OID = (SELECT MIN(OID) FROM JOB_CODE_GROUP_ELEMENT WHERE JOB_CODE_GROUP_ELEMENT.JOB_CODE_OID = JOBCODE.JOBCODE_OID)
        </sql>
        <dropTable tableName="JOB_CODE_GROUP_ELEMENT"/>
        <rollback>
            <createTable tablespace="MW_ENT" remarks="The child job codes." tableName="JOB_CODE_GROUP_ELEMENT">
                <column name="OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="JOB_CODE_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </createTable>
            <addPrimaryKey columnNames="OID,JOB_CODE_OID" constraintName="JOB_CODE_GROUP_ELEMENT_PK" tablespace="MW_IDXENT" tableName="JOB_CODE_GROUP_ELEMENT"/>
            <sql>
                INSERT INTO JOB_CODE_GROUP_ELEMENT (OID, JOB_CODE_OID) SELECT PARENT_GROUP_OID, JOBCODE_OID FROM JOBCODE WHERE PARENT_GROUP_OID IS NOT NULL
            </sql>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="7c7aebf5-ee55-4565-ba55-870675bdb774" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropIndex for JOBCODEGROUP_1R of table JOBCODE_GROUP as index does not exist." onFail="MARK_RAN">
            <indexExists indexName="JOBCODEGROUP_1R" tableName="JOBCODE_GROUP"/>
        </preConditions>
        <comment>AHS-7698: DropIndex JOBCODEGROUP_1R from JOBCODE_GROUP (NAME,JOBCODE_GROUP_OID)</comment>
        <dropIndex indexName="JOBCODEGROUP_1R" tableName="JOBCODE_GROUP"/>
        <rollback>
            <createIndex unique="false" tablespace="MW_IDXENT" tableName="JOBCODE_GROUP" indexName="JOBCODEGROUP_1R">
                <column name="NAME"/>
                <column name="JOBCODE_GROUP_OID"/>
            </createIndex>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="baf86218-f2b1-494d-abce-4d5f8bd9b99a" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for JOBCODE_GROUP.NAME as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="JOBCODE_GROUP" columnName="NAME"/>
        </preConditions>
        <comment>AHS-7698: AddNotNullConstraint to JOBCODE_GROUP.NAME</comment>
        <addNotNullConstraint columnName="NAME" columnDataType="VARCHAR(254)" tableName="JOBCODE_GROUP"/>
    </changeSet>

    <changeSet id="73a64b8e-cfeb-4fd2-9e79-2707ecc5ea03" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored CreateIndex for JOBCODEGROUP_NAME to table JOBCODE_GROUP as (1) table does not exist, or (2) index already exists." onFail="MARK_RAN">
            <tableExists tableName="JOBCODE_GROUP"/>
            <not>
                <indexExists indexName="JOBCODEGROUP_NAME" tableName="JOBCODE_GROUP"/>
            </not>
        </preConditions>
        <comment>AHS-7698: CreateUniqueIndex JOBCODEGROUP_NAME on JOBCODE_GROUP (NAME)</comment>
        <createIndex unique="true" tablespace="MW_IDXENT" tableName="JOBCODE_GROUP" indexName="JOBCODEGROUP_NAME">
            <column name="NAME"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="23091ff7-9eea-4383-854d-429190027d84" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for PARENT_GROUP_OID to table JOBCODE_GROUP as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="JOBCODE_GROUP"/>
            <not>
                <columnExists tableName="JOBCODE_GROUP" columnName="PARENT_GROUP_OID"/>
            </not>
        </preConditions>
        <comment>AHS-7698: AddColumn JOBCODE_GROUP.PARENT_GROUP_OID</comment>
        <addColumn tableName="JOBCODE_GROUP">
            <column name="PARENT_GROUP_OID" type="BIGINT" remarks="For non-root groups, a reference to the parent group"/>
        </addColumn>
    </changeSet>

    <changeSet id="87ae6d97-6249-408e-b173-5fc218fc6c6a" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for JOB_CODE_GROUP_SUBDIR as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="JOB_CODE_GROUP_SUBDIR"/>
            <columnExists tableName="JOBCODE_GROUP" columnName="PARENT_GROUP_OID"/>
        </preConditions>
        <comment>AHS-7698: DropTable JOB_CODE_GROUP_SUBDIR</comment>
        <sql>
            UPDATE JOBCODE_GROUP SET PARENT_GROUP_OID = (SELECT MIN(OID) FROM JOB_CODE_GROUP_SUBDIR WHERE JOB_CODE_GROUP_SUBDIR.JOB_CODE_GROUP_OID = JOBCODE_GROUP.JOBCODE_GROUP_OID)
        </sql>
        <dropTable tableName="JOB_CODE_GROUP_SUBDIR"/>
        <rollback>
            <createTable tablespace="MW_ENT" remarks="The child job code groups" tableName="JOB_CODE_GROUP_SUBDIR">
                <column name="OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="JOB_CODE_GROUP_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </createTable>
            <addPrimaryKey columnNames="OID,JOB_CODE_GROUP_OID" constraintName="JOB_CODE_GROUP_SUBDIR_PK" tablespace="MW_IDXENT" tableName="JOB_CODE_GROUP_SUBDIR"/>
            <sql>
                INSERT INTO JOB_CODE_GROUP_SUBDIR (OID, JOB_CODE_GROUP_OID) SELECT PARENT_GROUP_OID, JOBCODE_GROUP_OID FROM JOBCODE_GROUP WHERE PARENT_GROUP_OID IS NOT NULL
            </sql>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="3ee14287-0b72-4d5c-86fb-0742859c0691" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for JOBCODE_PARENT_GROUP_OID_FK to table JOBCODE as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="JOBCODE"/>
            <tableExists tableName="JOBCODE_GROUP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="JOBCODE" foreignKeyName="JOBCODE_PARENT_GROUP_OID_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7698: AddForeignKeyConstraint JOBCODE_PARENT_GROUP_OID_FK to JOBCODE (PARENT_GROUP_OID)</comment>
        <addForeignKeyConstraint baseTableName="JOBCODE" baseColumnNames="PARENT_GROUP_OID" constraintName="JOBCODE_PARENT_GROUP_OID_FK" referencedTableName="JOBCODE_GROUP" referencedColumnNames="JOBCODE_GROUP_OID" onDelete="NO ACTION"/>
    </changeSet>

    <changeSet id="9b4242b1-2073-446d-8ed5-bedbd6fbc1ad" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for JOBCODE_GROUP_PARENT_GROUP_FK to table JOBCODE_GROUP as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="JOBCODE_GROUP"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="JOBCODE_GROUP" foreignKeyName="JOBCODE_GROUP_PARENT_GROUP_FK"/>
            </not>
        </preConditions>
        <comment>AHS-7698: AddForeignKeyConstraint JOBCODE_GROUP_PARENT_GROUP_FK to JOBCODE_GROUP (PARENT_GROUP_OID)</comment>
        <addForeignKeyConstraint baseTableName="JOBCODE_GROUP" baseColumnNames="PARENT_GROUP_OID" constraintName="JOBCODE_GROUP_PARENT_GROUP_FK" referencedTableName="JOBCODE_GROUP" referencedColumnNames="JOBCODE_GROUP_OID" onDelete="NO ACTION"/>
    </changeSet>

</databaseChangeLog>
