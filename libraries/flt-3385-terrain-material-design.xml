<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="1a06c477-e073-4f66-acc2-fb07202ce446" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for ID to table GRADEBLOCK_GROUP as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK_GROUP"/>
            <not>
                <columnExists tableName="GRADEBLOCK_GROUP" columnName="ID"/>
            </not>
        </preConditions>
        <comment>FLT-3385: AddColumn GRADEBLOCK_GROUP.ID</comment>
        <addColumn tableName="GRADEBLOCK_GROUP">
            <column name="ID" type="BIGINT" />
        </addColumn>
    </changeSet>

    <changeSet id="16efa11a-28f8-4505-8f46-991f7acea999" author="MineStar" failOnError="false">
        <comment>FLT-3385: Populate GRADEBLOCK_GROUP.ID</comment>
        <rollback/>
        <sql>update GRADEBLOCK_GROUP set id = (SELECT count(1) from GRADEBLOCK_GROUP grp where grp.gradeblock_group_oid &lt;= GRADEBLOCK_GROUP.gradeblock_group_oid)</sql>
    </changeSet>

    <changeSet id="0140b5b9-21f1-49a3-b273-e3146c4d3c8b" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for GRADEBLOCK_GROUP.ID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="GRADEBLOCK_GROUP" columnName="ID"/>
        </preConditions>
        <comment>FLT-3385: AddNotNullConstraint to GRADEBLOCK_GROUP.ID</comment>
        <addNotNullConstraint columnName="ID" columnDataType="BIGINT" tableName="GRADEBLOCK_GROUP"/>
    </changeSet>

    <changeSet id="e09bcc48-7965-4a73-9100-d486681d3165" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for PTS_FILE_NAME to table GRADEBLOCK_GROUP as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK_GROUP"/>
            <not>
                <columnExists tableName="GRADEBLOCK_GROUP" columnName="PTS_FILE_NAME"/>
            </not>
        </preConditions>
        <comment>FLT-3385: AddColumn GRADEBLOCK_GROUP.PTS_FILE_NAME</comment>
        <addColumn tableName="GRADEBLOCK_GROUP">
            <column name="PTS_FILE_NAME" type="VARCHAR(254)" remarks="The name of the PTS file name for this group"/>
        </addColumn>
    </changeSet>
    <changeSet id="76ce3c55-0b6d-4c11-9d20-1e970f298479" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for TERRAIN_GROUP_ID to table GRADEBLOCK_GROUP as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK_GROUP"/>
            <not>
                <columnExists tableName="GRADEBLOCK_GROUP" columnName="TERRAIN_GROUP_ID"/>
            </not>
        </preConditions>
        <comment>FLT-3385: AddColumn GRADEBLOCK_GROUP.TERRAIN_GROUP_ID</comment>
        <addColumn tableName="GRADEBLOCK_GROUP">
            <column name="TERRAIN_GROUP_ID" type="BIGINT" remarks="ID from terrain"/>
        </addColumn>
    </changeSet>
    <changeSet id="33a75ea8-2141-4bf7-ae00-7576f36303fa" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored CreateIndex for GRADEBLOCKGROUP_ID to table GRADEBLOCK_GROUP as (1) table does not exist, or (2) index already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK_GROUP"/>
            <not>
                <indexExists indexName="GRADEBLOCKGROUP_ID" tableName="GRADEBLOCK_GROUP"/>
            </not>
        </preConditions>
        <comment>FLT-3385: CreateUniqueIndex GRADEBLOCKGROUP_ID on GRADEBLOCK_GROUP (ID)</comment>
        <createIndex unique="true" tablespace="MW_IDXENT" tableName="GRADEBLOCK_GROUP" indexName="GRADEBLOCKGROUP_ID">
            <column name="ID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
</databaseChangeLog>
