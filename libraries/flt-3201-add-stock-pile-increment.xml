<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="94cbae14-2394-4a36-9573-5d57dd0d0aad" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CREATETIME_UTC to table GRADEBLOCK as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <columnExists tableName="GRADEBLOCK" columnName="CREATETIME_UTC"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddColumn GRADEBLOCK.CREATETIME_UTC</comment>
        <addColumn tableName="GRADEBLOCK">
            <column name="CREATETIME_UTC" type="DATETIME2" remarks="Mining block create time, the time when mining block is created"/>
        </addColumn>
    </changeSet>
    <changeSet id="333e541c-b927-43e3-999f-543145bdbfb2" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for OPENFORDUMPING to table GRADEBLOCK as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <columnExists tableName="GRADEBLOCK" columnName="OPENFORDUMPING"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddColumn GRADEBLOCK.OPENFORDUMPING</comment>
        <addColumn tableName="GRADEBLOCK">
            <column name="OPENFORDUMPING" type="BOOLEAN" remarks="The open for dumping flag for stockpile"/>
        </addColumn>
    </changeSet>
    <changeSet id="041005c0-e8fa-43f4-9a41-57b466446086" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for OPENFORLOADING to table GRADEBLOCK as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <columnExists tableName="GRADEBLOCK" columnName="OPENFORLOADING"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddColumn GRADEBLOCK.OPENFORLOADING</comment>
        <addColumn tableName="GRADEBLOCK">
            <column name="OPENFORLOADING" type="BOOLEAN" remarks="The open for loading flag for stockpile"/>
        </addColumn>
    </changeSet>
    <changeSet id="591b37fe-c990-4bb9-aa04-317568af9ade" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CARRYOPTION to table GRADEBLOCK as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <columnExists tableName="GRADEBLOCK" columnName="CARRYOPTION"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddColumn GRADEBLOCK.CARRYOPTION</comment>
        <addColumn tableName="GRADEBLOCK">
            <column name="CARRYOPTION" type="VARCHAR(254)" remarks="The carry over option for stockpile increment"/>
        </addColumn>
    </changeSet>
    <changeSet id="2b03e2e0-4003-418f-a212-1dce919e2f8e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CARRY_FROM_OID to table GRADEBLOCK as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <columnExists tableName="GRADEBLOCK" columnName="CARRY_FROM_OID"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddColumn GRADEBLOCK.CARRY_FROM_OID</comment>
        <addColumn tableName="GRADEBLOCK">
            <column name="CARRY_FROM_OID" type="BIGINT" remarks="The mining block from which this mining block is carried over"/>
        </addColumn>
    </changeSet>
    <changeSet id="3cd40bc3-aabb-4799-8b83-a95f59bdc974" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for GRADEBLOCK_CARRY_FROM_OID_FK to table GRADEBLOCK as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="GRADEBLOCK"/>
            <tableExists tableName="GRADEBLOCK"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="GRADEBLOCK" foreignKeyName="GRADEBLOCK_CARRY_FROM_OID_FK"/>
            </not>
        </preConditions>
        <comment>FLT-3201: AddForeignKeyConstraint GRADEBLOCK_CARRY_FROM_OID_FK to GRADEBLOCK (CARRY_FROM_OID)</comment>
        <sql>UPDATE GRADEBLOCK SET CARRY_FROM_OID = NULL WHERE CARRY_FROM_OID IS NOT NULL AND CARRY_FROM_OID NOT IN (SELECT GRADEBLOCK_OID FROM GRADEBLOCK)</sql>
        <addForeignKeyConstraint baseTableName="GRADEBLOCK" baseColumnNames="CARRY_FROM_OID" constraintName="GRADEBLOCK_CARRY_FROM_OID_FK" referencedTableName="GRADEBLOCK" referencedColumnNames="GRADEBLOCK_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="GRADEBLOCK" constraintName="GRADEBLOCK_CARRY_FROM_OID_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
