<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2019 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <changeSet id="25374fba-1b22-4fa8-a9e3-4fff366ca01d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropDefaultValue for IS_ACTIVE of table SHIFT_ROSTER as column does not exist."
                       onFail="MARK_RAN">
            <ext:columnHasDefaultValue tableName="SHIFT_ROSTER" columnName="IS_ACTIVE"/>
        </preConditions>
        <comment>FLT-7939: DropDefaultValue SHIFT_ROSTER.IS_ACTIVE</comment>
        <dropDefaultValue tableName="SHIFT_ROSTER" columnName="IS_ACTIVE" columnDataType="BOOLEAN"/>
        <rollback>
            <!-- Do nothing as SHIFT_ROSTER.IS_ACTIVE already rollback with default value in id=25374fba-1b22-4fa8-a9e3-4fff366ca01c -->
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

    <changeSet id="25374fba-1b22-4fa8-a9e3-4fff366ca01c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for IS_ACTIVE of table SHIFT_ROSTER as column does not exist."
                       onFail="MARK_RAN">
            <columnExists tableName="SHIFT_ROSTER" columnName="IS_ACTIVE"/>
        </preConditions>
        <comment>FLT-7939: DropColumn SHIFT_ROSTER.IS_ACTIVE</comment>
        <dropColumn tableName="SHIFT_ROSTER" columnName="IS_ACTIVE"/>
        <rollback>
            <addColumn tableName="SHIFT_ROSTER">
                <column name="IS_ACTIVE" type="BOOLEAN" defaultValueBoolean="false"
                        remarks="Is this shift roster active">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="22682763-56a9-49da-8b15-039a2c636feb" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropNotNullConstraint for SHIFT_ROSTER.PATTERN_DATE_UTC as column does not exist or is already nullable"
                       onFail="MARK_RAN">
            <ext:columnIsNotNullable tableName="SHIFT_ROSTER" columnName="PATTERN_DATE_UTC"/>
        </preConditions>
        <comment>FLT-7939: DropNotNullConstraint from SHIFT_ROSTER.PATTERN_DATE_UTC</comment>
        <dropNotNullConstraint tableName="SHIFT_ROSTER" columnName="PATTERN_DATE_UTC" columnDataType="DATETIME2"/>
    </changeSet>

    <changeSet id="dbdbc1c4-d447-45f3-a4f6-8b4a36d1cdbd" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropDefaultValue for SHIFT_ROSTER.PATTERN_DATE_UTC as column does not exist or column does not have a default value"
                       onFail="MARK_RAN">
            <ext:columnHasDefaultValue tableName="SHIFT_ROSTER" columnName="PATTERN_DATE_UTC"/>
        </preConditions>
        <comment>FLT-7939: DropDefaultValue '01-JAN-1970' from SHIFT_ROSTER.PATTERN_DATE_UTC</comment>
        <dropDefaultValue columnName="PATTERN_DATE_UTC" columnDataType="DATETIME2" tableName="SHIFT_ROSTER"/>
        <rollback>
            <addDefaultValue columnName="PATTERN_DATE_UTC" columnDataType="DATETIME2" defaultValue="01-JAN-1970"
                             tableName="SHIFT_ROSTER"/>
        </rollback>
    </changeSet>

    <changeSet id="c89f0f5e-18ee-45d7-9655-7c451166b058" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for SHIFT_ROSTER_ITEM.START_OFFSET as column does not exist or is already not-nullable"
                       onFail="MARK_RAN">
            <ext:columnIsNullable tableName="SHIFT_ROSTER_ITEM" columnName="START_OFFSET"/>
        </preConditions>
        <comment>FLT-7939: AddNotNullConstraint to SHIFT_ROSTER_ITEM.START_OFFSET</comment>
        <sql>UPDATE SHIFT_ROSTER_ITEM SET START_OFFSET = 0 WHERE START_OFFSET IS NULL</sql>
        <addNotNullConstraint columnName="START_OFFSET" columnDataType="BIGINT" tableName="SHIFT_ROSTER_ITEM"/>
        <rollback>
            <dropNotNullConstraint tableName="SHIFT_ROSTER_ITEM" columnName="START_OFFSET" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
