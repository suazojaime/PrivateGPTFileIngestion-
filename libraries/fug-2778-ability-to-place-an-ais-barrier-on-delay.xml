<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="1df26493-c434-44c6-a1d3-914d8e08174e" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for AIS_BARRIER_POINTS_OID_FK of table AIS_BARRIER_POINTS as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="AIS_BARRIER_POINTS" foreignKeyName="AIS_BARRIER_POINTS_OID_FK"/>
        </preConditions>
        <comment>FUG-2778: DropForeignKeyConstraint AIS_BARRIER_POINTS_OID_FK from AIS_BARRIER_POINTS (OID)</comment>
        <dropForeignKeyConstraint baseTableName="AIS_BARRIER_POINTS" constraintName="AIS_BARRIER_POINTS_OID_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="AIS_BARRIER_POINTS" baseColumnNames="OID" constraintName="AIS_BARRIER_POINTS_OID_FK" referencedTableName="AIS_BARRIER" referencedColumnNames="BARRIER_OID" deleteCascade="false"/>
        </rollback>
    </changeSet>
    <changeSet id="01219ec3-94de-4145-b224-194723dc4c83" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for SUBPANEL_BARRIERS_BARRIER_O_FK of table SUBPANEL_BARRIERS as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="SUBPANEL_BARRIERS" foreignKeyName="SUBPANEL_BARRIERS_BARRIER_O_FK"/>
        </preConditions>
        <comment>FUG-2778: DropForeignKeyConstraint SUBPANEL_BARRIERS_BARRIER_O_FK from SUBPANEL_BARRIERS (BARRIER_OID)</comment>
        <dropForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" constraintName="SUBPANEL_BARRIERS_BARRIER_O_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" baseColumnNames="BARRIER_OID" constraintName="SUBPANEL_BARRIERS_BARRIER_O_FK" referencedTableName="AIS_BARRIER" referencedColumnNames="BARRIER_OID" deleteCascade="false"/>
        </rollback>
    </changeSet>
    <changeSet id="a4de96bb-5742-4d0f-aa29-ce6cef36a2e8" context="Underground/Underground_Management" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable for AIS_BARRIER as table does not exist." onFail="MARK_RAN">
            <tableExists tableName="AIS_BARRIER"/>
        </preConditions>
        <comment>FUG-2778: DropTable AIS_BARRIER</comment>
        <dropTable tableName="AIS_BARRIER"/>
        <rollback/>
    </changeSet>
    <changeSet id="d58e66aa-e217-4774-9d1a-55c92e834a10" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for UG_AIS_BARRIER as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="UG_AIS_BARRIER"/>
            </not>
        </preConditions>
        <comment>FUG-2778: CreateTable UG_AIS_BARRIER</comment>
        <createTable tablespace="MW_ENT" remarks="A barrier within the automated isolation system used for underground path-planning." tableName="UG_AIS_BARRIER">
            <column name="BARRIER_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="OPC_CONNECTION_NAME" type="VARCHAR(254)" remarks="OPC External System task name">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_STATE" type="INT" remarks="BCP activated/deactived state">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_BARRIER_STATE" type="INT" remarks="Barrier open/closed">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_STATE_TAG" type="VARCHAR(254)" remarks="OPC Tag representing the BCP activated/deactivated value">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_BARRIER_STATE_TAG" type="VARCHAR(254)" remarks="OPC Tag representing the barrier open/closed value">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_OPEN_TAG" type="VARCHAR(254)" remarks="OPC Tag for sending barrier open commands">
                <constraints nullable="false"/>
            </column>
            <column name="BCP_CLOSE_TAG" type="VARCHAR(254)" remarks="OPC Tag for sending barrier close commands">
                <constraints nullable="false"/>
            </column>
            <column name="PERSONNEL_CLOSE_INHIBIT_TAG" type="VARCHAR(254)" remarks="OPC Tag for sending personnel barrier close inhibit commands">
                <constraints nullable="false"/>
            </column>
            <column name="INFRASTRUCTURE_EXCLUSION_ZONE" type="BIGINT" remarks="Reference to infrastructure exclusion zone (MSMODEL.ZONE)."/>
            <column name="NAME" type="VARCHAR(255)"/>
        </createTable>
        <addPrimaryKey columnNames="BARRIER_OID" constraintName="UG_AIS_BARRIER_PK" tablespace="MW_IDXENT" tableName="UG_AIS_BARRIER"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="fefe24ca-41c4-46ac-b48b-d36304848712" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for UG_AIS_BARRIER_BARRIER_OID_FK to table UG_AIS_BARRIER as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="UG_AIS_BARRIER"/>
            <tableExists tableName="MACHINE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="UG_AIS_BARRIER" foreignKeyName="UG_AIS_BARRIER_BARRIER_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-2778: AddForeignKeyConstraint UG_AIS_BARRIER_BARRIER_OID_FK to UG_AIS_BARRIER (BARRIER_OID)</comment>
        <sql>DELETE FROM UG_AIS_BARRIER WHERE BARRIER_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = UG_AIS_BARRIER.BARRIER_OID)</sql>
        <addForeignKeyConstraint baseTableName="UG_AIS_BARRIER" baseColumnNames="BARRIER_OID" constraintName="UG_AIS_BARRIER_BARRIER_OID_FK" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" deleteCascade="false"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="UG_AIS_BARRIER" constraintName="UG_AIS_BARRIER_BARRIER_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="2a653fa8-92f9-4da4-a5f7-f284b36b43bc" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for UG_AIS_BARRIER_INFRASTRUCTU_FK to table UG_AIS_BARRIER as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="UG_AIS_BARRIER"/>
            <tableExists tableName="ZONE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="UG_AIS_BARRIER" foreignKeyName="UG_AIS_BARRIER_INFRASTRUCTU_FK"/>
            </not>
        </preConditions>
        <comment>FUG-2778: AddForeignKeyConstraint UG_AIS_BARRIER_INFRASTRUCTU_FK to UG_AIS_BARRIER (INFRASTRUCTURE_EXCLUSION_ZONE)</comment>
        <sql>UPDATE UG_AIS_BARRIER SET INFRASTRUCTURE_EXCLUSION_ZONE = NULL WHERE INFRASTRUCTURE_EXCLUSION_ZONE IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM ZONE WHERE ZONE.ZONE_OID = UG_AIS_BARRIER.INFRASTRUCTURE_EXCLUSION_ZONE)</sql>
        <addForeignKeyConstraint baseTableName="UG_AIS_BARRIER" baseColumnNames="INFRASTRUCTURE_EXCLUSION_ZONE" constraintName="UG_AIS_BARRIER_INFRASTRUCTU_FK" referencedTableName="ZONE" referencedColumnNames="ZONE_OID" deleteCascade="false"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="UG_AIS_BARRIER" constraintName="UG_AIS_BARRIER_INFRASTRUCTU_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="0abbad4d-5c9d-4c16-a7dd-acbfb5182187" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for AIS_BARRIER_POINTS_OID_FK to table AIS_BARRIER_POINTS as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="AIS_BARRIER_POINTS"/>
            <tableExists tableName="UG_AIS_BARRIER"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="AIS_BARRIER_POINTS" foreignKeyName="AIS_BARRIER_POINTS_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-2778: AddForeignKeyConstraint AIS_BARRIER_POINTS_OID_FK to AIS_BARRIER_POINTS (OID)</comment>
        <sql>DELETE FROM AIS_BARRIER_POINTS WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM UG_AIS_BARRIER WHERE UG_AIS_BARRIER.BARRIER_OID = AIS_BARRIER_POINTS.OID)</sql>
        <addForeignKeyConstraint baseTableName="AIS_BARRIER_POINTS" baseColumnNames="OID" constraintName="AIS_BARRIER_POINTS_OID_FK" referencedTableName="UG_AIS_BARRIER" referencedColumnNames="BARRIER_OID" deleteCascade="false"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="AIS_BARRIER_POINTS" constraintName="AIS_BARRIER_POINTS_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="70a39af2-8f65-4137-bf5d-3f9eb8d53055" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SUBPANEL_BARRIERS_BARRIER_O_FK to table SUBPANEL_BARRIERS as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SUBPANEL_BARRIERS"/>
            <tableExists tableName="UG_AIS_BARRIER"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SUBPANEL_BARRIERS" foreignKeyName="SUBPANEL_BARRIERS_BARRIER_O_FK"/>
            </not>
        </preConditions>
        <comment>FUG-2778: AddForeignKeyConstraint SUBPANEL_BARRIERS_BARRIER_O_FK to SUBPANEL_BARRIERS (BARRIER_OID)</comment>
        <sql>DELETE FROM SUBPANEL_BARRIERS WHERE BARRIER_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM UG_AIS_BARRIER WHERE UG_AIS_BARRIER.BARRIER_OID = SUBPANEL_BARRIERS.BARRIER_OID)</sql>
        <addForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" baseColumnNames="BARRIER_OID" constraintName="SUBPANEL_BARRIERS_BARRIER_O_FK" referencedTableName="UG_AIS_BARRIER" referencedColumnNames="BARRIER_OID" deleteCascade="false"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" constraintName="SUBPANEL_BARRIERS_BARRIER_O_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
