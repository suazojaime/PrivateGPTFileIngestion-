<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">

    <!-- Remove badly named indexes if they exist -->
    <changeSet id="d7077804-002e-4d71-9f35-67f98b3ee86f" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCALE_READING_SCALE_MACHINE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCALE_READING_SCALE_MACHINE_OID"/>
        </preConditions>
        <dropIndex tableName="SCALE_READING" indexName="SCALE_READING_SCALE_MACHINE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="afa36c5f-d2d8-4142-8bb2-1ec4afd26c0d" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCALE_READING_TIMESTAMP_UTC." onFail="MARK_RAN">
            <indexExists indexName="SCALE_READING_TIMESTAMP_UTC"/>
        </preConditions>
        <dropIndex tableName="SCALE_READING" indexName="SCALE_READING_TIMESTAMP_UTC" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="60430579-2695-4380-96c8-3e553f12b4de" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCALE_READING_MACHINE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCALE_READING_MACHINE_OID"/>
        </preConditions>
        <dropIndex tableName="SCALE_READING" indexName="SCALE_READING_MACHINE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="2f8120a7-7014-4e51-8026-92426e7db2f6" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCALE_READING_CYCLE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCALE_READING_CYCLE_OID"/>
        </preConditions>
        <dropIndex tableName="SCALE_READING" indexName="SCALE_READING_CYCLE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!-- Remove badly named indexes if they exist -->
    <changeSet id="c103f94b-8d14-43f2-8a53-970f988b13b7" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCANNER_READING_SCANNER_MACHINE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCANNER_READING_SCANNER_MACHINE_OID"/>
        </preConditions>
        <dropIndex tableName="SCANNER_READING" indexName="SCANNER_READING_SCANNER_MACHINE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="5de8ffd9-5247-4c15-bbbc-c5d3c015883b" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCANNER_READING_TIMESTAMP_UTC." onFail="MARK_RAN">
            <indexExists indexName="SCANNER_READING_TIMESTAMP_UTC"/>
        </preConditions>
        <dropIndex tableName="SCANNER_READING" indexName="SCANNER_READING_TIMESTAMP_UTC" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="720bd0e9-f4d5-4119-af9f-f991fe8ccf48" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCANNER_READING_MACHINE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCANNER_READING_MACHINE_OID"/>
        </preConditions>
        <dropIndex tableName="SCANNER_READING" indexName="SCANNER_READING_MACHINE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="7e26beed-1016-43a3-bd7b-fbda6b537a72" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored drop index for SCANNER_READING_CYCLE_OID." onFail="MARK_RAN">
            <indexExists indexName="SCANNER_READING_CYCLE_OID"/>
        </preConditions>
        <dropIndex tableName="SCANNER_READING" indexName="SCANNER_READING_CYCLE_OID" />
        <rollback />
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!-- Check if new stuff needs to be added but correctly named this time -->
    <changeSet id="d1db5cc2-8059-456a-a7c1-f45e7dac99c5" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SCALE_READING as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SCALE_READING"/>
            </not>
        </preConditions>
        <comment>FLT-3242: CreateTable SCALE_READING</comment>
        <createTable tablespace="MW_OBJ" remarks="A scale reading." tableName="SCALE_READING">
            <column name="SCALE_READING_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SCALE_MACHINE_OID" type="BIGINT" remarks="The entity the event came from.">
                <constraints nullable="false"/>
            </column>
            <column name="TIMESTAMP_UTC" type="DATETIME2" remarks="The utc time the reading was taken.">
                <constraints nullable="false"/>
            </column>
            <column name="MACHINE_OID" type="BIGINT" remarks="The machine entity that was weighed."/>
            <column name="CYCLE_OID" type="BIGINT" remarks="The machine cycle."/>
            <column name="STATUS" type="SMALLINT" remarks="The status of the reading."/>
            <column name="PAYLOAD" type="FLOAT" remarks="The payload of the reading."/>
            <column name="FRONT_RIGHT_WEIGHT" type="FLOAT" remarks="Weight at front right."/>
            <column name="FRONT_LEFT_WEIGHT" type="FLOAT" remarks="Weight at front left."/>
            <column name="REAR_RIGHT_OUTER_WEIGHT" type="FLOAT" remarks="Weight at rear right outer."/>
            <column name="REAR_LEFT_OUTER_WEIGHT" type="FLOAT" remarks="Weight at rear left outer."/>
            <column name="REAR_RIGHT_INNER_WEIGHT" type="FLOAT" remarks="Weight at rear right inner."/>
            <column name="REAR_LEFT_INNER_WEIGHT" type="FLOAT" remarks="Weight at rear left inner."/>
            <column name="HORIZONTAL_BIAS_PCT" type="FLOAT" remarks="Horizontal bias percentage."/>
            <column name="VERTICAL_BIAS_PCT" type="FLOAT" remarks="Vertical bias percentage."/>
        </createTable>
        <addPrimaryKey columnNames="SCALE_READING_OID" constraintName="SCALE_READING_PK" tablespace="MW_IDXOBJ" tableName="SCALE_READING"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!-- Now add the indexes back properly assuming the table was already created -->
    <changeSet id="8d2a15d9-d25b-4678-a126-b468f43d2afc" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCLRD_SCALE_MACHINE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCLRD_SCALE_MACHINE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCALE_READING" indexName="SCLRD_SCALE_MACHINE_OID">
            <column name="SCALE_MACHINE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="77ea0dbf-57ee-4019-b324-c0a86f038f20" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCLRD_TIMESTAMP_UTC." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCLRD_TIMESTAMP_UTC"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCALE_READING" indexName="SCLRD_TIMESTAMP_UTC">
            <column name="TIMESTAMP_UTC"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="81509558-0511-4d90-9955-45d0dc6891a0" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCLRD_MACHINE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCLRD_MACHINE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCALE_READING" indexName="SCLRD_MACHINE_OID">
            <column name="MACHINE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="68efe5aa-f7c9-48fb-9c34-5da62e30a449" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCLRD_CYCLE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCLRD_CYCLE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCALE_READING" indexName="SCLRD_CYCLE_OID">
            <column name="CYCLE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="5a02e406-3227-4311-8869-4e1d81754991" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SCANNER_READING as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SCANNER_READING"/>
            </not>
        </preConditions>
        <comment>FLT-3242: CreateTable SCANNER_READING</comment>
        <createTable tablespace="MW_OBJ" remarks="A scale reading." tableName="SCANNER_READING">
            <column name="SCANNER_READING_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SCANNER_MACHINE_OID" type="BIGINT" remarks="The entity the event came from.">
                <constraints nullable="false"/>
            </column>
            <column name="TIMESTAMP_UTC" type="DATETIME2" remarks="The utc time the reading was taken.">
                <constraints nullable="false"/>
            </column>
            <column name="MACHINE_OID" type="BIGINT" remarks="The machine entity that was weighed."/>
            <column name="CYCLE_OID" type="BIGINT" remarks="The machine cycle."/>
            <column name="VOLUME" type="FLOAT" remarks="The volume of the reading."/>
            <column name="HORIZONTAL_BIAS_PCT" type="FLOAT" remarks="Horizontal bias percentage."/>
            <column name="VERTICAL_BIAS_PCT" type="FLOAT" remarks="Vertical bias percentage."/>
        </createTable>
        <addPrimaryKey columnNames="SCANNER_READING_OID" constraintName="SCANNER_READING_PK" tablespace="MW_IDXOBJ" tableName="SCANNER_READING"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <!-- Now create indexes with correct name -->
    <changeSet id="e938fe8d-ad12-4add-b857-2de3ea3f5fbc" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCNRD_SCANNER_MACHINE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCNRD_SCANNER_MACHINE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCANNER_READING" indexName="SCNRD_SCANNER_MACHINE_OID">
            <column name="SCANNER_MACHINE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="83e50554-6c37-488b-a134-55f2232c372b" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCNRD_TIMESTAMP_UTC." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCNRD_TIMESTAMP_UTC"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCANNER_READING" indexName="SCNRD_TIMESTAMP_UTC">
            <column name="TIMESTAMP_UTC"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="e403f738-a867-41d0-b81e-b25f968dbeb1" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCNRD_MACHINE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCNRD_MACHINE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCANNER_READING" indexName="SCNRD_MACHINE_OID">
            <column name="MACHINE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="ddd813bd-e48d-4c21-b155-ebd6a2cfdaf3" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored create index for SCNRD_CYCLE_OID." onFail="MARK_RAN">
            <not>
                <indexExists indexName="SCNRD_CYCLE_OID"/>
            </not>
        </preConditions>
        <createIndex unique="false" tablespace="MW_IDXOBJ" tableName="SCANNER_READING" indexName="SCNRD_CYCLE_OID">
            <column name="CYCLE_OID"/>
        </createIndex>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>


    <changeSet id="7fdb4b18-4bd9-4f81-ade3-a4929e797b8a" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SCALE_READING_CYCLE_OID_FK to table SCALE_READING as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SCALE_READING"/>
            <tableExists tableName="CYCLE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SCALE_READING" foreignKeyName="SCALE_READING_CYCLE_OID_FK"/>
            </not>

        </preConditions>
        <comment>FLT-3242: AddForeignKeyConstraint SCALE_READING_CYCLE_OID_FK to SCALE_READING (CYCLE_OID)</comment>
        <sql>UPDATE SCALE_READING SET CYCLE_OID = NULL WHERE CYCLE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM CYCLE WHERE CYCLE.CYCLE_OID = SCALE_READING.CYCLE_OID)</sql>
        <addForeignKeyConstraint baseTableName="SCALE_READING" baseColumnNames="CYCLE_OID" constraintName="SCALE_READING_CYCLE_OID_FK" referencedTableName="CYCLE" referencedColumnNames="CYCLE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SCALE_READING" constraintName="SCALE_READING_CYCLE_OID_FK"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="7a14d020-c3a8-4151-8b71-fc67e077b0d3" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SCANNER_READING_CYCLE_OID_FK to table SCANNER_READING as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SCANNER_READING"/>
            <tableExists tableName="CYCLE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SCANNER_READING" foreignKeyName="SCANNER_READING_CYCLE_OID_FK"/>
            </not>
        </preConditions>
        <comment>FLT-3242: AddForeignKeyConstraint SCANNER_READING_CYCLE_OID_FK to SCANNER_READING (CYCLE_OID)</comment>
        <sql>UPDATE SCANNER_READING SET CYCLE_OID = NULL WHERE CYCLE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM CYCLE WHERE CYCLE.CYCLE_OID = SCANNER_READING.CYCLE_OID)</sql>
        <addForeignKeyConstraint baseTableName="SCANNER_READING" baseColumnNames="CYCLE_OID" constraintName="SCANNER_READING_CYCLE_OID_FK" referencedTableName="CYCLE" referencedColumnNames="CYCLE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SCANNER_READING" constraintName="SCANNER_READING_CYCLE_OID_FK"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
</databaseChangeLog>
