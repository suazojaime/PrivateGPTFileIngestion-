<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="fe21f035-a3fa-4962-8b12-19dc4fcae404" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for PROD_PLAN_ENDORSEMENT as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="PROD_PLAN_ENDORSEMENT"/>
            </not>
        </preConditions>
        <comment>MO-5852: CreateTable PROD_PLAN_ENDORSEMENT</comment>
        <createTable tableName="PROD_PLAN_ENDORSEMENT">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="PLAN_OID" type="BIGINT" remarks="A reference to the Prod Plan table (PROD_PLAN)."/>
            <column name="USER_OID" type="BIGINT" remarks="A reference to the user (MSMODEL.USER) who endorsed a plan.">
                <constraints nullable="false"/>
            </column>
            <column name="STATUS" type="VARCHAR(254)" remarks="Status">
                <constraints nullable="false"/>
            </column>
            <column name="USER_NOTES" type="CLOB"/>
            <column name="CREATED_DATE_UTC" type="DATETIME2" remarks="The timestamp of created">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="PROD_PLAN_ENDORSEMENT_PK" tableName="PROD_PLAN_ENDORSEMENT"/>
    </changeSet>
    <changeSet id="7074070f-a8b2-4e53-9b48-6a7a4667f152" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_ENDORSEMENT_PLAN_FK to table PROD_PLAN_ENDORSEMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_ENDORSEMENT" columnName="PLAN_OID"/>
            <columnExists tableName="PROD_PLAN" columnName="OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_ENDORSEMENT" foreignKeyName="PROD_PLAN_ENDORSEMENT_PLAN_FK"/>
            </not>
        </preConditions>
        <comment>MO-5852: AddForeignKeyConstraint PROD_PLAN_ENDORSEMENT_PLAN_FK to PROD_PLAN_ENDORSEMENT (PLAN_OID)</comment>
        <sql>UPDATE PROD_PLAN_ENDORSEMENT SET PLAN_OID = NULL WHERE PLAN_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM PROD_PLAN WHERE PROD_PLAN.OID = PROD_PLAN_ENDORSEMENT.PLAN_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_ENDORSEMENT" baseColumnNames="PLAN_OID" constraintName="PROD_PLAN_ENDORSEMENT_PLAN_FK" referencedTableName="PROD_PLAN" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_ENDORSEMENT" constraintName="PROD_PLAN_ENDORSEMENT_PLAN_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="d420e809-8f66-46e5-a643-9e389c4c6ad4" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for PROD_PLAN_ENDORSEMENT.PLAN_OID as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="PROD_PLAN_ENDORSEMENT" columnName="PLAN_OID"/>
        </preConditions>
        <comment>MO-5852: AddNotNullConstraint to PROD_PLAN_ENDORSEMENT.PLAN_OID</comment>
        <sql>UPDATE PROD_PLAN_ENDORSEMENT SET PLAN_OID = 0 WHERE PLAN_OID IS NULL</sql>
        <addNotNullConstraint columnName="PLAN_OID" columnDataType="BIGINT" tableName="PROD_PLAN_ENDORSEMENT"/>
        <rollback>
            <dropNotNullConstraint tableName="PROD_PLAN_ENDORSEMENT" columnName="PLAN_OID" columnDataType="BIGINT"/>
        </rollback>
    </changeSet>
    <changeSet id="9b9e9b74-c264-47fc-bdf1-c8dba7385c9d" author="MineStar" context="Production/Production_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for PROD_PLAN_ENDORSEMENT_USER_FK to table PROD_PLAN_ENDORSEMENT as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="PROD_PLAN_ENDORSEMENT" columnName="USER_OID"/>
            <columnExists tableName="USER1" columnName="USER_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="PROD_PLAN_ENDORSEMENT" foreignKeyName="PROD_PLAN_ENDORSEMENT_USER_FK"/>
            </not>
        </preConditions>
        <comment>MO-5852: AddForeignKeyConstraint PROD_PLAN_ENDORSEMENT_USER_FK to PROD_PLAN_ENDORSEMENT (USER_OID)</comment>
        <sql>DELETE FROM PROD_PLAN_ENDORSEMENT WHERE USER_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM USER1 WHERE USER1.USER_OID = PROD_PLAN_ENDORSEMENT.USER_OID)</sql>
        <addForeignKeyConstraint baseTableName="PROD_PLAN_ENDORSEMENT" baseColumnNames="USER_OID" constraintName="PROD_PLAN_ENDORSEMENT_USER_FK" referencedTableName="USER1" referencedColumnNames="USER_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="PROD_PLAN_ENDORSEMENT" constraintName="PROD_PLAN_ENDORSEMENT_USER_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
