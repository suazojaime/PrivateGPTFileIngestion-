<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    
    <changeSet id="d9383d01-6049-43ef-9cc5-dd161b44037d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for ECF_CLASS_ID of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="ECF_CLASS_ID"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.ECF_CLASS_ID</comment>
        <dropColumn columnName="ECF_CLASS_ID" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="ECF_CLASS_ID" type="VARCHAR(255)"/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="51cef816-a30c-4bdd-bc0d-eb5524da4e93" author="MineStar" failOnError="false" dbms="mssql">
        <preConditions onFailMessage="Ignored DropIndex for ALARMTYPE_NAME as index does not exist" onFail="MARK_RAN">
            <indexExists tableName="ALARMTYPE" indexName="ALARMTYPE_NAME"/>
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="NAME"/>
        </preConditions>
        <comment>AHS-7096: DropIndex ALARMTYPE_NAME</comment>
        <dropIndex tableName="ALARMTYPE" indexName="ALARMTYPE_NAME"/>
        <rollback>
            <createIndex tableName="ALARMTYPE" indexName="ALARMTYPE_NAME" unique="true">
                <column name="NAME"/>
            </createIndex>
        </rollback>
    </changeSet>

    <changeSet id="51cef816-a30c-4bdd-bc0d-eb5524da4e98" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.NAME as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="NAME"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.NAME</comment>
        <addNotNullConstraint columnName="NAME" columnDataType="VARCHAR(254)" tableName="ALARMTYPE"/>
    </changeSet>

    <changeSet id="51cef816-a30c-4bdd-bc0d-eb5524da4e94" author="MineStar" failOnError="false" dbms="mssql">
        <preConditions onFailMessage="Ignored CreateIndex for ALARMTYPE_NAME as index already exists" onFail="MARK_RAN">
            <not>
                <indexExists tableName="ALARMTYPE" indexName="ALARMTYPE_NAME"/>
            </not>
        </preConditions>
        <comment>AHS-7096: CreateIndex ALARMTYPE_NAME (NAME)</comment>
        <createIndex tableName="ALARMTYPE" indexName="ALARMTYPE_NAME" unique="true">
            <column name="NAME"/>
        </createIndex>
    </changeSet>

    <changeSet id="003d2618-82ee-4239-9aca-37b3f617a73d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for ACK_TYPE to table ALARMTYPE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="ALARMTYPE"/>
            <not>
                <columnExists tableName="ALARMTYPE" columnName="ACK_TYPE"/>
            </not>
        </preConditions>
        <comment>AHS-7096: AddColumn ALARMTYPE.ACK_TYPE</comment>
        <addColumn tableName="ALARMTYPE">
            <column name="ACK_TYPE" type="TINYINT" remarks="The type of acknowledgement that alarms of this type require."/>
        </addColumn>
    </changeSet>

    <changeSet id="8d07daf0-2382-42af-abe0-4093c302136c" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.ACK_TYPE as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="ACK_TYPE"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.ACK_TYPE</comment>
        <sql>UPDATE ALARMTYPE SET ACK_TYPE = 1 WHERE REQ_ACK_TYPE = 'ackAuto'</sql>
        <sql>UPDATE ALARMTYPE SET ACK_TYPE = 2 WHERE REQ_ACK_TYPE = 'rejectAuto'</sql>
        <sql>UPDATE ALARMTYPE SET ACK_TYPE = 0 WHERE ACK_TYPE IS NULL</sql>
        <addNotNullConstraint columnName="ACK_TYPE" columnDataType="TINYINT" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="ACK_TYPE" columnDataType="TINYINT"/>
        </rollback>
    </changeSet>

    <changeSet id="9f761647-9453-46c2-b087-014968a5a630" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for REQ_ACK_TYPE of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="REQ_ACK_TYPE"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.REQ_ACK_TYPE</comment>
        <dropColumn columnName="REQ_ACK_TYPE" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="REQ_ACK_TYPE" type="VARCHAR(255)" remarks="The type of acknowledgement that alarms of this type require."/>
            </addColumn>
        </rollback>
    </changeSet>
    
    <changeSet id="8d07daf0-2382-42af-abe0-4093c302136b" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.PRIORITY as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="PRIORITY"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.PRIORITY</comment>
        <sql>UPDATE ALARMTYPE SET PRIORITY = 2 WHERE PRIORITY IS NULL</sql>
        <addNotNullConstraint columnName="PRIORITY" columnDataType="TINYINT" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="PRIORITY" columnDataType="TINYINT"/>
        </rollback>
    </changeSet>
    
    <changeSet id="40d385c4-a205-4264-863f-071b641ed691" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.SEVERITY as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="SEVERITY"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.SEVERITY</comment>
        <sql>UPDATE ALARMTYPE SET SEVERITY = 2 WHERE SEVERITY IS NULL</sql>
        <addNotNullConstraint columnName="SEVERITY" columnDataType="TINYINT" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="SEVERITY" columnDataType="TINYINT"/>
        </rollback>
    </changeSet>

    <changeSet id="269e27d7-a543-4aa5-925e-85b7ed006591" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.RESOLVE_CATEGORY as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="RESOLVE_CATEGORY"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.RESOLVE_CATEGORY</comment>
        <sql>UPDATE ALARMTYPE SET RESOLVE_CATEGORY = 0 WHERE RESOLVE_CATEGORY IS NULL</sql>
        <addNotNullConstraint columnName="RESOLVE_CATEGORY" columnDataType="TINYINT" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="RESOLVE_CATEGORY" columnDataType="TINYINT"/>
        </rollback>
    </changeSet>

    <changeSet id="80bb6670-406c-4add-be6f-d1173531050a" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.CLOSE_SHIFT as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="CLOSE_SHIFT"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.CLOSE_SHIFT</comment>
        <sql>UPDATE ALARMTYPE SET CLOSE_SHIFT = 0 WHERE CLOSE_SHIFT IS NULL</sql>
        <addNotNullConstraint columnName="CLOSE_SHIFT" columnDataType="BOOLEAN" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="CLOSE_SHIFT" columnDataType="BOOLEAN"/>
        </rollback>
    </changeSet>

    <changeSet id="dea8a3a5-cb1b-40cd-9277-51d4edcc346a" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for IS_ARCHIVED of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="IS_ARCHIVED"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.IS_ARCHIVED</comment>
        <dropColumn columnName="IS_ARCHIVED" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="IS_ARCHIVED" type="BOOLEAN" remarks="Indication of whether this alarm type has been archived or not."/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="fa4ab873-7fca-4686-8e9f-c08b33f3db9d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for ARCHIVE_DATE_UTC of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="ARCHIVE_DATE_UTC"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.ARCHIVE_DATE_UTC</comment>
        <dropColumn columnName="ARCHIVE_DATE_UTC" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="ARCHIVE_DATE_UTC" type="DATETIME2" remarks="The archival date and time of this alarm type."/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="50d1e81e-253b-4b4a-a738-7aac36d20c14" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropForeignKeyConstraint for ALARMTYPE_ARCHIVED_BY_USER_FK of table ALARMTYPE as foreignKey does not exist." onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="ALARMTYPE" foreignKeyName="ALARMTYPE_ARCHIVED_BY_USER_FK"/>
        </preConditions>
        <comment>AHS-7096: DropForeignKeyConstraint ALARMTYPE_ARCHIVED_BY_USER_FK from ALARMTYPE (ARCHIVED_BY_USER)</comment>
        <dropForeignKeyConstraint baseTableName="ALARMTYPE" constraintName="ALARMTYPE_ARCHIVED_BY_USER_FK"/>
        <rollback>
            <addForeignKeyConstraint baseTableName="ALARMTYPE" baseColumnNames="ARCHIVED_BY_USER" constraintName="ALARMTYPE_ARCHIVED_BY_USER_FK" referencedTableName="PERSON" referencedColumnNames="PERSON_OID" onDelete="NO ACTION"/>
        </rollback>
    </changeSet>

    <changeSet id="df0285db-1939-40ce-80cd-5cdea6e3c92f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for ARCHIVED_BY_USER of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="ARCHIVED_BY_USER"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.ARCHIVED_BY_USER</comment>
        <dropColumn columnName="ARCHIVED_BY_USER" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="ARCHIVED_BY_USER" type="BIGINT" remarks="The person who archived this alarm type."/>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="c1b12164-fdb4-4de9-a497-40979dc7b8cc" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored RenameColumn for DESCRIPTION of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="DESCRIPTION"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.DESCRIPTION</comment>
        <renameColumn tableName="ALARMTYPE" oldColumnName="DESCRIPTION" newColumnName="MESSAGE_FORMAT"/>
    </changeSet>

    <changeSet id="972a4f8c-1600-48b7-847d-568549209ca8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddNotNullConstraint for ALARMTYPE.MESSAGE_FORMAT as column does not exist or is already not-nullable" onFail="MARK_RAN">
            <ext:columnIsNullable tableName="ALARMTYPE" columnName="MESSAGE_FORMAT"/>
        </preConditions>
        <comment>AHS-7096: AddNotNullConstraint to ALARMTYPE.MESSAGE_FORMAT</comment>
        <sql>UPDATE ALARMTYPE SET MESSAGE_FORMAT = NAME WHERE MESSAGE_FORMAT IS NULL</sql>
        <addNotNullConstraint columnName="MESSAGE_FORMAT" columnDataType="VARCHAR(4000)" tableName="ALARMTYPE"/>
        <rollback>
            <dropNotNullConstraint tableName="ALARMTYPE" columnName="MESSAGE_FORMAT"/>
        </rollback>
    </changeSet>

    <changeSet id="c6864d4a-9eef-49b0-a8b1-87cbb64a97e0" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for ACTIVE of table ALARMTYPE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ALARMTYPE" columnName="ACTIVE"/>
        </preConditions>
        <comment>AHS-7096: DropColumn ALARMTYPE.ACTIVE</comment>
        <dropColumn columnName="ACTIVE" tableName="ALARMTYPE"/>
        <rollback>
            <addColumn tableName="ALARMTYPE">
                <column name="ACTIVE" type="BOOLEAN" remarks="Indication of whether this alarm type is active (true) or has been archived (false)."/>
            </addColumn>
            <sql>UPDATE ALARMTYPE SET ACTIVE = 1</sql>
        </rollback>
    </changeSet>

    <changeSet id="d2df021b-2852-4263-ba88-e46d7a2ed4c9" author="MineStar" failOnError="false">
        <comment>AHS-7096: Add ALARM_TYPE check constraints</comment>
        <sql>DELETE FROM ALARMTYPE WHERE PRIORITY NOT IN (2,3,4,5)</sql>
        <sql>ALTER TABLE ALARMTYPE ADD CONSTRAINT ALARM_TYPE_PRIORTY_CHECK CHECK (PRIORITY IN (2,3,4,5))</sql>
        <sql>DELETE FROM ALARMTYPE WHERE SEVERITY NOT IN (2,3,4,5)</sql>
        <sql>ALTER TABLE ALARMTYPE ADD CONSTRAINT ALARM_TYPE_SEVERITY_CHECK CHECK (SEVERITY IN (2,3,4,5))</sql>
        <sql>DELETE FROM ALARMTYPE WHERE ACK_TYPE NOT IN (0,1,2)</sql>
        <sql>ALTER TABLE ALARMTYPE ADD CONSTRAINT ALARM_TYPE_ACK_TYPE_CHECK CHECK (ACK_TYPE IN (0,1,2))</sql>
        <sql>DELETE FROM ALARMTYPE WHERE RESOLVE_CATEGORY NOT IN (0,1,2)</sql>
        <sql>ALTER TABLE ALARMTYPE ADD CONSTRAINT ALARM_TYPE_RESOLVE_CHECK CHECK (RESOLVE_CATEGORY IN (0,1,2))</sql>
        <rollback>
            <comment>@EmptyRollback</comment>
        </rollback>
    </changeSet>

</databaseChangeLog>
