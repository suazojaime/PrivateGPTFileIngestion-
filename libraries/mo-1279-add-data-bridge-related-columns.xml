<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2020 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="bdbb73a5-5878-4c6c-803d-432795f40b84" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for DATA_BRIDGE_REF to table MACHINE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MACHINE"/>
            <not>
                <columnExists tableName="MACHINE" columnName="DATA_BRIDGE_REF"/>
            </not>
        </preConditions>
        <comment>MO-1279: AddColumn MACHINE.DATA_BRIDGE_REF</comment>
        <addColumn tableName="MACHINE">
            <column name="DATA_BRIDGE_REF" type="BIGINT"/>
        </addColumn>
    </changeSet>
    <changeSet id="9d45b814-d86f-4baa-82fb-d67f325167a0" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for ENDPOINT_ID to table MACHINE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="MACHINE"/>
            <not>
                <columnExists tableName="MACHINE" columnName="ENDPOINT_ID"/>
            </not>
        </preConditions>
        <comment>MO-1279: AddColumn MACHINE.ENDPOINT_ID</comment>
        <addColumn tableName="MACHINE">
            <column name="ENDPOINT_ID" type="INT"/>
        </addColumn>
    </changeSet>
    <changeSet id="b04e8537-8af8-44bd-ae97-644bfe43c027" author="MineStar" context="Pit_Link/Pit_Link_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_DATA_BRIDGE_REF_FK to table MACHINE as (1) the source or referenced column does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <columnExists tableName="MACHINE" columnName="DATA_BRIDGE_REF"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE" foreignKeyName="MACHINE_DATA_BRIDGE_REF_FK"/>
            </not>
        </preConditions>
        <comment>MO-1279: AddForeignKeyConstraint MACHINE_DATA_BRIDGE_REF_FK to MACHINE (DATA_BRIDGE_REF)</comment>
        <sql>UPDATE MACHINE SET DATA_BRIDGE_REF = NULL WHERE DATA_BRIDGE_REF IS NOT NULL AND DATA_BRIDGE_REF NOT IN (SELECT MACHINE_OID FROM MACHINE)</sql>
        <addForeignKeyConstraint baseTableName="MACHINE" baseColumnNames="DATA_BRIDGE_REF" constraintName="MACHINE_DATA_BRIDGE_REF_FK" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE" constraintName="MACHINE_DATA_BRIDGE_REF_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
