<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="eca978ec-c7f0-4701-a336-b0fa66c7c9b1" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable as tables don't exist." onFail="MARK_RAN">
            <tableExists tableName="DESTINATION_BLEND_PROCESSOR"/>
            <tableExists tableName="DESTINATION_BLEND"/>
        </preConditions>
        <comment>4.6 Dropping tables until the requirements are stabilized</comment>
        <dropTable tableName="DESTINATION_BLEND_PROCESSOR" cascadeConstraints="true"/>
        <dropTable tableName="DESTINATION_BLEND" cascadeConstraints="true"/>
        <rollback/>
    </changeSet>

    <changeSet id="284191e9-d43c-4365-911b-a00849fff32e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropTable as BLEND_CONTROL_STRATEGY doesn't exist" onFail="MARK_RAN">
            <tableExists tableName="BLEND_CONTROL_STRATEGY"/>
        </preConditions>
        <comment>4.6 Dropping table BLEND_CONTROL_STRATEGY</comment>
        <dropTable tableName="BLEND_CONTROL_STRATEGY" cascadeConstraints="true"/>
        <rollback/>
    </changeSet>

    <changeSet id="86d32e87-1e88-4d8a-a7a2-7a050f11f57a" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for DESTINATION_BLEND as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="DESTINATION_BLEND"/>
            </not>
        </preConditions>
        <comment>4.6 CreateTable DESTINATION_BLEND</comment>
        <createTable tablespace="MW_ENT" remarks="A destination blend" tableName="DESTINATION_BLEND">
            <column name="OID" type="BIGINT" remarks="PK">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Is the destination blend active">
                <constraints nullable="false"/>
            </column>
            <column name="BLEND_OID" type="BIGINT" remarks="Blend">
                <constraints nullable="false"/>
            </column>
            <column name="MINIMUM_RATE" type="DOUBLE" remarks="The minimum rate"/>
            <column name="MAXIMUM_RATE" type="DOUBLE" remarks="The maximum rate"/>
            <column name="START_DATE" type="DATETIME2" remarks="Date time destination blend started">
                <constraints nullable="true"/>
            </column>
            <column name="END_DATE" type="DATETIME2" remarks="Date time destination blend ended">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="DESTINATION_BLEND_PK" tablespace="MW_IDXENT" tableName="DESTINATION_BLEND"/>
        <rollback/>
        <modifySql dbms="mssql,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="6c9bb868-d5c2-4fb6-bc05-bc7a9b661af7" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for DST_BLND_OID_BLEND_OID_FK to table DESTINATION_BLEND as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="DESTINATION_BLEND"/>
            <tableExists tableName="BLEND"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DESTINATION_BLEND" foreignKeyName="DST_BLND_OID_BLEND_OID_FK"/>
            </not>
        </preConditions>
        <comment>4.6 AddForeignKeyConstraint DST_BLND_OID_BLEND_OID_FK to DESTINATION_BLEND (BLEND_OID)</comment>
        <addForeignKeyConstraint baseTableName="DESTINATION_BLEND" baseColumnNames="BLEND_OID" constraintName="DST_BLND_OID_BLEND_OID_FK" referencedTableName="BLEND" referencedColumnNames="OID" deleteCascade="false"/>
    </changeSet>

    <changeSet id="e44dd079-000a-43d7-b693-96055afab605" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for DESTINATION_BLEND_PROCESSOR as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="DESTINATION_BLEND_PROCESSOR"/>
            </not>
        </preConditions>
        <comment>4.6 CreateTable DESTINATION_BLEND_PROCESSOR</comment>
        <createTable tablespace="MW_ENT" remarks="The materials allowed for this blend" tableName="DESTINATION_BLEND_PROCESSOR">
            <column name="DESTINATION_BLEND_OID" type="BIGINT" remarks="Destination blend">
                <constraints nullable="false"/>
            </column>
            <column name="PROCESSOR_OID" type="BIGINT" remarks="Processor">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="DESTINATION_BLEND_OID,PROCESSOR_OID" constraintName="DESTINATION_BLEND_PROCESSOR_PK" tablespace="MW_IDXENT" tableName="DESTINATION_BLEND_PROCESSOR"/>
        <rollback/>
        <modifySql dbms="mssql,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>

    <changeSet id="c3075d1f-e304-44ed-a314-0e7f167f716e" author="MineStar" context="Material_Tracking/Material_Tracking_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for DST_BLND_PRC_DEST_BLND_OID_FK,DST_BLND_PRC_PRC_OID_FK to table DESTINATION_BLEND_PROCESSOR as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="DESTINATION_BLEND_PROCESSOR"/>
            <tableExists tableName="DESTINATION_BLEND"/>
            <tableExists tableName="MACHINE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DESTINATION_BLEND_PROCESSOR" foreignKeyName="DST_BLND_PRC_DEST_BLND_OID_FK"/>
            </not>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DESTINATION_BLEND_PROCESSOR" foreignKeyName="DST_BLND_PRC_PRC_OID_FK"/>
            </not>
        </preConditions>
        <comment>4.6 AddForeignKeyConstraint DST_BLND_PRC_DEST_BLND_OID_FK,DST_BLND_PRC_PRC_OID_FK to DESTINATION_BLEND_PROCESSOR (DESTINATION_BLEND_OID,PROCESSOR_OID)</comment>
        <addForeignKeyConstraint baseTableName="DESTINATION_BLEND_PROCESSOR" baseColumnNames="DESTINATION_BLEND_OID" constraintName="DST_BLND_PRC_DEST_BLND_OID_FK" referencedTableName="DESTINATION_BLEND" referencedColumnNames="OID" deleteCascade="false"/>
        <addForeignKeyConstraint baseTableName="DESTINATION_BLEND_PROCESSOR" baseColumnNames="PROCESSOR_OID" constraintName="DST_BLND_PRC_PRC_OID_FK" referencedTableName="MACHINE" referencedColumnNames="MACHINE_OID" deleteCascade="false"/>
    </changeSet>

    <changeSet id="5b4fe4db-7475-40e5-aff3-9ac27d630688" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn BLEND_METHOD to table BLEND because either (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <not>
                <columnExists tableName="BLEND" columnName="BLEND_METHOD"/>
            </not>
        </preConditions>
        <comment>4.6 AddColumn BLEND_METHOD</comment>
        <addColumn tableName="BLEND">
            <column name="BLEND_METHOD" type="VARCHAR(255)" remarks="Blend computation method">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="ba8bd07a-d29e-4046-a94f-d9954dcddc95" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn LAST_BATCH_MASS_DATE to table DESTINATION_BLEND because either (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <not>
                <columnExists tableName="DESTINATION_BLEND" columnName="LAST_BATCH_MASS_DATE"/>
            </not>
        </preConditions>
        <addColumn tableName="DESTINATION_BLEND">
            <column name="LAST_BATCH_MASS_DATE" type="DATETIME2" remarks="Date time last batch mass update">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
