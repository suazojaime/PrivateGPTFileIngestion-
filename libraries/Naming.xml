<!-- Copyright (c) 2022 Caterpillar -->

<!--
    Beans for naming on the server side, e.g. to register yourself in naming.
-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:condbean="http://www.minestar.au.cat.com/springbeans/condbean"
       xsi:schemaLocation="
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.minestar.au.cat.com/springbeans/condbean http://www.minestar.au.cat.com/springbeans/condbean/condbeans.xsd">

    <bean id="rmiSocketFactory"
          class="minestar.security.base.RmiSocketFactory"
          factory-method="getInstance"
          lazy-init="true"/>

    <condbean:cond appName="MineTracking">
        <!-- MineTracking creates the RMI registry -->
        <bean id="rmiRegistry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean">
            <property name="alwaysCreate" value="true"/>
            <property name="port" value="${MSTAR_BUS_PORT}"/>
            <property name="clientSocketFactory" ref="rmiSocketFactory"/>
            <property name="serverSocketFactory" ref="rmiSocketFactory"/>
        </bean>
    </condbean:cond>
    <condbean:cond notAppName="MineTracking">
        <!-- Other processes use the RMI registry hosted by MineTracking-->
        <bean id="rmiRegistry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean" lazy-init="true">
            <property name="host" value="${_HOME}"/>
            <property name="port" value="${MSTAR_BUS_PORT}"/>
            <property name="clientSocketFactory" ref="rmiSocketFactory"/>
            <property name="serverSocketFactory" ref="rmiSocketFactory"/>
        </bean>
    </condbean:cond>

    <bean id="setBusHandle" class="com.mincom.env.service.server.SetBusHandle" lazy-init="true"
          init-method="init" depends-on="rmiRegistry">
        <property name="host" value="${_HOME}"/>
        <property name="port" value="${MSTAR_BUS_PORT}"/>
        <property name="busName" value="${_BUS_NAME}"/>
    </bean>

    <!-- Perform remote service registration after server startup -->
    <bean class="minestar.platform.service.remoting.rmi.RemoteServiceRegistrationListener"/>

    <bean id="registrationInstance" class="minestar.platform.service.remoting.ServiceRegistration"
          factory-method="register" lazy-init="true" abstract="true" depends-on="setBusHandle"/>
</beans>
