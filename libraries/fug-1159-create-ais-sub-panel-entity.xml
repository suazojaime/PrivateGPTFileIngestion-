<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="a3ee3d03-fa41-40c4-af76-a194b344169e" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for AIS_SUBPANEL as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="AIS_SUBPANEL"/>
            </not>
        </preConditions>
        <comment>FUG-1159: CreateTable AIS_SUBPANEL</comment>
        <createTable tablespace="MW_ENT" remarks="A AIS SubPanel entity" tableName="AIS_SUBPANEL">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(254)" remarks="The unique, user-entered identifier for this ais subpanel.">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="INT" remarks="AIS Sub Panel Type">
                <constraints nullable="false"/>
            </column>
            <column name="ARMED_STATUS" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="ARM_STATUS_TAG" type="VARCHAR(254)" remarks="Arm Status Tag representing the sub panel status">
                <constraints nullable="false"/>
            </column>
            <column name="ARCHIVED" type="BOOLEAN" remarks="Whether this sub panel is archived. (This flag is '1' if it is armed and '0' if not.)">
                <constraints nullable="false"/>
            </column>
            <column name="ALARM_STATUS" type="INT" remarks="Alarm status of the sub panel"/>
            <column name="MODEL_UPDATE_VERSION" type="BIGINT" remarks="The is a copy of the system wide version number."/>
            <column name="UGPANEL_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="AIS_SUBPANEL_PK" tablespace="MW_IDXENT" tableName="AIS_SUBPANEL"/>
        <addUniqueConstraint columnNames="UGPANEL_OID" constraintName="AIS_SUBPANEL_UGPANEL_OID_UK" tableName="AIS_SUBPANEL"/>
        <rollback>
            <dropTable tableName="AIS_SUBPANEL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="1520cd3e-47ef-44d6-900f-11314447c816" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for SUBPANEL_BARRIERS as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="SUBPANEL_BARRIERS"/>
            </not>
        </preConditions>
        <comment>FUG-1159: CreateTable SUBPANEL_BARRIERS</comment>
        <createTable tablespace="MW_ENT" remarks="Barriers included in the sub panel." tableName="SUBPANEL_BARRIERS">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="BARRIER_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SORT_ORDER" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="OID,SORT_ORDER" constraintName="SUBPANEL_BARRIERS_PK" tablespace="MW_IDXENT" tableName="SUBPANEL_BARRIERS"/>
        <rollback>
            <dropTable tableName="SUBPANEL_BARRIERS"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="092ad694-c193-4487-a094-80253d0c53c5" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for AIS_SUBPANEL_UGPANEL_OID_FK to table AIS_SUBPANEL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="AIS_SUBPANEL"/>
            <tableExists tableName="UNDERGROUND_PANEL"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="AIS_SUBPANEL" foreignKeyName="AIS_SUBPANEL_UGPANEL_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-1159: AddForeignKeyConstraint AIS_SUBPANEL_UGPANEL_OID_FK to AIS_SUBPANEL (UGPANEL_OID)</comment>
        <sql>DELETE FROM AIS_SUBPANEL WHERE UGPANEL_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM UNDERGROUND_PANEL WHERE UNDERGROUND_PANEL.OID = AIS_SUBPANEL.UGPANEL_OID)</sql>
        <addForeignKeyConstraint baseTableName="AIS_SUBPANEL" baseColumnNames="UGPANEL_OID" constraintName="AIS_SUBPANEL_UGPANEL_OID_FK" referencedTableName="UNDERGROUND_PANEL" referencedColumnNames="OID" onDelete="CASCADE"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="AIS_SUBPANEL" constraintName="AIS_SUBPANEL_UGPANEL_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="f6ea49c6-6e7f-480b-b569-d3665f0049d1" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for SUBPANEL_BARRIERS_OID_FK to table SUBPANEL_BARRIERS as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="SUBPANEL_BARRIERS"/>
            <tableExists tableName="AIS_SUBPANEL"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="SUBPANEL_BARRIERS" foreignKeyName="SUBPANEL_BARRIERS_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-1159: AddForeignKeyConstraint SUBPANEL_BARRIERS_OID_FK to SUBPANEL_BARRIERS (OID)</comment>
        <sql>DELETE FROM SUBPANEL_BARRIERS WHERE OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM AIS_SUBPANEL WHERE AIS_SUBPANEL.OID = SUBPANEL_BARRIERS.OID)</sql>
        <addForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" baseColumnNames="OID" constraintName="SUBPANEL_BARRIERS_OID_FK" referencedTableName="AIS_SUBPANEL" referencedColumnNames="OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="SUBPANEL_BARRIERS" constraintName="SUBPANEL_BARRIERS_OID_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
