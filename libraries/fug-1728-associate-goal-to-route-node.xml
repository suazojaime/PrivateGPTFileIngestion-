<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="dd255763-c084-460a-8585-09006eb7cd8a" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for DUMP_GOAL_PK of table DUMP_GOAL as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="DUMP_GOAL_PK" tableName="DUMP_GOAL"/>
        </preConditions>
        <comment>FUG-1728: DropPrimaryKey DUMP_GOAL_PK from DUMP_GOAL (DUMP_GOAL_OID)</comment>
        <dropPrimaryKey constraintName="DUMP_GOAL_PK" tableName="DUMP_GOAL"/>
        <rollback>
            <addPrimaryKey columnNames="DUMP_GOAL_OID" constraintName="DUMP_GOAL_PK" tableName="DUMP_GOAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="910a7700-a272-4547-aad8-81e0aa49a19f" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for DUMP_GOAL_OID of table DUMP_GOAL as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="DUMP_GOAL" columnName="DUMP_GOAL_OID"/>
        </preConditions>
        <comment>FUG-1728: DropColumn DUMP_GOAL.DUMP_GOAL_OID</comment>
        <dropColumn columnName="DUMP_GOAL_OID" tableName="DUMP_GOAL"/>
        <rollback>
            <addColumn tableName="DUMP_GOAL">
                <column name="DUMP_GOAL_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="84ec84a2-6886-4b7c-9c87-e7769f880042" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropDefaultValue for DUMP_GOAL.IS_ASSIGNABLE as column does not exist or column does not have a default value" onFail="MARK_RAN">
            <ext:columnHasDefaultValue tableName="DUMP_GOAL" columnName="IS_ASSIGNABLE"/>
        </preConditions>
        <comment>FUG-1728: DropDefaultValue '1' from DUMP_GOAL.IS_ASSIGNABLE</comment>
        <dropDefaultValue columnName="IS_ASSIGNABLE" columnDataType="BOOLEAN" tableName="DUMP_GOAL"/>
        <rollback>
            <addDefaultValue columnName="IS_ASSIGNABLE" columnDataType="BOOLEAN" defaultValueBoolean="true" tableName="DUMP_GOAL"/>
        </rollback>
    </changeSet>
    <changeSet id="b57ba766-7f19-4a0c-a72a-96636e89f126" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for ROUTE_NODE_OID to table DUMP_GOAL as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="DUMP_GOAL"/>
            <not>
                <columnExists tableName="DUMP_GOAL" columnName="ROUTE_NODE_OID"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddColumn DUMP_GOAL.ROUTE_NODE_OID</comment>

        <!-- table must be empty to add mandatory (NOT NULL) column)
          Load Goals / Dump Goals are not in use at any customer site yet -->
        <sql dbms="oracle">DELETE FROM DUMP_GOAL</sql>

        <addColumn tableName="DUMP_GOAL">
            <column name="ROUTE_NODE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="DUMP_GOAL" columnName="ROUTE_NODE_OID"/>
        </rollback>
    </changeSet>
    <changeSet id="9c887fd7-78d2-4118-bf92-9ffab75e856b" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for DUMP_GOAL_PK to table DUMP_GOAL as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="DUMP_GOAL"/>
            <not>
                <primaryKeyExists primaryKeyName="DUMP_GOAL_PK" tableName="DUMP_GOAL"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddPrimaryKey DUMP_GOAL_PK to DUMP_GOAL (ROUTE_NODE_OID)</comment>
        <addPrimaryKey columnNames="ROUTE_NODE_OID" constraintName="DUMP_GOAL_PK" tablespace="MW_IDXENT" tableName="DUMP_GOAL"/>
        <rollback>
            <dropPrimaryKey constraintName="DUMP_GOAL_PK" tableName="DUMP_GOAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="a1ae7cf7-7a37-42fc-9561-0cc376b7b5e8" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropPrimaryKey for LOAD_GOAL_PK of table LOAD_GOAL as primaryKey does not exist." onFail="MARK_RAN">
            <primaryKeyExists primaryKeyName="LOAD_GOAL_PK" tableName="LOAD_GOAL"/>
        </preConditions>
        <comment>FUG-1728: DropPrimaryKey LOAD_GOAL_PK from LOAD_GOAL (LOAD_GOAL_OID)</comment>
        <dropPrimaryKey constraintName="LOAD_GOAL_PK" tableName="LOAD_GOAL"/>
        <rollback>
            <addPrimaryKey columnNames="LOAD_GOAL_OID" constraintName="LOAD_GOAL_PK" tableName="LOAD_GOAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="f0b42d33-9d2c-4805-a30d-cb44eaf531da" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for LOAD_GOAL_OID of table LOAD_GOAL as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="LOAD_GOAL" columnName="LOAD_GOAL_OID"/>
        </preConditions>
        <comment>FUG-1728: DropColumn LOAD_GOAL.LOAD_GOAL_OID</comment>
        <dropColumn columnName="LOAD_GOAL_OID" tableName="LOAD_GOAL"/>
        <rollback>
            <addColumn tableName="LOAD_GOAL">
                <column name="LOAD_GOAL_OID" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="ab206d35-648a-4b8a-8824-897f038600cd" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for ROUTE_NODE_OID to table LOAD_GOAL as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LOAD_GOAL"/>
            <not>
                <columnExists tableName="LOAD_GOAL" columnName="ROUTE_NODE_OID"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddColumn LOAD_GOAL.ROUTE_NODE_OID</comment>

        <!-- table must be empty to add mandatory (NOT NULL) column)
          Load Goals / Dump Goals are not in use at any customer site yet -->
        <sql dbms="oracle">DELETE FROM LOAD_GOAL</sql>

        <addColumn tableName="LOAD_GOAL">
            <column name="ROUTE_NODE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="LOAD_GOAL" columnName="ROUTE_NODE_OID"/>
        </rollback>
    </changeSet>
    <changeSet id="87b90c9a-2739-4af8-9ddf-ef149d27d4fd" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddPrimaryKey for LOAD_GOAL_PK to table LOAD_GOAL as table does not exist or primaryKey already exists." onFail="MARK_RAN">
            <tableExists tableName="LOAD_GOAL"/>
            <not>
                <primaryKeyExists primaryKeyName="LOAD_GOAL_PK" tableName="LOAD_GOAL"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddPrimaryKey LOAD_GOAL_PK to LOAD_GOAL (ROUTE_NODE_OID)</comment>
        <addPrimaryKey columnNames="ROUTE_NODE_OID" constraintName="LOAD_GOAL_PK" tablespace="MW_IDXENT" tableName="LOAD_GOAL"/>
        <rollback>
            <dropPrimaryKey constraintName="LOAD_GOAL_PK" tableName="LOAD_GOAL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="d2643a78-f585-4e8e-822d-9ea5ad90832b" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for POSITION_X of table ROUTE_NODE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ROUTE_NODE" columnName="POSITION_X"/>
        </preConditions>
        <comment>FUG-1728: DropColumn ROUTE_NODE.POSITION_X</comment>
        <dropColumn columnName="POSITION_X" tableName="ROUTE_NODE"/>
        <rollback>
            <addColumn tableName="ROUTE_NODE">
                <column name="POSITION_X" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="9bb59946-c113-4f6b-bc27-bc060b70e177" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for POSITION_Y of table ROUTE_NODE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ROUTE_NODE" columnName="POSITION_Y"/>
        </preConditions>
        <comment>FUG-1728: DropColumn ROUTE_NODE.POSITION_Y</comment>
        <dropColumn columnName="POSITION_Y" tableName="ROUTE_NODE"/>
        <rollback>
            <addColumn tableName="ROUTE_NODE">
                <column name="POSITION_Y" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="16609bd1-1e40-4789-81db-c109ca39ea2e" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for POSITION_Z of table ROUTE_NODE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="ROUTE_NODE" columnName="POSITION_Z"/>
        </preConditions>
        <comment>FUG-1728: DropColumn ROUTE_NODE.POSITION_Z</comment>
        <dropColumn columnName="POSITION_Z" tableName="ROUTE_NODE"/>
        <rollback>
            <addColumn tableName="ROUTE_NODE">
                <column name="POSITION_Z" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet id="47d30c9e-e868-4261-a4b4-07fc56bd1410" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for ROUTE_NODE_IMPL as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="ROUTE_NODE_IMPL"/>
            </not>
        </preConditions>
        <comment>FUG-1728: CreateTable ROUTE_NODE_IMPL</comment>

        <!-- Existing routes aren't much use. Underground Routes are not in use at any customer site yet -->
        <sql dbms="oracle">DELETE FROM ROUTE</sql>
        <sql dbms="oracle">DELETE FROM ROUTE_NODE</sql>

        <createTable tablespace="MW_ENT" remarks="A point in the map used for underground path-planning." tableName="ROUTE_NODE_IMPL">
            <column name="ROUTE_NODE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="POSITION_X" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
            <column name="POSITION_Y" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
            <column name="POSITION_Z" type="DOUBLE" remarks="Position on map that this route node is associated with."/>
        </createTable>
        <addPrimaryKey columnNames="ROUTE_NODE_OID" constraintName="ROUTE_NODE_IMPL_PK" tablespace="MW_IDXENT" tableName="ROUTE_NODE_IMPL"/>
        <rollback>
            <dropTable tableName="ROUTE_NODE_IMPL"/>
        </rollback>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="2b58d5df-4c00-4e16-a91f-3b034c456438" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for ROUTE_NODE_IMPL_ROUTE_NODE_FK to table ROUTE_NODE_IMPL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="ROUTE_NODE_IMPL"/>
            <tableExists tableName="ROUTE_NODE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="ROUTE_NODE_IMPL" foreignKeyName="ROUTE_NODE_IMPL_ROUTE_NODE_FK"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddForeignKeyConstraint ROUTE_NODE_IMPL_ROUTE_NODE_FK to ROUTE_NODE_IMPL (ROUTE_NODE_OID)</comment>
        <sql>DELETE FROM ROUTE_NODE_IMPL WHERE ROUTE_NODE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM ROUTE_NODE WHERE ROUTE_NODE.ROUTE_NODE_OID = ROUTE_NODE_IMPL.ROUTE_NODE_OID)</sql>
        <addForeignKeyConstraint baseTableName="ROUTE_NODE_IMPL" baseColumnNames="ROUTE_NODE_OID" constraintName="ROUTE_NODE_IMPL_ROUTE_NODE_FK" referencedTableName="ROUTE_NODE" referencedColumnNames="ROUTE_NODE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="ROUTE_NODE_IMPL" constraintName="ROUTE_NODE_IMPL_ROUTE_NODE_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="0d61b44d-4cb1-46be-a69b-fed58fc810b0" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for DUMP_GOAL_ROUTE_NODE_OID_FK to table DUMP_GOAL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="DUMP_GOAL"/>
            <tableExists tableName="ROUTE_NODE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="DUMP_GOAL" foreignKeyName="DUMP_GOAL_ROUTE_NODE_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddForeignKeyConstraint DUMP_GOAL_ROUTE_NODE_OID_FK to DUMP_GOAL (ROUTE_NODE_OID)</comment>
        <sql>DELETE FROM DUMP_GOAL WHERE ROUTE_NODE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM ROUTE_NODE WHERE ROUTE_NODE.ROUTE_NODE_OID = DUMP_GOAL.ROUTE_NODE_OID)</sql>
        <addForeignKeyConstraint baseTableName="DUMP_GOAL" baseColumnNames="ROUTE_NODE_OID" constraintName="DUMP_GOAL_ROUTE_NODE_OID_FK" referencedTableName="ROUTE_NODE" referencedColumnNames="ROUTE_NODE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="DUMP_GOAL" constraintName="DUMP_GOAL_ROUTE_NODE_OID_FK"/>
        </rollback>
    </changeSet>
    <changeSet id="d9c5ab8d-396b-42f8-ba23-d9a825445a46" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for LOAD_GOAL_ROUTE_NODE_OID_FK to table LOAD_GOAL as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="LOAD_GOAL"/>
            <tableExists tableName="ROUTE_NODE"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="LOAD_GOAL" foreignKeyName="LOAD_GOAL_ROUTE_NODE_OID_FK"/>
            </not>
        </preConditions>
        <comment>FUG-1728: AddForeignKeyConstraint LOAD_GOAL_ROUTE_NODE_OID_FK to LOAD_GOAL (ROUTE_NODE_OID)</comment>
        <sql>DELETE FROM LOAD_GOAL WHERE ROUTE_NODE_OID IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM ROUTE_NODE WHERE ROUTE_NODE.ROUTE_NODE_OID = LOAD_GOAL.ROUTE_NODE_OID)</sql>
        <addForeignKeyConstraint baseTableName="LOAD_GOAL" baseColumnNames="ROUTE_NODE_OID" constraintName="LOAD_GOAL_ROUTE_NODE_OID_FK" referencedTableName="ROUTE_NODE" referencedColumnNames="ROUTE_NODE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="LOAD_GOAL" constraintName="LOAD_GOAL_ROUTE_NODE_OID_FK"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
