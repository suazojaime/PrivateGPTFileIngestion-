<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="2a70e0ea-2445-48ae-b658-07d80c29d8db" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for HAZARD_STATUS to table UG_CHUTE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="UG_CHUTE"/>
            <not>
                <columnExists tableName="UG_CHUTE" columnName="HAZARD_STATUS"/>
            </not>
        </preConditions>
        <comment>FUG-3529: AddColumn UG_CHUTE.HAZARD_STATUS</comment>
        <addColumn tableName="UG_CHUTE">
            <column name="HAZARD_STATUS" type="BIGINT" remarks="A reference to the hazard level (MSMODEL.CHUTE_HAZARD_STATUS) that describes the current operating conditions of this chute."/>
        </addColumn>
    </changeSet>
    <changeSet id="27f0ed8b-9aea-4ba5-9f4b-6789077a253c" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for CHUTE_HAZARD_STATUS as table already exists." onFail="MARK_RAN">
            <not>
                <tableExists tableName="CHUTE_HAZARD_STATUS"/>
            </not>
        </preConditions>
        <comment>FUG-3529: CreateTable CHUTE_HAZARD_STATUS</comment>
        <createTable tablespace="MW_ENT" remarks="A site-configurable value to describe the hazard level of chutes in the haulage level of underground mines." tableName="CHUTE_HAZARD_STATUS">
            <column name="OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" remarks="Whether this status is active or archived. (This flag is '1' if it is active and '0' if archived.)">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(255)" remarks="The short, coded textual representation of this status.">
                <constraints nullable="false"/>
            </column>
            <column name="COMMENTS" type="VARCHAR(1000)" remarks="Additional user comments on this status."/>
            <column name="DISPLAY_COLOR_RED" type="INT" remarks="The red value of the background color used to represent this status."/>
            <column name="DISPLAY_COLOR_GREEN" type="INT" remarks="The green value of the background color used to represent this status."/>
            <column name="DISPLAY_COLOR_BLUE" type="INT" remarks="The blue value of the background color used to represent this status."/>
        </createTable>
        <addPrimaryKey columnNames="OID" constraintName="CHUTE_HAZARD_STATUS_PK" tablespace="MW_IDXENT" tableName="CHUTE_HAZARD_STATUS"/>
        <addUniqueConstraint columnNames="NAME" constraintName="CHUTE_HAZARD_STATUS_NAME_UK" tableName="CHUTE_HAZARD_STATUS"/>
        <modifySql dbms="mssql,h2,postgresql">
            <regExpReplace replace="( USING INDEX)? (ON|TABLESPACE) MW_[A-Z]+" with=""/>
        </modifySql>
    </changeSet>
    <changeSet id="e335752e-c582-4c37-b736-a1ba4d80b39d" author="MineStar" context="Underground/Underground_Management" failOnError="false">
        <preConditions onFailMessage="Ignored AddForeignKeyConstraint for UG_CHUTE_HAZARD_STATUS_FK to table UG_CHUTE as (1) the table does not exist, or (2) the foreignKey already exists." onFail="MARK_RAN">
            <tableExists tableName="UG_CHUTE"/>
            <tableExists tableName="CHUTE_HAZARD_STATUS"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="UG_CHUTE" foreignKeyName="UG_CHUTE_HAZARD_STATUS_FK"/>
            </not>
        </preConditions>
        <comment>FUG-3529: AddForeignKeyConstraint UG_CHUTE_HAZARD_STATUS_FK to UG_CHUTE (HAZARD_STATUS)</comment>
        <!-- sql>UPDATE UG_CHUTE SET HAZARD_STATUS = NULL WHERE HAZARD_STATUS IS NOT NULL AND NOT EXISTS (SELECT 'x' FROM CHUTE_HAZARD_STATUS WHERE CHUTE_HAZARD_STATUS.OID = UG_CHUTE.HAZARD_STATUS)</sql -->
        <addForeignKeyConstraint baseTableName="UG_CHUTE" baseColumnNames="HAZARD_STATUS" constraintName="UG_CHUTE_HAZARD_STATUS_FK" referencedTableName="CHUTE_HAZARD_STATUS" referencedColumnNames="OID" onDelete="NO ACTION"/>
    </changeSet>
</databaseChangeLog>
