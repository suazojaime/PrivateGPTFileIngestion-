<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- Copyright (c) 2021 Caterpillar -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="ff91137d-4cb1-452e-a278-e9370eb42c4f" author="MineStar" context="Pit_Link/Pit_Link_Management"
               failOnError="false">
        <preConditions onFailMessage="Ignored CreateTable for MACHINE_FEATURE_FLAGS as table already exists."
                       onFail="MARK_RAN">
            <not>
                <tableExists tableName="MACHINE_FEATURE_FLAGS"/>
            </not>
        </preConditions>
        <comment>MO-2573: CreateTable MACHINE_FEATURE_FLAGS</comment>
        <createTable remarks="Feature flags associated with the machine." tableName="MACHINE_FEATURE_FLAGS">
            <column name="MACHINE_OID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="FEATURE_NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="FLAG" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="MACHINE_OID,FEATURE_NAME" constraintName="MACHINE_FEATURE_FLAGS_PK"
                       tableName="MACHINE_FEATURE_FLAGS"/>
    </changeSet>
    
    <changeSet id="72999836-dcd2-4b98-ac90-f7292dedcb59" author="MineStar" context="Pit_Link/Pit_Link_Management"
               failOnError="false">
        <preConditions
                onFailMessage="Ignored AddForeignKeyConstraint for MACHINE_FEATURE_FLAGS_MACHI_FK to table MACHINE_FEATURE_FLAGS as (1) the source or referenced column does not exist, or (2) the foreignKey already exists."
                onFail="MARK_RAN">
            <columnExists tableName="MACHINE_FEATURE_FLAGS" columnName="MACHINE_OID"/>
            <columnExists tableName="MACHINE" columnName="MACHINE_OID"/>
            <not>
                <foreignKeyConstraintExists foreignKeyTableName="MACHINE_FEATURE_FLAGS"
                                            foreignKeyName="MACHINE_FEATURE_FLAGS_MACHI_FK"/>
            </not>
        </preConditions>
        <comment>MO-2573: AddForeignKeyConstraint MACHINE_FEATURE_FLAGS_MACHI_FK to MACHINE_FEATURE_FLAGS (MACHINE_OID)
        </comment>
        <sql>DELETE FROM MACHINE_FEATURE_FLAGS
             WHERE MACHINE_OID IS NOT NULL
             AND NOT EXISTS (SELECT 'x' FROM MACHINE WHERE MACHINE.MACHINE_OID = MACHINE_FEATURE_FLAGS.MACHINE_OID)
        </sql>
        <addForeignKeyConstraint baseTableName="MACHINE_FEATURE_FLAGS" baseColumnNames="MACHINE_OID"
                                 constraintName="MACHINE_FEATURE_FLAGS_MACHI_FK" referencedTableName="MACHINE"
                                 referencedColumnNames="MACHINE_OID" onDelete="NO ACTION"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="MACHINE_FEATURE_FLAGS"
                                      constraintName="MACHINE_FEATURE_FLAGS_MACHI_FK"/>
        </rollback>
    </changeSet>
    
</databaseChangeLog>
