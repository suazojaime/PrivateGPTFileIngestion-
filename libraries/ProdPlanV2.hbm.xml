<?xml version="1.0"?>
<!-- Copyright (c) 2021 Caterpillar -->

<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping schema="model" default-access="field" default-lazy="false">

    <!-- ****************************************************************************** -->
    <!-- Plan -->
    <!-- ****************************************************************************** -->
    <class name="minestar.planmanagement.domain.v2.ProdPlanV2" table="PROD_PLAN" schema="model" >
        <meta attribute="index">
            name=EXTERNAL_REF
            unique=true
            columns=EXTERNAL_REF
        </meta>
        <meta attribute="index">
            name=PLANNED_START_TIMESTAMP
            unique=false
            columns=PLANNED_START_TIMESTAMP_UTC
        </meta>
        <meta attribute="index">
            name=PLANNED_END_TIMESTAMP
            unique=false
            columns=PLANNED_END_TIMESTAMP_UTC
        </meta>
        <meta attribute="index">
            name=ACTUAL_START_TIMESTAMP
            unique=false
            columns=ACTUAL_START_TIMESTAMP_UTC
        </meta>
        <meta attribute="index">
            name=ACTUAL_END_TIMESTAMP
            unique=false
            columns=ACTUAL_END_TIMESTAMP_UTC
        </meta>
        <meta attribute="index">
            name=CREATED_DATE
            unique=false
            columns=CREATED_DATE_UTC
        </meta>
        <meta attribute="foreign-key">on-delete=CASCADE</meta>

        <meta attribute="description">Store Plan details</meta>

        <!--
        NOTE: cache elements explicitly removed from this file to allow for use of blob json field in ProdPlan
        -->

        <id name="OID" type="java.lang.Long" column="OID">
            <generator class="com.mincom.env.base.persistence.IDGenerator"/>
        </id>

        <version name="version" access="field" column="version">
            <meta attribute="description">The version number for optimistic locking</meta>
        </version>
        
        <property name="externalRef" type="java.lang.String" column="EXTERNAL_REF" length="254" not-null="true" unique="true"/>
        <property name="siteName" type="java.lang.String" column="SITE_NAME" length="254"/>

        <property name="plannedStartTimeStamp" type="TimestampType" column="PLANNED_START_TIMESTAMP_UTC" not-null="true">
            <meta attribute="utc-description">The plan start utc timestamp</meta>
            <meta attribute="description">The timestamp of plan starting</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="plannedEndTimeStamp" type="TimestampType" column="PLANNED_END_TIMESTAMP_UTC" not-null="true">
            <meta attribute="utc-description">The plan end utc timestamp</meta>
            <meta attribute="description">The timestamp of plan ending</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="actualStartTimeStamp" type="TimestampType" column="ACTUAL_START_TIMESTAMP_UTC">
            <meta attribute="utc-description">The plan start utc timestamp</meta>
            <meta attribute="description">The timestamp of plan starting</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="actualEndTimeStamp" type="TimestampType" column="ACTUAL_END_TIMESTAMP_UTC">
            <meta attribute="utc-description">The plan end utc timestamp</meta>
            <meta attribute="description">The timestamp of plan ending</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="messageTimeStamp" type="TimestampType" column="MESSAGE_TIMESTAMP_UTC">
            <meta attribute="utc-description">Plan Issued utc timestamp</meta>
            <meta attribute="description">The timestamp of message</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="createdDate" type="TimestampType" column="CREATED_DATE_UTC">
            <meta attribute="utc-description">Plan created utc timestamp</meta>
            <meta attribute="description">The timestamp of plan created</meta>
            <meta attribute="view-localtime">true</meta>
        </property>
        <property name="lastUpdatedDate" type="TimestampType" column="UPDATED_DATE_UTC">
            <meta attribute="utc-description">Plan created utc timestamp</meta>
            <meta attribute="description">The timestamp of plan created</meta>
            <meta attribute="view-localtime">true</meta>
        </property>

        <property name="status" column="STATUS" length="254" not-null="true">
            <meta attribute="description">Status</meta>
            <type name="org.hibernate.type.EnumType">
                <param name="enumClass">minestar.planmanagement.domain.v2.ProdPlanV2$Status</param>
                <param name="type">12</param>
                <param name="useNamed">true</param>
            </type>
        </property>
        
        <property name="actualExpit" column="ACTUAL_EXPIT">
            <meta attribute="description">How much was taken out of grade blocks during plan duration.</meta>
            <meta attribute="unitType">mass</meta>
            <type name="quantity">
                <param name="unitType">mass</param>
                <param name="nullable">true</param>
            </type>
        </property>
        
        <property name="actualRehandle" column="ACTUAL_REHANDLE">
            <meta attribute="description">How much was taken out of stockpiles during plan duration.</meta>
            <meta attribute="unitType">mass</meta>
            <type name="quantity">
                <param name="unitType">mass</param>
                <param name="nullable">true</param>
            </type>
        </property>

        <property name="originalJson" column="PLAN_JSON" type="binary" lazy="true">
            <meta attribute="json">JSON</meta>
            <type name="org.hibernate.type.BlobType"/>
        </property>

        <set name="planReferenceWarnings" table="PROD_PLAN_REFERENCE_WARNING" cascade="all" fetch="select" sort="natural">
            <meta attribute="collection-primary-key">
                columns=PLAN_OID,REFERENCE,REFERENCE_TYPE
            </meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanReferenceWarning">
                <property name="reference" type="java.lang.String" column="REFERENCE" length="254" not-null="true"/>
                <property name="referenceType" column="REFERENCE_TYPE" length="254" not-null="true">
                    <meta attribute="description">referenceType</meta>
                    <type name="org.hibernate.type.EnumType">
                        <param name="enumClass">minestar.planmanagement.domain.v2.ProdPlanReferenceWarning$ReferenceType</param>
                        <param name="type">12</param>
                        <param name="useNamed">true</param>
                    </type>
                </property>
            </composite-element>
        </set>

        <list name="planJobs" table="PROD_PLAN_JOB" cascade="all" fetch="select">
            <meta attribute="view-include">false</meta>
            <meta attribute="view-ignore">true</meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <list-index column="JOB_NR"/>
            <one-to-many class="minestar.planmanagement.domain.v2.ProdPlanJobV2"/>
        </list>

        <set name="planVariations" table="PROD_PLAN_VARIATION" cascade="all" fetch="select" >
            <meta attribute="view-include">false</meta>
            <meta attribute="view-ignore">true</meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <one-to-many class="minestar.planmanagement.domain.v2.ProdPlanVariation"/>
        </set>

        <set name="sourceBlocks" table="PROD_PLAN_SOURCE_BLOCK" cascade="all" fetch="select" sort="natural">
            <meta attribute="collection-primary-key">
                columns=PLAN_OID,REFERENCE_ID
            </meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanSourceBlock">
                <property name="referenceId" type="java.lang.String" column="REFERENCE_ID" length="254" not-null="true"/>
                <many-to-one name="ref"
                             class="minestar.mine.domain.material.GradeBlockReference"
                             column="BLOCK_OID"
                             not-found="ignore">
                    <meta attribute="alias">gradeBlock</meta>
                </many-to-one>
                <property name="availableMass"
                          column="AVAILABLE_MASS">
                    <meta attribute="unitType">mass</meta>
                    <type name="quantity">
                        <param name="unitType">mass</param>
                    </type>
                </property>
                <property name="availableVolume"
                          column="AVAILABLE_VOLUME">
                    <meta attribute="unitType">volume</meta>
                    <type name="quantity">
                        <param name="unitType">volume</param>
                    </type>
                </property>
                <property name="comments" column="COMMENTS" length="65536"/>
            </composite-element>
        </set>

        <set name="sourceStockpiles" table="PROD_PLAN_SOURCE_STOCKPILE" cascade="all" fetch="select" sort="natural">
            <meta attribute="collection-primary-key">
                columns=PLAN_OID,REFERENCE_ID
            </meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanSourceStockpile">
                <property name="referenceId" type="java.lang.String" column="REFERENCE_ID" length="254" not-null="true"/>
                <many-to-one name="ref"
                             class="minestar.mine.domain.material.GradeBlockReference"
                             column="STOCKPILE_OID"
                             not-found="ignore">
                    <meta attribute="alias">gradeBlock</meta>
                </many-to-one>
                <property name="geometry" type="java.lang.String" column="GEOMETRY" length="4000"/>
                <property name="availableMass"
                          column="AVAILABLE_MASS">
                    <meta attribute="unitType">mass</meta>
                    <type name="quantity">
                        <param name="unitType">mass</param>
                    </type>
                </property>
                <property name="availableVolume"
                          column="AVAILABLE_VOLUME">
                    <meta attribute="unitType">volume</meta>
                    <type name="quantity">
                        <param name="unitType">volume</param>
                    </type>
                </property>
                <property name="comments" column="COMMENTS" length="65536"/>
            </composite-element>
        </set>

        <set name="planDumpBlends" table="PROD_PLAN_DUMP_BLEND" cascade="all" fetch="select" sort="natural">
            <key column="PLAN_OID" on-delete="cascade"/>
            <one-to-many class="minestar.planmanagement.domain.v2.ProdPlanDumpBlend"/>
        </set>

        <set name="dumpCrushers" table="PROD_PLAN_DUMP_CRUSHER" cascade="all" fetch="select" sort="natural">
            <meta attribute="description">Store Plan Dump Crusher details</meta>
            <meta attribute="collection-primary-key">
                columns=PLAN_OID,REFERENCE_ID
            </meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanDumpCrusher">
                <property name="referenceId" type="java.lang.String" column="REFERENCE_ID" not-null="true"/>
                <many-to-one name="ref"
                             column="CRUSHER_OID"
                             not-found="ignore"
                             class="minestar.pitlink.domain.machine.MachineReference">
                    <meta attribute="alias">crusher</meta>
                </many-to-one>
                <property name="targetMass" column="TARGET_MASS">
                    <meta attribute="unitType">mass</meta>
                    <meta attribute="description">Target Mass</meta>
                    <type name="quantity">
                        <param name="unitType">mass</param>
                        <param name="nullable">true</param>
                    </type>
                </property>
                <property name="targetVolume" column="TARGET_VOLUME">
                    <meta attribute="unitType">volume</meta>
                    <meta attribute="description">Target Volume</meta>
                    <type name="quantity">
                        <param name="unitType">volume</param>
                        <param name="nullable">true</param>
                    </type>
                </property>
                <property name="comments" column="COMMENTS" length="65536"/>
            </composite-element>
        </set>

        <set name="dumpStockpiles" table="PROD_PLAN_DUMP_STOCKPILE" cascade="all" fetch="select" sort="natural">
            <meta attribute="description">Store Plan Dump Stockpile details</meta>
            <meta attribute="collection-primary-key">
                columns=PLAN_OID,REFERENCE_ID
            </meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanDumpStockpile">
                <property name="referenceId" type="java.lang.String" column="REFERENCE_ID" not-null="true"/>
                <many-to-one name="ref"
                             column="STOCKPILE_OID"
                             not-found="ignore"
                             class="minestar.mine.domain.material.GradeBlockReference">
                    <meta attribute="alias">stockpile</meta>
                </many-to-one>
                <property name="targetMass" column="TARGET_MASS">
                    <meta attribute="unitType">mass</meta>
                    <meta attribute="description">Target Mass</meta>
                    <type name="quantity">
                        <param name="unitType">mass</param>
                        <param name="nullable">true</param>
                    </type>
                </property>
                <property name="targetVolume" column="TARGET_VOLUME">
                    <meta attribute="unitType">volume</meta>
                    <meta attribute="description">Target Volume</meta>
                    <type name="quantity">
                        <param name="unitType">volume</param>
                        <param name="nullable">true</param>
                    </type>
                </property>
                <property name="geometry" type="java.lang.String" column="GEOMETRY" length="4000"/>
                <property name="comments" column="COMMENTS" length="65536"/>
            </composite-element>
        </set>

        <map name="comments" table="PROD_PLAN_COMMENT" fetch="select">
            <meta attribute="key-manyToOne">minestar.planmanagement.domain.v2.ProdPlanV2</meta>
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <index column="COMMENT_TYPE" type="minestar.planmanagement.domain.v2.ProdPlanCommentType$UserType"/>
            <element column="COMMENTS" type="string" length="65536" not-null="true"/>
        </map>
        
        <bag name="planEndorsements" table="PROD_PLAN_ENDORSEMENT" cascade="all" fetch="select" order-by="CREATED_DATE_UTC">
            <key column="PLAN_OID" not-null="true" on-delete="cascade"/>
            <composite-element class="minestar.planmanagement.domain.v2.ProdPlanEndorsement">
                <many-to-one name="userRef"
                             class="minestar.platform.domain.user.UserReference"
                             column="USER_OID"
                             not-null="true">
                    <meta attribute="description">
                        A reference to the user (MSMODEL.USER) who endorsed a plan.
                    </meta>
                </many-to-one>

                <property name="status" column="STATUS" length="254" not-null="true">
                    <meta attribute="description">Status</meta>
                    <type name="org.hibernate.type.EnumType">
                        <param name="enumClass">minestar.planmanagement.domain.v2.ProdPlanEndorsement$Status</param>
                        <param name="type">12</param>
                        <param name="useNamed">true</param>
                    </type>
                </property>

                <property name="createdDate" type="TimestampType" column="CREATED_DATE_UTC" not-null="true">
                    <meta attribute="utc-description">Created utc timestamp</meta>
                    <meta attribute="description">The timestamp of created</meta>
                    <meta attribute="view-localtime">true</meta>
                </property>

                <property name="userNotes" type="string" column="USER_NOTES" length="65536"/>

            </composite-element>
        </bag>

    </class>

    <!-- A lightweight reference to a Plan -->
    <class name="minestar.planmanagement.domain.v2.ProdPlanReferenceV2" table="PROD_PLAN" mutable="false" lazy="false">

        <meta attribute="alias" inherit="false">PROD_PLAN_REFERENCE</meta>
        <meta attribute="view-create-order">1</meta>

        <id name="OID" type="long" column="OID"/>
    </class>    

</hibernate-mapping>
