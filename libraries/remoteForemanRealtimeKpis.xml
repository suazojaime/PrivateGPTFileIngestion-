<?xml version="1.0" encoding="UTF-8"?>
<kpiSummaries>
    <!-- Needs standardRealtimeKpis and dashboardRealtimeKpis -->

    <!-- Use the secondaryMachine of truck cycles as loader cycles are very inaccurate -->
    <realtimeKpi if="truck" name="hourlyTonsMinedByLoadingTool" fact="main" persisted="true"
                 desc="Tons mined of material in each hour of shift by loading tool" publishAllChanges="true">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>

        <dimensions>
            <dimensionRef name="secondaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <dimensionRef name="loaderMaterial" dimension="material">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
            <detailRef name="hourInShift"/>
        </dimensions>
        <measures>
            <measureRef name="payloadReportingCC"/>
        </measures>
        <kpis>
            <kpi name="primeTonsMined" if="not main.rehandle" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="rehandleTonsMined" if="main.rehandle" stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
            <kpi name="tonsMined"  stat="sum" type="shift" unitType="mass" active="true">
                <parameter name="measure" valueRef="payloadReportingCC"/>
            </kpi>
        </kpis>
    </realtimeKpi>

    <realtimeKpi name="machineAvailabilityByCategory" fact="main" persisted="true"
                 desc="Availability of machines by category, class and name">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="categoryName"/>
                <dimensionAttributeRef name="className"/>
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="availableTime"/>
            <measureRef name="totalTime"/>
            <measureRef name="operHoursSeconds"/>
        </measures>
        <kpis>
            <kpi name="_availableTimeForShift" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="availableTime"/>
            </kpi>
            <kpi name="_totalTimeForShift" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="totalTime"/>
            </kpi>
            <kpi name="_operHoursSecondsForShift" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="operHoursSeconds"/>
            </kpi>

            <rolledupKpi name="_classAvailableTimeForShift" rollupOf="_availableTimeForShift"/>
            <rolledupKpi name="_classTotalTimeForShift" rollupOf="_totalTimeForShift"/>
            <rolledupKpi name="_classOperHoursSecondsForShift" rollupOf="_operHoursSecondsForShift"/>

            <rolledupKpi name="_categoryAvailableTimeForShift" rollupOf="_classAvailableTimeForShift"/>
            <rolledupKpi name="_categoryTotalTimeForShift" rollupOf="_classTotalTimeForShift"/>
            <rolledupKpi name="_categoryOperHoursSecondsForShift" rollupOf="_classOperHoursSecondsForShift"/>

            <rolledupKpi name="_totalAvailableTimeForShift" rollupOf="_categoryAvailableTimeForShift"/>
            <rolledupKpi name="_totalTotalTimeForShift" rollupOf="_categoryTotalTimeForShift"/>
            <rolledupKpi name="_totalOperHoursSecondsForShift" rollupOf="_categoryOperHoursSecondsForShift"/>
        </kpis>

        <calculatedMembers>
            <calculatedMember name="availability"
                              if="kpi._totalTimeForShift &gt; 0"
                              expr="kpi._availableTimeForShift * 100 / kpi._totalTimeForShift"
                              unitType="ratio"/>
            <calculatedMember name="useOfAvailability"
                              if="kpi._availableTimeForShift &gt; 0"
                              expr="kpi._operHoursSecondsForShift * 100 / kpi._availableTimeForShift"
                              unitType="ratio"/>

            <calculatedMember name="classAvailability"
                              if="kpi._classTotalTimeForShift &gt; 0"
                              expr="kpi._classAvailableTimeForShift * 100 / kpi._classTotalTimeForShift"
                              unitType="ratio"/>
            <calculatedMember name="classUseOfAvailability"
                              if="kpi._classAvailableTimeForShift &gt; 0"
                              expr="kpi._classOperHoursSecondsForShift * 100 / kpi._classAvailableTimeForShift"
                              unitType="ratio"/>

            <calculatedMember name="categoryAvailability"
                              if="kpi._categoryTotalTimeForShift &gt; 0"
                              expr="kpi._categoryAvailableTimeForShift * 100 / kpi._categoryTotalTimeForShift"
                              unitType="ratio"/>
            <calculatedMember name="categoryUseOfAvailability"
                              if="kpi._categoryAvailableTimeForShift &gt; 0"
                              expr="kpi._categoryOperHoursSecondsForShift * 100 / kpi._categoryAvailableTimeForShift"
                              unitType="ratio"/>

            <calculatedMember name="totalAvailability"
                              if="kpi._totalTotalTimeForShift &gt; 0"
                              expr="kpi._totalAvailableTimeForShift * 100 / kpi._totalTotalTimeForShift"
                              unitType="ratio"/>
            <calculatedMember name="totalUseOfAvailability"
                              if="kpi._totalAvailableTimeForShift &gt; 0"
                              expr="kpi._totalOperHoursSecondsForShift * 100 / kpi._totalAvailableTimeForShift"
                              unitType="ratio"/>
        </calculatedMembers>

    </realtimeKpi>

    <realtimeKpi if="loader" name="loadingToolActivitiesByLoadingTool" fact="main" machineType="loadingTool" persisted="true" desc="LoadingTool Activity Kpis by LoadingTools">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="primaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="loadingDuration"/>
            <measureRef name="hangTimeDurCompleted"/>
            <measureRef name="waitForSpotDuration"/>
            <measureRef name="delayTime"/>
            <measureRef name="completedCycleCount"/>
        </measures>
        <kpis>
            <kpi name="loadingTimeByLoadingTool" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="rollingAverageLoadingTimeByLoadingTool" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="loadingDuration"/>
            </kpi>
            <kpi name="hangTimeByLoadingTool" if="main.completedCycleCount == 1" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="hangTimeDurCompleted"/>
            </kpi>
            <kpi name="rollingAverageHangTimeByLoadingTool" if="main.completedCycleCount == 1" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="hangTimeDurCompleted"/>
            </kpi>
            <kpi name="waitForSpotTimeByLoadingTool" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="waitForSpotDuration"/>
            </kpi>
            <kpi name="rollingAverageWaitForSpotTimeByLoadingTool" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="waitForSpotDuration"/>
            </kpi>
            <kpi name="onDelayTimeByLoadingTool" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="delayTime"/>
            </kpi>
            <kpi name="rollingAverageOnDelayTimeByLoadingTool" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="delayTime"/>
            </kpi>
            <kpi name="_completedCycleCountByLoadingTool" stat="sum" type="shift" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="loadingTime" rollupOf="loadingTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageLoadingTime" rollupOf="rollingAverageLoadingTimeByLoadingTool" />
            <rolledupKpi name="hangTime" rollupOf="hangTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageHangTime" rollupOf="rollingAverageHangTimeByLoadingTool" />
            <rolledupKpi name="waitForSpotTime" rollupOf="waitForSpotTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageWaitForSpotTime" rollupOf="rollingAverageWaitForSpotTimeByLoadingTool" />
            <rolledupKpi name="onDelayTime" rollupOf="onDelayTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageOnDelayTime" rollupOf="rollingAverageOnDelayTimeByLoadingTool" />
            <rolledupKpi name="_completedCycleCount" rollupOf="_completedCycleCountByLoadingTool" />
        </kpis>
        <calculatedMembers>
            <calculatedMember name="averageLoadingTimeByLoadingTool"
                              if="kpi._completedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.loadingTimeByLoadingTool / kpi._completedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageHangTimeByLoadingTool"
                              if="kpi._completedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.hangTimeByLoadingTool / kpi._completedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageWaitForSpotTimeByLoadingTool"
                              if="kpi._completedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.waitForSpotTimeByLoadingTool / kpi._completedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageOnDelayTimeByLoadingTool"
                              if="kpi._completedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.onDelayTimeByLoadingTool / kpi._completedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageLoadingTime"
                              if="kpi._completedCycleCount &gt; 0"
                              expr="kpi.loadingTime / kpi._completedCycleCount"
                              unitType="duration"/>
            <calculatedMember name="averageHangTime"
                              if="kpi._completedCycleCount &gt; 0"
                              expr="kpi.hangTime / kpi._completedCycleCount"
                              unitType="duration"/>
            <calculatedMember name="averageWaitForSpotTime"
                              if="kpi._completedCycleCount &gt; 0"
                              expr="kpi.waitForSpotTime / kpi._completedCycleCount"
                              unitType="duration"/>
            <calculatedMember name="averageOnDelayTime"
                              if="kpi._completedCycleCount &gt; 0"
                              expr="kpi.onDelayTime / kpi._completedCycleCount"
                              unitType="duration"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="truckActivitiesByLoadingTool" fact="main" machineType="loadingTool" persisted="true" desc="Truck Activity Kpis by LoadingTools">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="secondaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="queuingAtSourceDuration"/>
            <measureRef name="spottingAtSourceDuration"/>
            <measureRef name="completedCycleCount"/>
        </measures>
        <kpis>
            <kpi name="truckQueuingTimeByLoadingTool" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="queuingAtSourceDuration"/>
            </kpi>
            <kpi name="rollingAverageQueuingTimeByLoadingTool" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="queuingAtSourceDuration"/>
            </kpi>
            <kpi name="truckSpottingTimeByLoadingTool" stat="sum" type="shift" unitType="duration">
                <parameter name="measure" valueRef="spottingAtSourceDuration"/>
            </kpi>
            <kpi name="rollingAverageSpottingTimeByLoadingTool" stat="weighted" unitType="duration">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="minNumSamples" value="1" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="spottingAtSourceDuration"/>
            </kpi>
            <kpi name="_truckCompletedCycleCountByLoadingTool" stat="sum" type="shift" unitType="unitless">
                <parameter name="measure" valueRef="completedCycleCount"/>
            </kpi>
            <rolledupKpi name="truckQueuingTime" rollupOf="truckQueuingTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageQueuingTime" rollupOf="rollingAverageQueuingTimeByLoadingTool" />
            <rolledupKpi name="truckSpottingTime" rollupOf="truckSpottingTimeByLoadingTool" />
            <rolledupKpi name="rollingAverageSpottingTime" rollupOf="rollingAverageSpottingTimeByLoadingTool" />
            <rolledupKpi name="_truckCompletedCycleCount" rollupOf="_truckCompletedCycleCountByLoadingTool" />
        </kpis>
        <calculatedMembers>
            <calculatedMember name="averageTruckQueuingTimeByLoadingTool"
                              if="kpi._truckCompletedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.truckQueuingTimeByLoadingTool / kpi._truckCompletedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageTruckSpottingTimeByLoadingTool"
                              if="kpi._truckCompletedCycleCountByLoadingTool &gt; 0"
                              expr="kpi.truckSpottingTimeByLoadingTool / kpi._truckCompletedCycleCountByLoadingTool"
                              unitType="duration"/>
            <calculatedMember name="averageTruckQueuingTime"
                              if="kpi._truckCompletedCycleCount &gt; 0"
                              expr="kpi.truckQueuingTime / kpi._truckCompletedCycleCount"
                              unitType="duration"/>
            <calculatedMember name="averageTruckSpottingTime"
                              if="kpi._truckCompletedCycleCount &gt; 0"
                              expr="kpi.truckSpottingTime / kpi._truckCompletedCycleCount"
                              unitType="duration"/>
        </calculatedMembers>
    </realtimeKpi>

    <realtimeKpi if="truck" name="tonsMinedByLoadingTool" fact="main" machineType="loadingTool" persisted="true"
                 desc="Tons loaded by each loadingTool calculated from LoaderCycles">
        <timestamp>
            <detailRef name="endTime"/>
        </timestamp>
        <dimensions>
            <dimensionRef name="secondaryMachine" dimension="machine">
                <dimensionAttributeRef name="name"/>
            </dimensionRef>
        </dimensions>
        <measures>
            <measureRef name="payloadReporting"/>
        </measures>
        <kpis>
            <kpi name="averageTonsMinedByLoadingTool" stat="weighted" unitType="mass">
                <parameter name="weights" value="20,20,20,20,20" unit="count" unitType="unitless"/>
                <parameter name="measure" valueRef="payloadReporting"/>
            </kpi>
        </kpis>
    </realtimeKpi>

</kpiSummaries>
