<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd http://www.liquibase.org/xml/ns/dbchangelog-ext /dbchangelog-ext-3.1.xsd">
    <changeSet id="98dc916d-960f-4455-bacc-78345764264d" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CREATED_DATE to table LANE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE"/>
            <not>
                <columnExists tableName="LANE" columnName="CREATED_DATE"/>
            </not>
        </preConditions>
        <comment>{JIRA}: AddColumn LANE.CREATED_DATE</comment>
        <addColumn tableName="LANE">
            <column name="CREATED_DATE" type="DATETIME2" defaultValueComputed="current_timestamp" remarks="The lane creation timestamp">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="13e41be7-4da2-4798-98df-830dd77753c8" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for LAST_UPDATED_DATE to table LANE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE"/>
            <not>
                <columnExists tableName="LANE" columnName="LAST_UPDATED_DATE"/>
            </not>
        </preConditions>
        <comment>{JIRA}: AddColumn LANE.LAST_UPDATED_DATE</comment>
        <addColumn tableName="LANE">
            <column name="LAST_UPDATED_DATE" type="DATETIME2" defaultValueComputed="current_timestamp" remarks="The lane updated timestamp">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Due to SQLServer not playing nicely with default values in database columns when being dropped we need the following changesets -->
    <changeSet id="837d8d0f-a981-47df-9ff4-3ed9630395aa" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for CREATED_DATE of table LANE as column does not exist." onFail="MARK_RAN">
            <ext:columnHasDefaultValue tableName="LANE" columnName="CREATED_DATE"/>
        </preConditions>
        <dropDefaultValue columnName="CREATED_DATE" tableName="LANE"/>
        <rollback>
            <addDefaultValue tableName="LANE" columnDataType="DATETIME2" columnName="CREATED_DATE" defaultValueComputed="current_timestamp"/>
        </rollback>
    </changeSet>

    <changeSet id="568ca8ae-2df6-4ad2-9f6d-a453b91e1cdf" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for LAST_UPDATED_DATE of table LANE as column does not exist." onFail="MARK_RAN">
            <ext:columnHasDefaultValue tableName="LANE" columnName="LAST_UPDATED_DATE"/>
        </preConditions>
        <dropDefaultValue columnName="LAST_UPDATED_DATE" tableName="LANE"/>
        <rollback>
            <addDefaultValue tableName="LANE" columnDataType="DATETIME2" columnName="LAST_UPDATED_DATE" defaultValueComputed="current_timestamp"/>
        </rollback>
    </changeSet>

    <!-- Due to hibernate mapping file breaking makeDatastores due to the setting of default timestamps the following has been added as a fix. -->
    <changeSet id="730c8456-fd3e-4f12-929f-fa080be8bd6f" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for CREATED_DATE of table LANE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="LANE" columnName="CREATED_DATE"/>
        </preConditions>
        <comment>{JIRA}: DropColumn LANE.CREATED_DATE</comment>
        <dropColumn columnName="CREATED_DATE" tableName="LANE"/>
        <rollback>
            <addColumn tableName="LANE">
                <column name="CREATED_DATE" type="DATETIME2" defaultValueComputed="current_timestamp" remarks="The lane creation timestamp">
                    <constraints nullable="true"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="cba52ca5-9fcd-488a-a335-707c3d05a753" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored DropColumn for LAST_UPDATED_DATE of table LANE as column does not exist." onFail="MARK_RAN">
            <columnExists tableName="LANE" columnName="LAST_UPDATED_DATE"/>
        </preConditions>
        <comment>{JIRA}: DropColumn LANE.CREATED_DATE</comment>
        <dropColumn columnName="LAST_UPDATED_DATE" tableName="LANE"/>
        <rollback>
            <addColumn tableName="LANE">
                <column name="LAST_UPDATED_DATE" type="DATETIME2" defaultValueComputed="current_timestamp" remarks="The lane updated timestamp">
                    <constraints nullable="true"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>

    <changeSet id="08351a8c-2a35-462b-83e6-37b4723a77a6" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for CREATED_DATE_UTC to table LANE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE"/>
            <not>
                <columnExists tableName="LANE" columnName="CREATED_DATE_UTC"/>
            </not>
        </preConditions>
        <comment>{JIRA}: AddColumn LANE.CREATED_DATE_UTC</comment>
        <addColumn tableName="LANE">
            <column name="CREATED_DATE_UTC" type="DATETIME2" remarks="The lane creation timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <sql>update LANE set CREATED_DATE_UTC=CURRENT_TIMESTAMP;</sql>
        <rollback>
            <dropColumn tableName="LANE" columnName="CREATED_DATE_UTC"/>
        </rollback>
    </changeSet>

    <changeSet id="f1ef5bd4-e839-4d5f-9c1f-dd87552ef40e" author="MineStar" failOnError="false">
        <preConditions onFailMessage="Ignored AddColumn for LAST_UPDATED_DATE_UTC to table LANE as table does not exist or column already exists." onFail="MARK_RAN">
            <tableExists tableName="LANE"/>
            <not>
                <columnExists tableName="LANE" columnName="LAST_UPDATED_DATE_UTC"/>
            </not>
        </preConditions>
        <comment>{JIRA}: AddColumn LANE.LAST_UPDATED_DATE_UTC</comment>
        <addColumn tableName="LANE">
            <column name="LAST_UPDATED_DATE_UTC" type="DATETIME2" remarks="The lane updated timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <sql>update LANE set LAST_UPDATED_DATE_UTC=CURRENT_TIMESTAMP;</sql>
        <rollback>
            <dropColumn tableName="LANE" columnName="LAST_UPDATED_DATE_UTC"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
